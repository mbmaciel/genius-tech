<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Genius Tecnologic</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link href="/assets/technical-analysis.css" rel="stylesheet">
  <!-- Incluir o script de utilitários de autenticação -->
  <script src="/js/auth-utils.js"></script>
  <script src="/js/rate-limiter.js"></script>
  <style>
    :root {
      --primary-color: #00e5b3;
      --primary-dark: #00c49c;
      --secondary-color: #007eff;
      --bg-color: #0e1a33;
      --bg-darker: #091327;
      --bg-lighter: #1a2845;
      --text-color: #ffffff;
      --border-color: rgba(255,255,255,0.1);
      --panel-bg: rgba(255,255,255,0.03);
      --up-color: #00e5b3;
      --down-color: #ff3349;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 70px;
      height: 100vh;
      background-color: var(--bg-darker);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 0;
      transition: width 0.3s;
      overflow: hidden;
      position: relative;
      z-index: 1000;
    }

    .sidebar .logo {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--primary-color);
      color: var(--bg-darker);
      border-radius: 10px;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 30px;
    }
    
    .robo-button {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 150px;
      height: 50px;
      background-color: var(--primary-color);
      color: var(--bg-darker);
      border: none;
      border-radius: 25px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0, 229, 179, 0.4);
      transition: all 0.2s;
      z-index: 1000;
    }
    
    .robo-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 229, 179, 0.5);
    }
    
    .robo-button:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(0, 229, 179, 0.3);
    }

    .nav-item {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 10px 15px;
      color: var(--text-color);
      opacity: 0.7;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 5px;
      position: relative;
    }

    .nav-item:hover {
      opacity: 1;
      background-color: var(--bg-lighter);
    }

    .nav-item.active {
      opacity: 1;
      background-color: var(--bg-lighter);
      border-left: 3px solid var(--primary-color);
    }

    .nav-item i {
      font-size: 1.3rem;
      min-width: 30px;
      text-align: center;
    }

    .nav-item span {
      margin-left: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      display: none;
    }

    .sidebar:hover {
      width: 220px;
    }

    .sidebar:hover .nav-item span {
      display: block;
    }

    .user-profile {
      margin-top: auto;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .sidebar:hover .user-profile {
      width: calc(100% - 30px);
      justify-content: flex-start;
      padding-left: 15px;
      border-radius: 10px;
    }

    .user-profile .username {
      display: none;
      margin-left: 10px;
      font-size: 0.85rem;
    }

    .sidebar:hover .user-profile .username {
      display: block;
    }

    /* Main content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .header {
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--bg-darker);
      position: relative;
      z-index: 20;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .header-actions {
      display: flex;
      align-items: center;
    }

    .header-actions .btn {
      margin-left: 15px;
    }

    /* Content area */
    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      grid-template-rows: auto 1fr;
      gap: 20px;
    }

    /* Cards and widgets */
    .card {
      background-color: var(--bg-darker);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 5;
    }

    .card-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .card-actions {
      display: flex;
      align-items: center;
    }

    .card-content {
      padding: 20px;
      flex: 1;
      overflow: hidden;
    }

    /* Chart container */
    .chart-container {
      width: 100%;
      height: 100%;
      min-height: 300px;
    }

    /* Specific grid positions */
    .status-card {
      grid-column: span 3;
      grid-row: 1;
    }

    .account-card {
      grid-column: span 3;
      grid-row: 1;
    }

    .stats-card {
      grid-column: span 6;
      grid-row: 1;
    }

    .digits-chart-card {
      grid-column: span 6;
      grid-row: 2;
    }

    .trading-chart-card {
      grid-column: span 6;
      grid-row: 2;
    }

    /* Button styles */
    .btn {
      background-color: var(--primary-color);
      color: var(--bg-darker);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s;
    }

    .btn i {
      margin-right: 8px;
    }

    .btn:hover {
      background-color: var(--primary-dark);
    }

    .btn.btn-secondary {
      background-color: var(--secondary-color);
    }

    .btn.btn-secondary:hover {
      background-color: #0066cc;
    }

    .btn.btn-outline {
      background-color: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn.btn-outline:hover {
      background-color: var(--primary-color);
      color: var(--bg-darker);
    }

    .btn.btn-danger {
      background-color: var(--down-color);
    }

    .btn.btn-danger:hover {
      background-color: #e62e42;
    }

    /* Connection status styles */
    .connection-status {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--panel-bg);
      position: relative;
      z-index: 15;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .status-connected {
      background-color: var(--primary-color);
    }

    .status-disconnected {
      background-color: var(--down-color);
    }
    
    .status-loading {
      background-color: #ffa100;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }

    /* Account summary bar styles */
    .account-summary-bar {
      background-color: var(--bg-lighter);
      border-bottom: 1px solid var(--border-color);
      padding: 10px 20px;
      margin-bottom: 20px;
      position: relative;
      z-index: 10;
    }

    .account-summary-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .account-info-item {
      display: flex;
      flex-direction: column;
      margin-right: 20px;
      min-width: 120px;
    }

    .account-label {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 3px;
    }

    .account-value {
      font-size: 1rem;
      font-weight: 500;
    }

    .account-selector-container {
      display: flex;
      align-items: center;
      margin-left: auto;
    }

    .account-selector-container label {
      margin-right: 10px;
      font-size: 0.9rem;
    }

    .account-selector {
      background-color: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      min-width: 200px;
      outline: none;
    }

    .account-selector:focus {
      border-color: var(--primary-color);
    }

    /* Account info styles */
    .account-info {
      display: flex;
      flex-direction: column;
      padding: 15px;
    }

    .account-detail {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .account-detail:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }

    .account-detail .label {
      color: rgba(255,255,255,0.7);
      font-size: 0.9rem;
    }

    .account-detail .value {
      font-weight: 500;
      text-align: right;
    }
    
    /* Contas */
    .accounts-list-container {
      margin-top: 15px;
      border-top: 1px solid var(--border-color);
      padding-top: 15px;
    }
    
    .accounts-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 0.9rem;
      color: var(--text-color);
    }
    
    .accounts-count {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .accounts-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .account-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      border-radius: 4px;
      background-color: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .account-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .account-item.active,
    .account-item.selected {
      background-color: rgba(0, 229, 179, 0.1);
      border-left: 3px solid var(--primary-color);
    }
    
    .account-item-info {
      display: flex;
      flex-direction: column;
    }
    
    .account-item-id {
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    .account-item-type {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .account-item-currency {
      font-size: 0.8rem;
      color: var(--primary-color);
      font-weight: 500;
    }
    
    .refresh-btn {
      background: transparent;
      border: none;
      color: var(--text-color);
      opacity: 0.5;
      cursor: pointer;
      margin-left: 5px;
      padding: 2px;
    }
    
    /* Animação para atualização de saldo */
    .balance-updated {
      animation: balance-flash 1.5s ease;
    }
    
    @keyframes balance-flash {
      0% { color: #fff; }
      25% { color: var(--primary-color); }
      50% { color: #fff; }
      75% { color: var(--primary-color); }
      100% { color: #fff; }
    }
    
    /* Painel de conta ativa no cabeçalho */
    .active-account-panel {
      display: none;
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 12px 16px;
      margin-right: 20px;
      flex-direction: column;
      min-width: 220px;
    }
    
    .account-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .account-panel-title {
      font-size: 0.8rem;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .account-panel-content {
      display: flex;
      flex-direction: column;
    }
    
    .account-panel-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .account-id-section {
      display: flex;
      align-items: center;
    }
    
    .account-id-label {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      margin-right: 4px;
    }
    
    .account-id-value {
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .account-type-section {
      display: flex;
      align-items: center;
    }
    
    .account-type-label {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      margin-right: 4px;
    }
    
    .account-badge {
      display: flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .account-badge.demo {
      background-color: rgba(255, 223, 0, 0.2);
      color: #ffdf00;
    }
    
    .account-badge.real {
      background-color: rgba(0, 229, 179, 0.2);
      color: var(--primary-color);
    }
    
    .account-badge i {
      margin-right: 4px;
      font-size: 0.7rem;
    }
    
    .account-balance-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .account-balance-label {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .account-balance-value {
      font-weight: 700;
      font-size: 1rem;
      color: var(--primary-color);
    }
    
    .refresh-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: var(--text-color);
      opacity: 0.5;
      cursor: pointer;
      margin-left: 5px;
      padding: 6px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .refresh-btn.updating {
      animation: spin 1s linear infinite;
      opacity: 0.8;
      color: var(--primary-color);
    }
    
    .refresh-hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .loading {
      display: inline-block;
      opacity: 0.7;
      font-style: italic;
      font-size: 0.9em;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .refresh-btn:hover {
      opacity: 1;
      color: var(--primary-color);
    }

    /* Stats grid for digits */
    .digit-stats {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 15px;
      height: 100%;
    }

    .digit-stats .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: var(--panel-bg);
      border-radius: 6px;
      padding: 15px 10px;
      transition: all 0.3s;
    }

    .digit-stats .stat-item:hover {
      background-color: var(--bg-lighter);
    }

    .digit-stats .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .digit-stats .stat-label {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
    }

    .digit-stats .stat-progress {
      width: 100%;
      height: 5px;
      background-color: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin-top: 10px;
      overflow: hidden;
    }

    .digit-stats .progress-bar {
      height: 100%;
      background-color: var(--primary-color);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* Bars chart */
    .bars-chart {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .bars-container {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 80%;
      padding: 20px 0;
    }

    .bar-item {
      width: 8%;
      position: relative;
      transition: all 0.3s;
    }

    .bar-column {
      background-color: var(--primary-color);
      width: 100%;
      border-radius: 3px 3px 0 0;
      position: relative;
      transition: height 0.5s ease;
    }

    .bar-percentage {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      font-weight: 600;
    }

    .bar-digit {
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1rem;
      font-weight: 600;
    }

    .bars-legend {
      display: flex;
      justify-content: space-around;
      margin-top: 30px;
      padding: 10px 0;
      border-top: 1px solid var(--border-color);
    }

    .bars-legend-item {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
    }

    .digit-sequence {
      display: flex;
      justify-content: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .digit-sequence-item {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--panel-bg);
      border-radius: 4px;
      margin: 0 3px 6px;
      font-weight: 600;
      font-size: 0.9rem;
    }

    /* Trading chart */
    .trading-chart {
      width: 100%;
      height: 100%;
      background-color: var(--panel-bg);
      border-radius: 6px;
      position: relative;
    }

    .chart-toolbar {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.9rem;
    }

    .chart-toolbar-item {
      margin-right: 15px;
      opacity: 0.7;
      cursor: pointer;
      transition: all 0.3s;
    }

    .chart-toolbar-item:hover,
    .chart-toolbar-item.active {
      opacity: 1;
    }

    .chart-toolbar-item.active {
      color: var(--primary-color);
    }

    .chart-toolbar-divider {
      width: 1px;
      height: 20px;
      background-color: var(--border-color);
      margin: 0 10px;
    }

    /* Stats indicators */
    .stat-indicators {
      display: flex;
      flex-wrap: wrap;
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .stat-indicator {
      margin-right: 15px;
      padding: 5px 10px;
      background-color: var(--panel-bg);
      border-radius: 4px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
    }

    .indicator-label {
      margin-right: 5px;
      color: rgba(255,255,255,0.7);
    }

    .indicator-value.up {
      color: var(--up-color);
    }

    .indicator-value.down {
      color: var(--down-color);
    }

    /* Conexão page styles */
    .connection-page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }
    
    .connection-container {
      width: 80%;
      max-width: 900px;
      height: 80%;
      max-height: 700px;
      background-color: var(--bg-darker);
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .connection-content {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px; /* Adicionar um pequeno padding para evitar colisão com a barra de rolagem */
    }
    
    .connection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--bg-darker);
    }
    
    .connection-header h2 {
      margin: 0;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      color: var(--primary-color);
    }
    
    .connection-header h2 i {
      margin-right: 10px;
    }
    
    .btn-close {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-close:hover {
      color: var(--primary-color);
    }
    
    .connection-section {
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .connection-section h3 {
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.9);
    }
    
    .connection-status-info {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .connection-status-indicator {
      display: flex;
      align-items: center;
      margin-right: 20px;
    }
    
    .connection-status-message {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .connection-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .account-details {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .account-detail-row {
      display: flex;
      align-items: center;
    }
    
    .detail-label {
      width: 120px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }
    
    .detail-value {
      font-weight: 500;
    }
    
    .conn-accounts-info {
      margin-top: 15px;
      margin-bottom: 15px;
    }
    
    .conn-accounts-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
    
    .conn-accounts-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 5px;
      background-color: rgba(255, 255, 255, 0.03);
      border-radius: 5px;
    }

    /* Add FontAwesome for icons */
    @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css');

    /* Media queries */
    @media (max-width: 1200px) {
      .content {
        grid-template-columns: repeat(6, 1fr);
        grid-template-rows: auto auto 1fr;
      }

      .status-card {
        grid-column: span 2;
        grid-row: 1;
      }

      .account-card {
        grid-column: span 2;
        grid-row: 1;
      }

      .stats-card {
        grid-column: span 2;
        grid-row: 1;
      }

      .digits-chart-card {
        grid-column: span 6;
        grid-row: 2;
      }

      .trading-chart-card {
        grid-column: span 6;
        grid-row: 3;
      }
    }

    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto auto;
        padding: 10px;
        gap: 15px;
      }

      .status-card,
      .account-card,
      .stats-card,
      .digits-chart-card,
      .trading-chart-card {
        grid-column: 1;
      }

      .status-card {
        grid-row: 1;
      }

      .account-card {
        grid-row: 2;
      }

      .stats-card {
        grid-row: 3;
      }

      .digits-chart-card {
        grid-row: 4;
      }

      .trading-chart-card {
        grid-row: 5;
      }

      .sidebar {
        width: 0;
        position: fixed;
        z-index: 100;
      }

      .sidebar.active {
        width: 220px;
      }

      .header {
        padding: 0 15px;
      }

      .page-title {
        font-size: 1.2rem;
      }
    }
    
    /* Estilos para o seletor de contas */
    .account-selector {
      position: relative;
      display: none; /* Alterado para none inicialmente, será mostrado via JavaScript */
      margin-right: 15px;
      border: 1px solid rgba(0, 229, 179, 0.3);
    }
    
    .account-selector-header {
      display: flex;
      align-items: center;
      background-color: var(--bg-dark);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 200px;
    }
    
    .account-selector-header:hover {
      background-color: var(--bg-darker);
      border-color: var(--primary-color);
    }
    
    .account-selector-info {
      display: flex;
      flex-direction: column;
      margin-right: 10px;
    }
    
    .account-selector-balance {
      margin-left: auto;
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .account-selector-icon {
      margin-left: 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }
    
    .accounts-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: var(--bg-darker);
      border: 1px solid var(--border-color);
      border-top: none;
      border-radius: 0 0 6px 6px;
      z-index: 100;
      display: none;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .account-selector.open .accounts-dropdown {
      display: block;
    }
    
    .account-selector.open .account-selector-header {
      border-radius: 6px 6px 0 0;
      border-bottom-color: transparent;
    }
    
    .account-item {
      display: flex;
      align-items: center;
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: background-color 0.2s ease;
    }
    
    .account-item:last-child {
      border-bottom: none;
    }
    
    .account-item:hover {
      background-color: rgba(0,229,179,0.1);
    }
    
    .account-item.selected {
      background-color: rgba(0,229,179,0.15);
    }
    
    .account-item-info {
      display: flex;
      flex-direction: column;
    }
    
    .account-item-id {
      font-weight: 500;
    }
    
    .account-item-details {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
    }
    
    .account-type-badge {
      display: inline-block;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 3px;
      margin-left: 8px;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .account-type-demo {
      background-color: rgba(255, 163, 25, 0.15);
      color: #ffa319;
    }
    
    .account-type-real {
      background-color: rgba(0, 200, 5, 0.15);
      color: #00c805;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo">GT</div>
    <div class="nav-item active">
      <i class="fas fa-chart-line"></i>
      <span>Dashboard</span>
    </div>
    <div class="nav-item" onclick="window.open('/robo-operacoes', '_blank')">
      <i class="fas fa-robot"></i>
      <span>Robô de Operações</span>
    </div>
    <div class="nav-item">
      <i class="fas fa-chart-bar"></i>
      <span>Estatísticas</span>
    </div>
    <div class="nav-item">
      <i class="fas fa-cog"></i>
      <span>Configurações</span>
    </div>
  </div>
  
  <!-- Botão fixo para Robô de Operações -->
  <a href="/robo-operacoes" target="_blank" class="robo-button">
    <i class="fas fa-robot" style="margin-right: 8px;"></i> Robô de Operações
  </a>
    
    <div class="nav-item" id="connection-nav-item" style="cursor: pointer;" onclick="openConnectionPage()">
      <i class="fas fa-plug"></i>
      <span>Conexão</span>
    </div>

    <script>
      function openConnectionPage() {
        console.log('Clicou no botão de conexão');
        const connectionPage = document.getElementById('connection-page');
        if (connectionPage) {
          connectionPage.style.display = 'flex';
          console.log('Abrindo página de conexão');
        } else {
          console.error('Elemento connection-page não encontrado');
        }
      }
    </script>
    
    <div class="user-profile">
      <span>A</span>
      <div class="username">Admin</div>
    </div>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <!-- Header -->
    <div class="header">
      <h1 class="page-title">Dashboard</h1>
      
      <!-- Novo componente de informações da conta conectada -->
      <div id="active-account-panel" class="active-account-panel">
        <div class="active-account-type">
          <span id="active-account-type-badge" class="account-badge">
            <i class="fas fa-money-bill-wave"></i>
            <span id="active-account-type-text">Real</span>
          </span>
        </div>
        <div class="active-account-info">
          <div class="active-account-item">
            <span class="active-account-label">ID:</span>
            <span id="active-account-id" class="active-account-value">-</span>
          </div>
          <div class="active-account-item balance">
            <span class="active-account-label">Saldo:</span>
            <span id="active-account-balance" class="active-account-value">-</span>
          </div>
        </div>
        <button id="refresh-account-btn" class="refresh-account-btn" title="Atualizar informações da conta">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      
      <!-- Seletor de contas com layout atualizado -->
      <div class="account-controls-wrapper">
        <div id="account-selector" class="account-selector">
          <div class="account-selector-header" id="account-selector-toggle">
            <span id="account-selector-text">-</span>
            <div class="account-selector-icon">
              <i class="fas fa-chevron-down"></i>
            </div>
          </div>
          <div id="accounts-dropdown" class="accounts-dropdown">
            <!-- Contas serão inseridas aqui via JavaScript -->
          </div>
        </div>
        
        <!-- Tipo de conta (agora ao lado do seletor) -->
        <div class="account-type-container">
          <span id="account-selector-type" class="account-type-badge">-</span>
        </div>
        
        <!-- Saldo (agora ao lado do tipo) -->
        <div class="account-balance-container">
          <span id="account-selector-balance">- -</span>
        </div>
      </div>
      
      <style>
        /* Estilos para o novo layout do seletor de contas */
        .account-controls-wrapper {
          display: flex;
          align-items: center;
          margin-right: 15px;
          background-color: rgba(0, 0, 0, 0.2);
          border-radius: 8px;
          padding: 3px 5px;
          border: 1px solid rgba(0, 229, 179, 0.2);
        }
        
        .account-selector {
          position: relative;
          display: none; /* Será alterado para 'inline-block' via JavaScript */
          margin-right: 5px;
        }
        
        .account-selector-header {
          display: flex;
          align-items: center;
          padding: 6px 10px;
          background-color: rgba(0, 0, 0, 0.3);
          border-radius: 6px;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        .account-selector-header:hover {
          background-color: rgba(0, 0, 0, 0.4);
        }
        
        #account-selector-text {
          font-weight: 600;
          margin-right: 8px;
          font-size: 14px;
        }
        
        .account-type-container {
          margin: 0 10px;
        }
        
        .account-type-badge {
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: 600;
        }
        
        .account-type-badge.account-type-demo {
          background-color: rgba(0, 165, 227, 0.15);
          color: #00a5e3;
          border: 1px solid rgba(0, 165, 227, 0.3);
        }
        
        .account-type-badge.account-type-real {
          background-color: rgba(0, 229, 179, 0.15);
          color: #00e5b3;
          border: 1px solid rgba(0, 229, 179, 0.3);
        }
        
        .account-balance-container {
          margin-left: 5px;
          font-weight: 600;
          color: var(--primary-color);
          padding: 3px 8px;
          background-color: rgba(0, 229, 179, 0.1);
          border-radius: 4px;
        }
      </style>

      <div class="header-actions">
        <button id="connect-btn" class="btn btn-secondary">
          <i class="fas fa-plug"></i> Conectar com Token
        </button>
        <button id="oauth-btn" class="btn">
          <i class="fas fa-external-link-alt"></i> Conectar com Deriv
        </button>
        <button id="disconnect-btn" class="btn btn-outline" style="display: none;">
          <i class="fas fa-power-off"></i> Desconectar
        </button>
        <span id="connection-label" style="display: none; margin-left: 10px; font-size: 0.9rem; padding: 5px 10px; background-color: rgba(0,229,179,0.1); border-radius: 4px; border: 1px solid rgba(0,229,179,0.3); color: var(--primary-color);"></span>
        <span id="connection-multi-label" style="display: none; margin-left: 10px; font-size: 0.9rem; padding: 5px 10px; background-color: rgba(0,165,227,0.1); border-radius: 4px; border: 1px solid rgba(0,165,227,0.3); color: #00a5e3;"></span>
      </div>
    </div>
    
    <style>
      /* Estilos para o painel de conta ativa */
      .active-account-panel {
        display: none; /* Inicialmente oculto, será exibido quando houver uma conta ativa */
        align-items: center;
        background-color: rgba(14, 26, 51, 0.9);
        border: 1px solid rgba(0, 229, 179, 0.3);
        border-radius: 8px;
        padding: 8px 15px;
        margin: 0 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      }
      
      .active-account-type {
        margin-right: 15px;
      }
      
      .account-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 10px;
        background-color: rgba(0, 229, 179, 0.2);
        border: 1px solid rgba(0, 229, 179, 0.4);
        border-radius: 50px;
        color: #00e5b3;
        font-weight: 600;
        font-size: 13px;
      }
      
      .account-badge.demo {
        background-color: rgba(0, 165, 227, 0.2);
        border-color: rgba(0, 165, 227, 0.4);
        color: #00a5e3;
      }
      
      .active-account-info {
        display: flex;
        gap: 20px;
        margin-right: 15px;
      }
      
      .active-account-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .active-account-label {
        font-size: 14px;
        color: rgba(255, 255, 255, 0.6);
        font-weight: 500;
      }
      
      .active-account-value {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
      }
      
      .active-account-item.balance .active-account-value {
        color: #00e5b3;
      }
      
      .refresh-account-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        padding: 8px;
        border-radius: 4px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .refresh-account-btn:hover {
        color: #fff;
        background-color: rgba(255, 255, 255, 0.1);
      }
      
      .refresh-account-btn.updating {
        animation: spin 1.5s linear infinite;
        color: #00e5b3;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      @media (max-width: 768px) {
        .active-account-panel {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
          padding: 10px;
          margin-bottom: 15px;
        }
        
        .active-account-info {
          flex-direction: column;
          gap: 8px;
          margin-right: 0;
          width: 100%;
        }
        
        .refresh-account-btn {
          align-self: flex-end;
          margin-top: -30px;
        }
        
        .header {
          flex-direction: column;
          align-items: stretch;
        }
        
        .header-actions {
          margin-top: 15px;
        }
      }
    </style>
    
    <!-- Página de Conexão (inicialmente oculta) -->
    <div id="connection-page" class="connection-page" style="display: none;">
      <div class="connection-container">
        <div class="connection-header">
          <h2><i class="fas fa-plug"></i> Gerenciamento de Conexão</h2>
          <button id="close-connection-page" class="btn-close" title="Fechar" onclick="closeConnectionPage()">
            <i class="fas fa-times"></i> Fechar
          </button>
          
          <script>
            function closeConnectionPage() {
              console.log('Fechando página de conexão');
              const connectionPage = document.getElementById('connection-page');
              if (connectionPage) {
                connectionPage.style.display = 'none';
              }
            }
          </script>
        </div>
        
        <div class="connection-content">
          <div class="connection-section">
            <h3>Status da Conexão</h3>
            <div class="connection-status-info">
              <div class="connection-status-indicator">
                <div id="conn-status-indicator" class="status-indicator status-disconnected"></div>
                <div id="conn-status-text">Desconectado</div>
              </div>
              <div id="conn-status-message" class="connection-status-message"></div>
            </div>
            
            <div class="connection-actions">
              <button id="conn-connect-btn" class="btn btn-secondary">
                <i class="fas fa-plug"></i> Conectar com Token
              </button>
              <button id="conn-oauth-btn" class="btn">
                <i class="fas fa-external-link-alt"></i> Conectar com Deriv
              </button>
              <button id="conn-disconnect-btn" class="btn btn-outline" style="display: none;">
                <i class="fas fa-power-off"></i> Desconectar
              </button>
            </div>
          </div>
        
        <div class="connection-section">
          <h3>Gerenciamento de Contas</h3>
          <div id="conn-account-info" class="account-details">
            <div class="account-info-header">
              <h4>Informações da Conta Atual</h4>
            </div>
            
            <div class="account-detail-row">
              <span class="detail-label">ID da Conta:</span>
              <span id="conn-account-id" class="detail-value">-</span>
            </div>
            <div class="account-detail-row">
              <span class="detail-label">Nome:</span>
              <span id="conn-account-name" class="detail-value">-</span>
            </div>
            <div class="account-detail-row">
              <span class="detail-label">Tipo:</span>
              <span id="conn-account-type" class="detail-value badge">-</span>
            </div>
            <div class="account-detail-row">
              <span class="detail-label">Saldo:</span>
              <span id="conn-account-balance" class="detail-value highlight">-</span>
              <button id="conn-refresh-balance-btn" class="refresh-btn" title="Atualizar saldo">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/></svg>
              </button>
            </div>
            <div class="account-detail-row">
              <span class="detail-label">Moeda:</span>
              <span id="conn-account-currency" class="detail-value">-</span>
            </div>
            <div class="account-detail-row">
              <span class="detail-label">Método:</span>
              <span id="conn-auth-method" class="detail-value">-</span>
            </div>
            
            <div class="account-actions">
              <button id="conn-account-details-btn" class="btn btn-sm btn-outline">
                <i class="fas fa-info-circle"></i> Detalhes Completos
              </button>
            </div>
          </div>
        </div>
        
        <div class="connection-section" id="conn-accounts-section">
          <h3>Contas Disponíveis</h3>
          <div class="conn-accounts-info">
            <div class="conn-accounts-header">
              <span id="conn-accounts-count">0 contas</span>
              <button id="conn-refresh-accounts-btn" class="btn btn-sm btn-outline" title="Atualizar lista de contas">
                <i class="fas fa-sync-alt"></i> Atualizar
              </button>
            </div>
            
            <!-- Mensagem de status para feedback -->
            <div id="conn-status-message-container" class="status-message-container">
              <p id="conn-status-message" class="status-message"></p>
            </div>
            <div id="conn-accounts-list" class="conn-accounts-list">
              <!-- Lista de contas será preenchida dinamicamente -->
              <div id="conn-accounts-empty-message" class="empty-accounts-message">
                <i class="fas fa-info-circle"></i>
                <p>Conecte-se à sua conta Deriv para ver as contas disponíveis.</p>
                <button id="conn-debug-button" class="btn btn-sm btn-accent" style="margin-top: 10px;">
                  <i class="fas fa-bug"></i> Verificar Contas (Debug)
                </button>
              </div>
            </div>
          </div>
          <div class="account-selector-wrapper">
            <label for="conn-account-selector">Trocar Conta:</label>
            <div class="account-selector-row">
              <select id="conn-account-selector" class="account-selector">
                <option value="">Selecione uma conta</option>
              </select>
              <button id="conn-switch-account-btn" class="btn btn-sm btn-primary" style="margin-left: 8px;">
                <i class="fas fa-check"></i> Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>
        
        <!-- Adicionando estilos inline para a mensagem de contas vazias -->
        <style>
          .empty-accounts-message {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
          }
          
          .empty-accounts-message i {
            font-size: 24px;
            margin-bottom: 10px;
            color: #00a5e3;
          }
          
          .empty-accounts-message p {
            margin: 0;
            font-size: 14px;
          }
          
          .conn-accounts-list {
            min-height: 100px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 5px;
            overflow-y: auto;
            max-height: 200px;
          }
          
          /* Estilos para informações da conta e badges */
          .account-info-header {
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 8px;
          }
          
          .account-info-header h4 {
            margin: 0;
            font-size: 16px;
            color: #00a5e3;
          }
          
          .detail-value.badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            background-color: rgba(0, 0, 0, 0.2);
          }
          
          /* Estilos específicos para tipos de conta */
          .badge-demo {
            background-color: rgba(0, 165, 227, 0.2);
            color: #00a5e3;
            border: 1px solid rgba(0, 165, 227, 0.3);
          }
          
          .badge-real {
            background-color: rgba(0, 229, 179, 0.2);
            color: #00e5b3;
            border: 1px solid rgba(0, 229, 179, 0.3);
          }
          
          /* Estilos para tipos de conta na lista */
          .account-type-demo {
            color: #00a5e3;
          }
          
          .account-type-real {
            color: #00e5b3;
          }
          
          .detail-value.highlight {
            color: #00e5b3;
            font-weight: bold;
          }
          
          .account-actions {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
          }
          
          /* Estilo para item de conta selecionado */
          #conn-accounts-list .account-item.selected {
            background-color: rgba(0, 165, 227, 0.2);
            border-color: #00a5e3;
            box-shadow: 0 0 8px rgba(0, 165, 227, 0.3);
          }
          
          /* Estilos para itens de conta na página de conexão */
          #conn-accounts-list .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
          }
          
          #conn-accounts-list .account-item:hover {
            background-color: rgba(0, 0, 0, 0.3);
            border-color: #00a5e3;
          }
          
          #conn-accounts-list .account-item-info {
            display: flex;
            flex-direction: column;
          }
          
          #conn-accounts-list .account-item-id {
            font-weight: bold;
            color: #ffffff;
            font-size: 14px;
          }
          
          #conn-accounts-list .account-item-type {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
          }
          
          #conn-accounts-list .account-item-currency {
            font-weight: bold;
            color: #00e5b3;
            background-color: rgba(0, 229, 179, 0.1);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
          }
        </style>
      </div>
    </div>
    
    <!-- Account Summary Bar (novo) -->
    <div id="account-summary-bar" class="account-summary-bar" style="display: none;">
      <div class="account-summary-container">
        <div class="account-info-item">
          <div class="account-label">ID da Conta</div>
          <div id="summary-account-id" class="account-value">-</div>
        </div>
        <div class="account-info-item">
          <div class="account-label">Nome</div>
          <div id="summary-account-name" class="account-value">-</div>
        </div>
        <div class="account-info-item">
          <div class="account-label">Tipo</div>
          <div id="summary-account-type" class="account-value">-</div>
        </div>
        <div class="account-info-item">
          <div class="account-label">Saldo</div>
          <div id="summary-account-balance" class="account-value">-</div>
        </div>
        
        <div class="account-selector-container">
          <label for="account-selector">Trocar conta:</label>
          <select id="account-selector" class="account-selector">
            <option value="">Selecione uma conta</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Content area -->
    <div class="content">
      <!-- React App Container -->
      <div id="react-root" style="grid-column: span 12; margin-bottom: 20px;">
        <!-- Os componentes React serão renderizados aqui -->
      </div>
    
      <!-- Connection Status Card -->
      <div class="card status-card">
        <div class="card-header">
          <h2 class="card-title">Status da Conexão</h2>
        </div>
        <div class="connection-status">
          <div id="status-indicator" class="status-indicator status-disconnected"></div>
          <div id="connection-status">Desconectado</div>
        </div>
        <div id="connection-message" class="card-content"></div>
      </div>

      <!-- Account Info Card -->
      <div id="account-info" class="card account-card" style="display: none;">
        <div class="card-header">
          <h2 class="card-title">Conta Deriv</h2>
        </div>
        <div class="account-info">
          <div class="account-detail">
            <div class="label">ID da Conta:</div>
            <div id="account-id" class="value">-</div>
          </div>
          <div class="account-detail">
            <div class="label">Nome:</div>
            <div id="account-name" class="value">-</div>
          </div>
          <div class="account-detail">
            <div class="label">Tipo:</div>
            <div id="account-type" class="value">-</div>
          </div>
          <div class="account-detail">
            <div class="label">Saldo:</div>
            <div id="account-balance" class="value">-</div>
            <button id="refresh-balance-btn" class="refresh-btn" title="Atualizar saldo">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/></svg>
            </button>
          </div>
          
          <div class="account-selector-wrapper">
            <label for="account-selector">Trocar Conta:</label>
            <select id="account-selector" class="account-selector">
              <option value="">Selecione uma conta</option>
            </select>
          </div>
        </div>
        
        <div class="accounts-list-container">
          <div class="accounts-list-header">
            <h3>Contas Disponíveis</h3>
            <span class="accounts-count" id="accounts-count">0 contas</span>
          </div>
          <div class="accounts-list" id="accounts-list">
            <!-- Lista de contas será preenchida dinamicamente -->
          </div>
        </div>
      </div>

      <!-- Quick Stats Card -->
      <div class="card stats-card">
        <div class="card-header">
          <h2 class="card-title">Indicadores</h2>
        </div>
        <div class="card-content">
          <div class="stat-indicators">
            <div class="stat-indicator">
              <span class="indicator-label">RSI:</span>
              <span id="current-rsi" class="indicator-value">--</span>
            </div>
            <div class="stat-indicator">
              <span class="indicator-label">Volatilidade:</span>
              <span id="current-volatility" class="indicator-value">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Digits Chart Card -->
      <div class="card digits-chart-card">
        <div class="card-header">
          <h2 class="card-title">Gráfico de Dígitos R_100</h2>
          <div class="card-actions">
            <button id="reset-stats-btn" class="btn btn-outline btn-sm">
              <i class="fas fa-redo"></i> Reiniciar
            </button>
          </div>
        </div>
        <div class="card-content">
          <div class="bars-chart">
            <div class="bars-container">
              <!-- Bars will be created dynamically -->
            </div>
            <div class="digit-sequence" id="digit-sequence">
              <!-- Recent digits sequence will be added here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Trading Chart Card -->
      <div class="card trading-chart-card">
        <div class="card-header">
          <h2 class="card-title">Análise Técnica</h2>
        </div>
        <div class="card-content">
          <div class="trading-chart">
            <div class="chart-toolbar">
              <div class="chart-toolbar-item active" data-chart="rsi">RSI</div>
              <div class="chart-toolbar-divider"></div>
              <div class="chart-toolbar-item" data-chart="volatility">Volatilidade</div>
            </div>
            <div id="rsi-chart-container" class="chart-container" style="display: block;">
              <canvas id="rsiChart"></canvas>
            </div>
            <div id="volatility-chart-container" class="chart-container" style="display: none;">
              <canvas id="volatilityChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Adicionar Chart.js, React e outras dependências -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Script para carregar os componentes React -->
  <script type="module">
    // Importar o componente TechnicalAnalysis
    import TechnicalAnalysis from '/assets/TechnicalAnalysis.js';
    
    // Definir a função startOAuthFlow globalmente
    window.startOAuthFlow = function() {
      // Parâmetros para o fluxo OAuth
      const oauthUrl = 'https://oauth.deriv.com/oauth2/authorize';
      const clientId = '71555'; // app_id para cliente
      const redirectUri = window.location.origin + '/login.html';
      
      const params = new URLSearchParams({
        app_id: clientId,
        l: 'PT', // Idioma Português
        brand: 'deriv',
        signup_device: 'desktop',
        date_first_contact: new Date().toISOString().split('T')[0],
        redirect_uri: redirectUri
      });
      
      // Abrir janela de autenticação
      window.location.href = `${oauthUrl}?${params.toString()}`;
      
      console.log('Iniciando fluxo OAuth com Deriv:', `${oauthUrl}?${params.toString()}`);
    };
    
    // Inicializar os botões de atualização de conta para evitar referências indefinidas
    window.initAccountRefreshButtons = function() {
      const connRefreshBalanceBtn = document.getElementById('conn-refresh-balance-btn');
      if (connRefreshBalanceBtn) {
        connRefreshBalanceBtn.addEventListener('click', () => {
          console.log('Atualizando saldo da conta...');
          if (window.updateAccountBalance) {
            window.updateAccountBalance();
          }
        });
      }
      
      const connRefreshAccountsBtn = document.getElementById('conn-refresh-accounts-btn');
      if (connRefreshAccountsBtn) {
        connRefreshAccountsBtn.addEventListener('click', () => {
          console.log('Atualizando lista de contas...');
          if (window.getAccountsList) {
            window.getAccountsList();
          }
        });
      }
    };
    
    // Renderizar o componente quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      // Configurar manipulador de eventos para o seletor de contas
      const accountSelectorToggle = document.getElementById('account-selector-toggle');
      if (accountSelectorToggle) {
        accountSelectorToggle.addEventListener('click', (event) => {
          event.stopPropagation(); // Evitar propagação para o documento
          toggleAccountSelector();
        });
        
        console.log('Eventos do seletor de contas configurados');
      } else {
        console.warn('Elemento account-selector-toggle não encontrado');
      }
      
      // Fechar o seletor quando clicar fora dele
      document.addEventListener('click', (event) => {
        const accountSelector = document.getElementById('account-selector');
        if (accountSelector && !accountSelector.contains(event.target) && accountSelector.classList.contains('open')) {
          closeAccountSelector();
        }
      });
      
      const container = document.getElementById('react-root');
      if (container) {
        // Renderizar o componente TechnicalAnalysis
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(TechnicalAnalysis));
        console.log('TechnicalAnalysis renderizado no react-root');
      } else {
        console.error('Contêiner react-root não encontrado');
      }
      
      // Inicializar todos os elementos importantes
      // Função não está definida, então estamos removendo a chamada
      // window.initializeElements();
      console.log('Inicialização de elementos realizada');
      
      // Inicialize o botão OAuth aqui para garantir que ele esteja disponível
      const oauthLoginBtn = document.getElementById('oauth-btn');
      if (oauthLoginBtn) {
        oauthLoginBtn.addEventListener('click', function() {
          console.log('Botão OAuth clicado - usando função centralizada');
          window.authUtils.startOAuthFlow();
        });
      }
      
      // Faça o mesmo para o botão na modal de conexão
      const connOauthBtn = document.getElementById('conn-oauth-btn');
      if (connOauthBtn) {
        connOauthBtn.addEventListener('click', function() {
          console.log('Botão OAuth na modal clicado - usando função centralizada');
          window.authUtils.startOAuthFlow();
        });
      }
      // Inicializar a função de atualização de conta
      window.initAccountRefreshButtons = function() {
        const refreshBalanceBtn = document.getElementById('refresh-balance-btn');
        if (refreshBalanceBtn) {
          refreshBalanceBtn.addEventListener('click', function() {
            if (typeof updateAccountBalance === 'function') {
              updateAccountBalance();
            }
          });
        }

        const connRefreshBalanceBtn = document.getElementById('conn-refresh-balance-btn');
        if (connRefreshBalanceBtn) {
          connRefreshBalanceBtn.addEventListener('click', function() {
            if (typeof updateAccountBalance === 'function') {
              updateAccountBalance();
            }
          });
        }
        
        // Inicializar botão de atualização no painel de conta ativa do cabeçalho
        const refreshAccountBtn = document.getElementById('refresh-account-btn');
        if (refreshAccountBtn) {
          refreshAccountBtn.addEventListener('click', function() {
            if (typeof updateAccountBalance === 'function') {
              updateAccountBalance();
            }
          });
          
          // Adicionar efeito de hover
          refreshAccountBtn.addEventListener('mouseenter', function() {
            this.classList.add('refresh-hover');
          });
          
          refreshAccountBtn.addEventListener('mouseleave', function() {
            this.classList.remove('refresh-hover');
          });
        }
      };
      
      // Inicializar os botões de atualização da conta
      if (typeof window.initAccountRefreshButtons === 'function') {
        window.initAccountRefreshButtons();
      }
    });
  </script>
  
  <script>
    // Função para inicializar o seletor de contas com dados reais
    // Função para preencher o dropdown de contas disponíveis
    function populateAccountDropdown() {
      console.log('Preenchendo dropdown de contas...');
      try {
        // Obter o elemento dropdown
        const accountsDropdown = document.getElementById('accounts-dropdown');
        if (!accountsDropdown) {
          console.error('Dropdown de contas não encontrado');
          return;
        }
        
        // Limpar conteúdo existente
        accountsDropdown.innerHTML = '';
        
        // Obter contas disponíveis (do localStorage ou objeto global)
        let accounts = [];
        
        // Verificar contas da API
        const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
        if (apiAccountsJson) {
          try {
            const apiAccounts = JSON.parse(apiAccountsJson);
            if (Array.isArray(apiAccounts)) {
              accounts = [...accounts, ...apiAccounts];
            }
          } catch (e) {
            console.error('Erro ao processar contas API:', e);
          }
        }
        
        // Verificar contas OAuth
        const oauthAccountsJson = localStorage.getItem('deriv_accounts');
        if (oauthAccountsJson) {
          try {
            const oauthAccounts = JSON.parse(oauthAccountsJson);
            if (Array.isArray(oauthAccounts)) {
              // Adicionar apenas contas não duplicadas
              oauthAccounts.forEach(oauthAccount => {
                if (!accounts.some(acc => acc.loginid === oauthAccount.loginid)) {
                  accounts.push(oauthAccount);
                }
              });
            }
          } catch (e) {
            console.error('Erro ao processar contas OAuth:', e);
          }
        }
        
        // Verificar contas no objeto global (se existir)
        if (window.availableAccounts && Array.isArray(window.availableAccounts)) {
          window.availableAccounts.forEach(account => {
            if (!accounts.some(acc => acc.loginid === account.loginid)) {
              accounts.push(account);
            }
          });
        }
        
        console.log(`Encontradas ${accounts.length} contas para exibição no dropdown`);
        
        // Se não houver contas, exibir mensagem
        if (accounts.length === 0) {
          const emptyMessage = document.createElement('div');
          emptyMessage.className = 'account-dropdown-empty';
          emptyMessage.textContent = 'Nenhuma conta disponível';
          accountsDropdown.appendChild(emptyMessage);
          return;
        }
        
        // Obter ID da conta ativa
        const activeLoginId = localStorage.getItem('deriv_active_loginid') || '';
        
        // Adicionar cada conta ao dropdown
        accounts.forEach(account => {
          const accountItem = document.createElement('div');
          accountItem.className = 'account-dropdown-item';
          if (account.loginid === activeLoginId) {
            accountItem.classList.add('active');
          }
          
          // Determinar se é demo ou real
          const isDemo = account.is_virtual === 1 || 
                         account.is_virtual === true || 
                         (typeof account.loginid === 'string' && account.loginid.startsWith('VRT'));
          
          // Criar conteúdo HTML
          accountItem.innerHTML = `
            <div class="dropdown-account-info">
              <span class="dropdown-account-id">${account.loginid}</span>
              <span class="dropdown-account-type ${isDemo ? 'account-type-demo' : 'account-type-real'}">${isDemo ? 'Demo' : 'Real'}</span>
            </div>
            <div class="dropdown-account-balance">${account.currency || ''} ${parseFloat(account.balance || 0).toFixed(2)}</div>
          `;
          
          // Adicionar evento de clique
          accountItem.addEventListener('click', function() {
            // Trocar para esta conta
            if (typeof switchAccount === 'function') {
              switchAccount(account.loginid);
              
              // Fechar dropdown após seleção
              accountsDropdown.style.display = 'none';
            } else {
              console.error('Função switchAccount não encontrada');
            }
          });
          
          // Adicionar ao dropdown
          accountsDropdown.appendChild(accountItem);
        });
        
        // Atualizar estilos para o dropdown
        const style = document.createElement('style');
        style.textContent = `
          .accounts-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            width: 250px;
            background-color: rgba(14, 26, 51, 0.95);
            border: 1px solid rgba(0, 229, 179, 0.3);
            border-top: none;
            border-radius: 0 0 8px 8px;
            z-index: 100;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
            margin-top: 5px;
          }
          
          .account-dropdown-item {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
          }
          
          .account-dropdown-item:last-child {
            border-bottom: none;
          }
          
          .account-dropdown-item:hover {
            background-color: rgba(0, 0, 0, 0.3);
          }
          
          .account-dropdown-item.active {
            background-color: rgba(0, 229, 179, 0.1);
            border-left: 3px solid #00e5b3;
          }
          
          .dropdown-account-info {
            display: flex;
            flex-direction: column;
          }
          
          .dropdown-account-id {
            font-weight: 600;
            font-size: 14px;
          }
          
          .dropdown-account-type {
            font-size: 12px;
            margin-top: 4px;
          }
          
          .dropdown-account-balance {
            font-weight: 600;
            color: #00e5b3;
          }
          
          .account-dropdown-empty {
            padding: 15px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
          }
        `;
        document.head.appendChild(style);
        
        // Mostrar o dropdown
        accountsDropdown.style.display = 'block';
        
      } catch (error) {
        console.error('Erro ao preencher dropdown de contas:', error);
      }
    }
    
    // Adicionar evento para clique no seletor de contas
    document.addEventListener('DOMContentLoaded', function() {
      const accountSelectorToggle = document.getElementById('account-selector-toggle');
      const accountsDropdown = document.getElementById('accounts-dropdown');
      
      if (accountSelectorToggle && accountsDropdown) {
        accountSelectorToggle.addEventListener('click', function() {
          if (accountsDropdown.style.display === 'block') {
            accountsDropdown.style.display = 'none';
          } else {
            // Preencher o dropdown antes de exibi-lo
            populateAccountDropdown();
          }
        });
        
        // Fechar ao clicar fora
        document.addEventListener('click', function(e) {
          if (!accountSelectorToggle.contains(e.target) && !accountsDropdown.contains(e.target)) {
            accountsDropdown.style.display = 'none';
          }
        });
      }
    });

    // Função para recuperar o token associado a um ID de conta específico
    function getTokenForAccount(accountId) {
      if (!accountId) return null;
      
      console.log('Buscando token para a conta:', accountId);
      
      // Tentar primeiro os tokens diretos
      let token = localStorage.getItem('deriv_token_' + accountId);
      if (token) {
        console.log('Token encontrado no localStorage para:', accountId);
        return token;
      }
      
      // Verificar o token global (não específico de conta)
      token = localStorage.getItem('deriv_token');
      if (token) {
        console.log('Token global encontrado no localStorage');
        return token;
      }
      
      // Verificar se temos tokens mapeados no formato OAuth
      const oauthRedirectData = localStorage.getItem('oauth_redirect_data');
      if (oauthRedirectData) {
        try {
          const data = JSON.parse(oauthRedirectData);
          // Percorrer os parâmetros buscando tokens e IDs correspondentes
          for (let i = 1; i <= 5; i++) { // Suporta até 5 contas
            const acct = data['acct' + i];
            const token = data['token' + i];
            if (acct === accountId && token) {
              return token;
            }
          }
        } catch (e) {
          console.error('Erro ao processar dados do redirecionamento OAuth:', e);
        }
      }
      
      // Verificar no armazenamento de tokens
      const tokensJson = localStorage.getItem('deriv_tokens');
      if (tokensJson) {
        try {
          const tokens = JSON.parse(tokensJson);
          const tokenEntry = tokens.find(t => t.accountId === accountId);
          if (tokenEntry && tokenEntry.token) {
            return tokenEntry.token;
          }
        } catch (e) {
          console.error('Erro ao analisar tokens armazenados:', e);
        }
      }
      
      // Tentar estratégia de último recurso - verificar o token primário
      const primaryToken = localStorage.getItem('deriv_token');
      if (primaryToken) {
        return primaryToken;
      }
      
      return null;
    }
    
    // Função para atualizar o saldo de uma conta
    function updateAccountBalance(accountId, callbackFn) {
      if (!accountId) return;
      
      console.log('Iniciando atualização de saldo para a conta:', accountId);
      
      // Verificar se tem WebSocket ativo
      if (!window.ws || window.ws.readyState !== WebSocket.OPEN) {
        console.warn('WebSocket não está aberto, não é possível atualizar saldo');
        return;
      }
      
      // Primeiro verificar se o WebSocket já está conectado e autorizado
      const connectStatus = document.getElementById('connection-status');
      console.log('Status da conexão:', connectStatus ? connectStatus.textContent : 'desconhecido');
      
      // Obter o token para a conta
      const token = getTokenForAccount(accountId);
      if (!token) {
        console.warn('Token não encontrado para conta:', accountId);
        return;
      }
      
      console.log('Token encontrado para a conta:', accountId, 'Tamanho:', token.length, 'Início:', token.substring(0, 5), '...');
      
      // Exibir o modo atual do token
      const tokenMode = localStorage.getItem('deriv_token_mode') || 'SINGLE';
      console.log('Modo atual do token:', tokenMode);
      
      // Preparar requisição de autorização
      const authRequest = {
        authorize: token,
        req_id: Date.now()
      };
      
      // Listener único para processar a resposta
      const messageHandler = function(event) {
        try {
          const data = JSON.parse(event.data);
          
          // Se a resposta for da autorização
          if (data.req_id === authRequest.req_id && data.authorize) {
            console.log('Autorização bem-sucedida para obter saldo');
            
            // Agora que estamos autorizados, solicitar o saldo
            // No modo MULTI precisamos especificar o loginid
            const balanceRequest = {
              balance: 1,
              subscribe: 0,
              loginid: accountId, // Conforme documentação, é obrigatório quando usamos modo MULTI
              req_id: Date.now() + 1
            };
            
            window.ws.send(JSON.stringify(balanceRequest));
          }
          
          // Se a resposta for do saldo
          if (data.balance) {
            console.log('Saldo recebido (resposta completa):', data);
            console.log('Dados do saldo:', data.balance);
            
            // Atualizar o saldo no localStorage
            const oauthAccountsJson = localStorage.getItem('deriv_accounts');
            if (oauthAccountsJson) {
              try {
                const accounts = JSON.parse(oauthAccountsJson);
                const accountIndex = accounts.findIndex(acc => acc.loginid === accountId);
                if (accountIndex !== -1) {
                  accounts[accountIndex].balance = data.balance.balance;
                  localStorage.setItem('deriv_accounts', JSON.stringify(accounts));
                }
              } catch (e) {
                console.error('Erro ao atualizar saldo nas contas OAuth:', e);
              }
            }
            
            // Atualizar UI com o novo saldo
            const accountSelectorBalance = document.getElementById('account-selector-balance');
            if (accountSelectorBalance) {
              accountSelectorBalance.textContent = `${data.balance.currency} ${parseFloat(data.balance.balance || 0).toFixed(2)}`;
            }
            
            // Executar callback, se fornecido
            if (typeof callbackFn === 'function') {
              callbackFn(data.balance);
            }
            
            // Remover o listener após usar
            window.ws.removeEventListener('message', messageHandler);
          }
        } catch (error) {
          console.error('Erro ao processar mensagem WebSocket:', error);
        }
      };
      
      // Adicionar o handler de mensagem
      window.ws.addEventListener('message', messageHandler);
      
      // Verificar se o token é válido
      if (token.length < 10) {
        console.error('Token parece inválido, muito curto:', token.length);
        return;
      }
      
      // Enviar a requisição de autorização
      console.log('Enviando requisição de autorização para obter saldo:', JSON.stringify(authRequest));
      window.ws.send(JSON.stringify(authRequest));
    }
    
    function initializeAccountSelector() {
      console.log('Inicializando seletor de contas...');
      try {
        // Obter os elementos do seletor
        const accountSelector = document.getElementById('account-selector');
        const accountSelectorText = document.getElementById('account-selector-text');
        const accountSelectorBalance = document.getElementById('account-selector-balance');
        const accountSelectorType = document.getElementById('account-selector-type');
        
        if (!accountSelector || !accountSelectorText || !accountSelectorBalance || !accountSelectorType) {
          console.error('Elementos do seletor de contas não encontrados');
          return;
        }
        
        // Obter conta ativa do armazenamento
        const activeLoginId = localStorage.getItem('deriv_active_loginid');
        
        if (!activeLoginId) {
          console.warn('ID de conta ativa não encontrado no localStorage');
          return;
        }
        
        console.log('Conta ativa encontrada:', activeLoginId);
        
        // Buscar a conta ativa da lista de contas disponíveis
        let activeAccount = null;
        
        // Primeiro verificar contas API
        const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
        if (apiAccountsJson) {
          const apiAccounts = JSON.parse(apiAccountsJson);
          activeAccount = apiAccounts.find(acc => acc.loginid === activeLoginId);
        }
        
        // Se não encontrou nas contas API, verificar nas contas OAuth
        if (!activeAccount) {
          const oauthAccountsJson = localStorage.getItem('deriv_accounts');
          if (oauthAccountsJson) {
            const oauthAccounts = JSON.parse(oauthAccountsJson);
            activeAccount = oauthAccounts.find(acc => acc.loginid === activeLoginId);
          }
        }
        
        if (!activeAccount) {
          console.warn('Conta ativa não encontrada nos dados armazenados');
          return;
        }
        
        console.log('Dados da conta ativa:', activeAccount);
        
        // Atualizar o seletor com os dados da conta
        accountSelectorText.textContent = activeAccount.loginid;
        
        // Determinar se é demo ou real
        const isDemo = activeAccount.is_virtual === 1 || 
                      activeAccount.is_virtual === true || 
                      activeAccount.loginid.startsWith('VRT');
        
        accountSelectorType.textContent = isDemo ? 'Demo' : 'Real';
        accountSelectorType.className = `account-type-badge ${isDemo ? 'account-type-demo' : 'account-type-real'}`;
        
        // Atualizar saldo
        accountSelectorBalance.textContent = `${activeAccount.currency || ''} ${parseFloat(activeAccount.balance || 0).toFixed(2)}`;
        
        // Exibir o seletor
        accountSelector.style.display = 'inline-block';
        
        console.log('Seletor de contas inicializado com sucesso!');
        
        // Verificar se temos dados de URL do OAuth armazenados
        const oauthRedirectData = localStorage.getItem('oauth_redirect_data');
        if (oauthRedirectData) {
          try {
            console.log('Dados de redirecionamento OAuth encontrados');
            const data = JSON.parse(oauthRedirectData);
            
            // Salvar todos os tokens associados às contas específicas
            for (let i = 1; i <= 5; i++) { // Suporta até 5 contas
              const acct = data['acct' + i];
              const token = data['token' + i];
              if (acct && token) {
                console.log(`Salvando token para conta ${acct}`);
                localStorage.setItem(`deriv_token_${acct}`, token);
              }
            }
          } catch (e) {
            console.error('Erro ao processar dados do redirecionamento OAuth:', e);
          }
        } else {
          // Verificar se temos contas OAuth
          const oauthAccountsJson = localStorage.getItem('deriv_accounts');
          if (oauthAccountsJson) {
            try {
              const oauthAccounts = JSON.parse(oauthAccountsJson);
              
              // Para cada conta, armazenar o token correspondente
              oauthAccounts.forEach(account => {
                if (account.token && account.loginid) {
                  console.log(`Salvando token para conta ${account.loginid} do OAuth`);
                  localStorage.setItem(`deriv_token_${account.loginid}`, account.token);
                }
              });
            } catch (e) {
              console.error('Erro ao processar contas OAuth:', e);
            }
          }
        }
        
        // Buscar saldo atualizado
        setTimeout(() => {
          updateAccountBalance(activeLoginId, function(balanceData) {
            console.log('Saldo atualizado na inicialização:', balanceData);
          });
        }, 1000);
        
        // Atualizar o dropdown de contas
        if (typeof populateAccountsSelector === 'function') {
          populateAccountsSelector();
        }
      } catch (error) {
        console.error('Erro ao inicializar seletor de contas:', error);
      }
    }
    
    // Função para alternar entre contas
    function switchAccount(accountId) {
      console.log('Alternando para a conta:', accountId);
      try {
        if (!accountId) {
          console.error('ID de conta não fornecido');
          return false;
        }
        
        // Armazenar ID da conta ativa
        localStorage.setItem('deriv_active_loginid', accountId);
        
        // Buscar dados da conta selecionada
        let selectedAccount = null;
        
        // Verificar contas API
        const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
        if (apiAccountsJson) {
          const apiAccounts = JSON.parse(apiAccountsJson);
          selectedAccount = apiAccounts.find(acc => acc.loginid === accountId);
        }
        
        // Verificar contas OAuth
        if (!selectedAccount) {
          const oauthAccountsJson = localStorage.getItem('deriv_accounts');
          if (oauthAccountsJson) {
            const oauthAccounts = JSON.parse(oauthAccountsJson);
            selectedAccount = oauthAccounts.find(acc => acc.loginid === accountId);
          }
        }
        
        if (!selectedAccount) {
          console.error('Conta selecionada não encontrada nos dados disponíveis');
          return false;
        }
        
        console.log('Dados da conta para troca:', selectedAccount);
        
        // Buscar saldo atualizado se a conexão estiver ativa
        if (window.ws && window.ws.readyState === WebSocket.OPEN) {
          // Encontrar o token associado a esta conta
          let token = '';
          
          // Verificar no localStorage
          if (accountId.startsWith('VRT')) {
            token = localStorage.getItem('deriv_token_' + accountId);
          } else {
            token = localStorage.getItem('deriv_token_' + accountId);
          }
          
          if (!token) {
            // Tentar obter do cache de tokens
            const tokensJson = localStorage.getItem('deriv_tokens');
            if (tokensJson) {
              try {
                const tokens = JSON.parse(tokensJson);
                const tokenEntry = tokens.find(t => t.accountId === accountId);
                if (tokenEntry) {
                  token = tokenEntry.token;
                }
              } catch (e) {
                console.error('Erro ao analisar tokens armazenados:', e);
              }
            }
          }
          
          // Se encontrou um token, fazer requisição de saldo
          if (token) {
            const balanceRequest = {
              balance: 1,
              subscribe: 1,
              loginid: accountId, // Parâmetro obrigatório para modo MULTI conforme documentação
              req_id: Date.now()
            };
            
            // Enviar requisição
            window.ws.send(JSON.stringify(balanceRequest));
            
            // Adicionar um ouvinte temporário para a resposta
            const balanceListener = function(event) {
              try {
                const data = JSON.parse(event.data);
                if (data.req_id === balanceRequest.req_id && data.balance) {
                  console.log('Saldo atualizado recebido:', data.balance);
                  
                  // Atualizar o saldo nos dados da conta
                  selectedAccount.balance = data.balance.balance;
                  selectedAccount.currency = data.balance.currency;
                  
                  // Atualizar interface com o novo saldo
                  const accountSelectorBalance = document.getElementById('account-selector-balance');
                  if (accountSelectorBalance) {
                    accountSelectorBalance.textContent = `${data.balance.currency} ${parseFloat(data.balance.balance || 0).toFixed(2)}`;
                  }
                  
                  // Atualizar o armazenamento local com o novo saldo
                  const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
                  if (apiAccountsJson) {
                    try {
                      const apiAccounts = JSON.parse(apiAccountsJson);
                      const accountIndex = apiAccounts.findIndex(acc => acc.loginid === accountId);
                      if (accountIndex !== -1) {
                        apiAccounts[accountIndex].balance = data.balance.balance;
                        localStorage.setItem('deriv_accounts_api', JSON.stringify(apiAccounts));
                      }
                    } catch (e) {
                      console.error('Erro ao atualizar saldo nas contas API:', e);
                    }
                  }
                  
                  const oauthAccountsJson = localStorage.getItem('deriv_accounts');
                  if (oauthAccountsJson) {
                    try {
                      const oauthAccounts = JSON.parse(oauthAccountsJson);
                      const accountIndex = oauthAccounts.findIndex(acc => acc.loginid === accountId);
                      if (accountIndex !== -1) {
                        oauthAccounts[accountIndex].balance = data.balance.balance;
                        localStorage.setItem('deriv_accounts', JSON.stringify(oauthAccounts));
                      }
                    } catch (e) {
                      console.error('Erro ao atualizar saldo nas contas OAuth:', e);
                    }
                  }
                  
                  // Remover o ouvinte após usar
                  window.ws.removeEventListener('message', balanceListener);
                }
              } catch (error) {
                console.error('Erro ao processar resposta de saldo:', error);
              }
            };
            
            // Adicionar o ouvinte
            window.ws.addEventListener('message', balanceListener);
          } else {
            console.warn('Token não encontrado para a conta ' + accountId + ', não será possível buscar saldo atualizado');
          }
        } else {
          console.warn('WebSocket não está conectado, não será possível buscar saldo atualizado');
        }
        
        // Atualizar elementos de UI
        const accountSelectorText = document.getElementById('account-selector-text');
        const accountSelectorBalance = document.getElementById('account-selector-balance');
        const accountSelectorType = document.getElementById('account-selector-type');
        
        if (accountSelectorText) {
          accountSelectorText.textContent = selectedAccount.loginid;
        }
        
        if (accountSelectorBalance) {
          accountSelectorBalance.textContent = `${selectedAccount.currency || ''} ${parseFloat(selectedAccount.balance || 0).toFixed(2)}`;
        }
        
        if (accountSelectorType) {
          // Determinar se é demo ou real
          const isDemo = selectedAccount.is_virtual === 1 || 
                        selectedAccount.is_virtual === true || 
                        selectedAccount.loginid.startsWith('VRT');
          
          accountSelectorType.textContent = isDemo ? 'Demo' : 'Real';
          accountSelectorType.className = `account-type-badge ${isDemo ? 'account-type-demo' : 'account-type-real'}`;
        }
        
        // Verificar se estamos usando WebSocket e se precisamos reconectar com o novo token
        if (window.api && typeof window.api.changeAccount === 'function') {
          // Usar função interna do API Manager para trocar de conta
          window.api.changeAccount(accountId);
        } else {
          // Se não existe API manager, tentar uma abordagem alternativa
          // Podemos forçar um reload da página
          console.log('API Manager não disponível, recarregando a página...');
          
          // Armazenar a conta ativa e recarregar
          localStorage.setItem('account_reload_pending', 'true');
          window.location.reload();
          return true;
        }
        
        return true;
      } catch (error) {
        console.error('Erro ao alternar contas:', error);
        return false;
      }
    }
    
    // Inicializar seletor de contas quando o documento estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar com um pequeno atraso para garantir que outros scripts estejam carregados
      setTimeout(initializeAccountSelector, 1000);
    });
    
    // Função para criar itens de conta diretamente a partir do localStorage
    function createAccountElementsFromStorage() {
      try {
        // Obter contas do localStorage
        const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
        const oauthAccountsJson = localStorage.getItem('deriv_accounts');
        
        let accounts = [];
        
        // Processar contas API
        if (apiAccountsJson) {
          const apiAccounts = JSON.parse(apiAccountsJson);
          accounts = [...accounts, ...apiAccounts];
          console.log('Contas API carregadas:', apiAccounts.length);
        }
        
        // Processar contas OAuth
        if (oauthAccountsJson) {
          const oauthAccounts = JSON.parse(oauthAccountsJson);
          // Adicionar apenas contas não duplicadas
          oauthAccounts.forEach(oauthAccount => {
            if (!accounts.some(acc => acc.loginid === oauthAccount.loginid)) {
              accounts.push(oauthAccount);
            }
          });
          console.log('Contas OAuth carregadas:', oauthAccounts.length);
        }
        
        console.log('Total de contas para exibição:', accounts.length);
        
        if (accounts.length > 0) {
          // Elementos UI
          const connAccountsList = document.getElementById('conn-accounts-list');
          const connAccountsCount = document.getElementById('conn-accounts-count');
          const emptyAccountsMessage = document.getElementById('conn-accounts-empty-message');
          const connAccountSelector = document.getElementById('conn-account-selector');
          
          // Esconder mensagem vazia
          if (emptyAccountsMessage) {
            emptyAccountsMessage.style.display = 'none';
          }
          
          // Atualizar contador
          if (connAccountsCount) {
            connAccountsCount.textContent = `${accounts.length} conta${accounts.length !== 1 ? 's' : ''}`;
          }
          
          // Limpar listas
          if (connAccountsList) connAccountsList.innerHTML = '';
          if (connAccountSelector) connAccountSelector.innerHTML = '<option value="">Selecione uma conta</option>';
          
          // Obter ID da conta atual
          const currentAccountId = document.getElementById('account-id') ? 
            document.getElementById('account-id').textContent : '';
          
          // Renderizar contas
          accounts.forEach(account => {
            // Criar item de conta
            if (connAccountsList) {
              const accountItem = document.createElement('div');
              accountItem.className = 'account-item';
              if (account.loginid === currentAccountId) {
                accountItem.classList.add('selected', 'active');
              }
              accountItem.dataset.accountId = account.loginid;
              
              // Determinar tipo de conta
              const isVirtual = account.is_virtual === 1 || account.is_virtual === true || 
                                account.loginid.startsWith('VRT');
              const accountType = isVirtual ? 'Demo' : 'Real';
              const accountTypeClass = isVirtual ? 'demo' : 'real';
              
              // Ícone específico para tipo de conta
              const accountIcon = isVirtual ? 
                '<i class="fas fa-flask" title="Conta de demonstração"></i>' : 
                '<i class="fas fa-money-bill-wave" title="Conta real"></i>';
              
              // Construir HTML
              accountItem.innerHTML = `
                <div class="account-item-info">
                  <div class="account-item-id">
                    ${accountIcon} ${account.loginid}
                  </div>
                  <div class="account-item-type account-type-${accountTypeClass}">
                    ${accountType}
                  </div>
                </div>
                <div class="account-item-details">
                  <div class="account-item-currency">${account.currency || ''}</div>
                  <div class="account-item-action">
                    <button class="account-select-btn" title="Selecionar esta conta">
                      <i class="fas fa-check-circle"></i>
                    </button>
                  </div>
                </div>
              `;
              
              // Evento de clique
              accountItem.addEventListener('click', function() {
                // Visual feedback
                connAccountsList.querySelectorAll('.account-item').forEach(item => {
                  item.classList.remove('selected', 'active');
                });
                this.classList.add('selected', 'active');
                
                // Status message
                const statusMsg = document.getElementById('conn-status-message');
                if (statusMsg) {
                  statusMsg.textContent = `Trocando para a conta ${account.loginid}...`;
                  statusMsg.style.color = '#00e5b3';
                }
                
                // Realizar a troca
                switchAccount(account.loginid);
                
                // Atualizar seletor
                if (connAccountSelector) {
                  connAccountSelector.value = account.loginid;
                }
                
                // Feedback de conclusão
                setTimeout(() => {
                  if (statusMsg) {
                    statusMsg.textContent = 'Conta alterada com sucesso!';
                    setTimeout(() => {
                      statusMsg.textContent = '';
                    }, 3000);
                  }
                }, 1500);
              });
              
              // Adicionar à lista
              connAccountsList.appendChild(accountItem);
            }
            
            // Adicionar ao seletor
            if (connAccountSelector) {
              const option = document.createElement('option');
              option.value = account.loginid;
              option.textContent = `${account.loginid} (${isVirtual ? 'Demo' : 'Real'})${account.currency ? ' - ' + account.currency : ''}`;
              
              if (account.loginid === currentAccountId) {
                option.selected = true;
              }
              
              connAccountSelector.appendChild(option);
            }
          });
          
          // Adicionar estilos específicos
          const styleElement = document.createElement('style');
          styleElement.textContent = `
            .status-message-container {
              margin: 5px 0;
              min-height: 24px;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            
            .status-message {
              color: #00e5b3;
              font-size: 14px;
              font-weight: 500;
              text-align: center;
              transition: all 0.3s ease;
            }
            
            .conn-accounts-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 10px;
            }
            
            #conn-accounts-list .account-item {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 12px 15px;
              margin-bottom: 10px;
              background-color: rgba(0, 0, 0, 0.2);
              border-radius: 8px;
              border-left: 3px solid transparent;
              transition: all 0.2s ease;
              cursor: pointer;
            }
            
            #conn-accounts-list .account-item:hover {
              background-color: rgba(0, 0, 0, 0.3);
              border-color: #00a5e3;
            }
            
            #conn-accounts-list .account-item.selected,
            #conn-accounts-list .account-item.active {
              background-color: rgba(0, 165, 227, 0.2);
              border-color: #00e5b3;
              box-shadow: 0 0 8px rgba(0, 229, 179, 0.3);
            }
            
            #conn-accounts-list .account-item-info {
              display: flex;
              flex-direction: column;
            }
            
            #conn-accounts-list .account-item-id {
              font-weight: bold;
              color: #ffffff;
              font-size: 14px;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            
            #conn-accounts-list .account-item-type {
              font-size: 12px;
              color: rgba(255, 255, 255, 0.7);
              margin-top: 4px;
            }
            
            #conn-accounts-list .account-item-type.account-type-demo {
              color: #00a5e3;
            }
            
            #conn-accounts-list .account-item-type.account-type-real {
              color: #00e5b3;
            }
            
            #conn-accounts-list .account-item-details {
              display: flex;
              align-items: center;
              gap: 10px;
            }
            
            #conn-accounts-list .account-item-currency {
              font-weight: bold;
              color: #00e5b3;
              padding: 3px 8px;
              border-radius: 4px;
              background-color: rgba(0, 229, 179, 0.1);
              font-size: 12px;
            }
          `;
          document.head.appendChild(styleElement);
          
          console.log('Renderização de contas concluída com sucesso!');
          return true;
        } else {
          console.log('Nenhuma conta disponível para exibição');
          return false;
        }
      } catch (error) {
        console.error('Erro ao renderizar contas:', error);
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM carregado, preparando conexão...');
      
      // Forçar atualização inicial do status para garantir consistência visual
      setTimeout(() => {
        const statusIndicator = document.getElementById('status-indicator');
        const connectionStatus = document.getElementById('connection-status');
        
        if (statusIndicator && connectionStatus) {
          if (ws && ws.readyState === WebSocket.OPEN) {
            statusIndicator.className = 'status-indicator status-connected';
            connectionStatus.textContent = 'Conectado';
          } else {
            statusIndicator.className = 'status-indicator status-disconnected';
            connectionStatus.textContent = 'Desconectado';
          }
        }
      }, 500);
      
      // Configurar event listeners para os botões de conexão
      const btnConnect = document.getElementById('connect-btn');
      if (btnConnect) {
        btnConnect.addEventListener('click', function() {
          console.log('Botão conectar clicado');
          connectWebSocket();
        });
      }
      
      const oauthBtn = document.getElementById('oauth-btn');
      if (oauthBtn) {
        oauthBtn.addEventListener('click', function() {
          console.log('Botão OAuth clicado na página principal');
          window.authUtils.startOAuthFlow();
        });
      }
      
      const disconnectBtn = document.getElementById('disconnect-btn');
      if (disconnectBtn) {
        disconnectBtn.addEventListener('click', function() {
          console.log('Botão desconectar clicado');
          disconnectWebSocket();
        });
      }
      
      // Configurar event listeners para os botões na página de conexão
      const connConnectBtn = document.getElementById('conn-connect-btn');
      if (connConnectBtn) {
        connConnectBtn.addEventListener('click', function() {
          console.log('Botão conectar na página de conexão clicado');
          connectWebSocket();
        });
      }
      
      const connOauthBtn = document.getElementById('conn-oauth-btn');
      if (connOauthBtn) {
        connOauthBtn.addEventListener('click', function() {
          console.log('Botão OAuth na página de conexão clicado');
          window.authUtils.startOAuthFlow();
        });
      }
      
      const connDisconnectBtn = document.getElementById('conn-disconnect-btn');
      if (connDisconnectBtn) {
        connDisconnectBtn.addEventListener('click', function() {
          console.log('Botão desconectar na página de conexão clicado');
          disconnectWebSocket();
        });
      }
      
      // Verificar se existe um token salvo e tentar conectar automaticamente
      const savedToken = localStorage.getItem('deriv_api_token');
      if (savedToken) {
        console.log('Token salvo encontrado. Tentando conectar automaticamente...');
        derivToken = savedToken;
        setTimeout(connectWebSocket, 1000); // Pequeno delay para garantir que a página está pronta
      }
      
      // Renderizar contas do localStorage
      if (typeof createAccountElementsFromStorage === 'function') {
        createAccountElementsFromStorage();
      } else {
        console.error('A função createAccountElementsFromStorage não está definida');
      }
      
      // Inicializar botões de atualização de conta
      if (typeof window.initAccountRefreshButtons === 'function') {
        window.initAccountRefreshButtons();
      } else {
        console.error('A função initAccountRefreshButtons não está definida');
      }
      
      // Remove este bloco, pois as declarações e event listeners já existem acima
    
      // Verificar se o usuário está autenticado
      fetch('/api/check-auth')
        .then(response => {
          if (!response.ok) {
            // Não redirecionar para a página de login, continuar mesmo sem autenticação
            console.log('Usuário não autenticado, mas permitindo acesso ao dashboard para teste');
            return null;
          }
          return response.json();
        })
        .then(data => {
          if (data && data.authenticated) {
            // Inicializar com usuário autenticado
            console.log('Usuário autenticado:', data.username);
            
            // Atualizar elementos da UI com dados do usuário
            const userProfileInitial = document.querySelector('.user-profile span');
            if (userProfileInitial) {
              userProfileInitial.textContent = data.username.charAt(0).toUpperCase();
            } else {
              console.error('Elemento .user-profile span não encontrado');
            }
            
            const usernameElement = document.querySelector('.username');
            if (usernameElement) {
              usernameElement.textContent = data.username;
            } else {
              console.error('Elemento .username não encontrado');
            }
            
            // Verificar se estamos chegando de uma autenticação OAuth (parâmetro na URL)
            const urlParams = new URLSearchParams(window.location.search);
            let isOAuth = urlParams.get('oauth') === 'true';
            
            // Verificar tokens disponíveis
            let oauthToken = localStorage.getItem('deriv_oauth_token');
            let authMethod = localStorage.getItem('auth_method');
            
            // Log detalhado para depuração da autenticação
            console.log('Estado de autenticação:',
              'Token OAuth:', oauthToken ? 'Presente' : 'Ausente',
              'Vindo do fluxo OAuth:', isOAuth ? 'Sim' : 'Não',
              'Método de autenticação armazenado:', authMethod || 'Não definido'
            );
            
            // Se a autenticação foi via OAuth, verificar tokens na localStorage
            if (oauthToken || authMethod === 'oauth' || isOAuth) {
              console.log('Método OAuth detectado, estabelecendo conexão');
              
              // Garantir que o método está registrado
              localStorage.setItem('auth_method', 'oauth');
              
              // Usar o token OAuth para conexão
              if (oauthToken) {
                derivToken = oauthToken;
                
                // Atualizar status para mostrar que estamos usando OAuth
                const statusIndicator = document.getElementById('status-indicator');
                if (statusIndicator) {
                  statusIndicator.classList.add('oauth-auth');
                }
                
                // Tentar conectar com token OAuth
                setTimeout(connectWebSocket, 1000);
              } else {
                console.error('Token OAuth não encontrado, mas método OAuth selecionado');
              }
            }
          }
        })
        .catch(error => {
          console.error('Erro ao verificar autenticação:', error);
          console.log('Continuando com acesso ao dashboard mesmo após erro de autenticação');
          // Inicializar token de desenvolvimento para testes
          derivToken = "XyeYPSAEjMeznXZ";
          setTimeout(connectWebSocket, 1000);
        });
        
      function initConnectionPage() {
        // Elementos da página de conexão
        const connectionNavItem = document.getElementById('connection-nav-item');
        const connectionPage = document.getElementById('connection-page');
        const closeConnectionPage = document.getElementById('close-connection-page');
        
        // Botões de ação da página de conexão
        const connConnectBtn = document.getElementById('conn-connect-btn');
        const connOauthBtn = document.getElementById('conn-oauth-btn');
        const connDisconnectBtn = document.getElementById('conn-disconnect-btn');
        
        // Substituir definição de startOAuthFlow para usar auth-utils centralizado
        window.startOAuthFlow = function() {
          console.log('Função startOAuthFlow invocada, redirecionando para versão centralizada');
          window.authUtils.startOAuthFlow();
        };
        const connRefreshBalanceBtn = document.getElementById('conn-refresh-balance-btn');
        
        // Elementos de status da página de conexão
        const connStatusIndicator = document.getElementById('conn-status-indicator');
        const connStatusText = document.getElementById('conn-status-text');
        const connStatusMessage = document.getElementById('conn-status-message');
        
        // Elementos de informações da conta na página de conexão
        const connAccountId = document.getElementById('conn-account-id');
        const connAccountName = document.getElementById('conn-account-name');
        const connAccountType = document.getElementById('conn-account-type');
        const connAccountBalance = document.getElementById('conn-account-balance');
        const connAccountsList = document.getElementById('conn-accounts-list');
        const connAccountsCount = document.getElementById('conn-accounts-count');
        const connAccountSelector = document.getElementById('conn-account-selector');
        
        // Abrir página de conexão quando clicar no item de navegação
        connectionNavItem.addEventListener('click', function() {
          connectionPage.style.display = 'flex';
          
          // Forçar inicialização dos dados da página de conexão
          updateConnectionPageData();
          
          // Forçar atualização das contas diretamente
          console.log('Abrindo página de conexão, forçando exibição de contas...');
          
          // Se temos contas no localStorage, exibir imediatamente
          try {
            // Combinar contas da API e OAuth
            let accounts = [];
            
            // Obter contas da API
            const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
            if (apiAccountsJson) {
              const apiAccounts = JSON.parse(apiAccountsJson);
              accounts = [...apiAccounts];
              console.log('Contas encontradas no localStorage (API):', apiAccounts.length);
            }
            
            // Obter contas do OAuth
            const oauthAccountsJson = localStorage.getItem('deriv_accounts');
            if (oauthAccountsJson) {
              const oauthAccounts = JSON.parse(oauthAccountsJson);
              
              // Adicionar apenas contas OAuth que não existem na lista da API
              oauthAccounts.forEach(oauthAccount => {
                if (!accounts.some(account => account.loginid === oauthAccount.loginid)) {
                  accounts.push(oauthAccount);
                }
              });
              
              console.log('Total de contas após adicionar OAuth:', accounts.length);
            }
            
            // Se temos contas, atualizar a interface
            if (accounts.length > 0) {
              console.log('Contas disponíveis para exibição:', accounts);
              
              // Criar ou atualizar a lista de contas
              const connAccountsList = document.getElementById('conn-accounts-list');
              if (connAccountsList) {
                // Limpar a lista atual
                connAccountsList.innerHTML = '';
                
                // Obter o ID da conta atual
                const currentAccountId = document.getElementById('account-id').textContent;
                
                // Atualizar o contador de contas
                const connAccountsCount = document.getElementById('conn-accounts-count');
                if (connAccountsCount) {
                  connAccountsCount.textContent = `${accounts.length} conta${accounts.length !== 1 ? 's' : ''}`;
                }
                
                // Adicionar cada conta à lista
                accounts.forEach(account => {
                  // Criar elemento visual da conta
                  const accountItem = document.createElement('div');
                  accountItem.className = 'account-item';
                  
                  // Adicionar classe 'selected' se esta for a conta atual
                  if (account.loginid === currentAccountId) {
                    accountItem.classList.add('selected', 'active');
                  }
                  
                  // Adicionar ID da conta como atributo de dados
                  accountItem.dataset.accountId = account.loginid;
                  
                  // Determinar o tipo de conta (virtual/demo ou real)
                  const accountType = account.is_virtual ? 'Demo' : 'Real';
                  const accountTypeClass = account.is_virtual ? 'demo' : 'real';
                  
                  // Ícone específico para o tipo de conta
                  const accountIcon = account.is_virtual ? 
                    '<i class="fas fa-flask" title="Conta de demonstração"></i>' : 
                    '<i class="fas fa-money-bill-wave" title="Conta real"></i>';
                    
                  // Estrutura interna do item de conta
                  accountItem.innerHTML = `
                    <div class="account-item-info">
                      <div class="account-item-id">
                        ${accountIcon} ${account.loginid}
                      </div>
                      <div class="account-item-type account-type-${accountTypeClass}">
                        ${accountType}
                      </div>
                    </div>
                    <div class="account-item-details">
                      <div class="account-item-currency">${account.currency || ''}</div>
                      <div class="account-item-action">
                        <button class="account-select-btn" title="Selecionar esta conta">
                          <i class="fas fa-check-circle"></i>
                        </button>
                      </div>
                    </div>
                  `;
                  
                  // Adicionar evento de clique para troca de conta
                  accountItem.addEventListener('click', function() {
                    // Indicar visualmente que está trocando de conta
                    const statusMessage = document.getElementById('conn-status-message');
                    if (statusMessage) {
                      statusMessage.textContent = `Trocando para a conta ${account.loginid}...`;
                      statusMessage.style.color = '#00e5b3';
                    }
                    
                    // Iniciar a troca de conta
                    console.log('Trocando para a conta:', account.loginid);
                    
                    // Processar troca de conta
                    switchAccount(account.loginid);
                    
                    // Atualizar seletor dropdown
                    if (connAccountSelector) {
                      connAccountSelector.value = account.loginid;
                    }
                    
                    // Destacar visualmente esta conta
                    connAccountsList.querySelectorAll('.account-item').forEach(item => {
                      item.classList.remove('selected', 'active');
                    });
                    this.classList.add('selected', 'active');
                    
                    // Feedback de sucesso após um breve delay
                    setTimeout(() => {
                      if (statusMessage) {
                        statusMessage.textContent = 'Conta alterada com sucesso!';
                        setTimeout(() => {
                          statusMessage.textContent = '';
                        }, 3000);
                      }
                    }, 1000);
                  });
                  
                  // Adicionar o item à lista
                  connAccountsList.appendChild(accountItem);
                });
                
                // Atualizar o seletor de contas
                const connAccountSelector = document.getElementById('conn-account-selector');
                if (connAccountSelector) {
                  connAccountSelector.innerHTML = '<option value="">Selecione uma conta</option>';
                  accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.loginid;
                    option.textContent = `${account.loginid} (${account.is_virtual ? 'Demo' : 'Real'}) - ${account.currency || ''}`;
                    
                    // Marcar a opção selecionada se for a conta atual
                    if (account.loginid === currentAccountId) {
                      option.selected = true;
                    }
                    
                    connAccountSelector.appendChild(option);
                  });
                }
                
                // Esconder a mensagem de contas vazias
                const emptyAccountsMessage = document.getElementById('conn-accounts-empty-message');
                if (emptyAccountsMessage) {
                  emptyAccountsMessage.style.display = 'none';
                }
              } else {
                console.error('Elemento conn-accounts-list não encontrado');
              }
            } else {
              console.log('Nenhuma conta encontrada no localStorage');
              
              // Mostrar mensagem de nenhuma conta
              const emptyAccountsMessage = document.getElementById('conn-accounts-empty-message');
              if (emptyAccountsMessage) {
                emptyAccountsMessage.style.display = 'flex';
              }
              
              // Atualizar contador para zero
              const connAccountsCount = document.getElementById('conn-accounts-count');
              if (connAccountsCount) {
                connAccountsCount.textContent = '0 contas';
              }
            }
          } catch (error) {
            console.error('Erro ao carregar contas do localStorage:', error);
            alert('Erro ao carregar contas: ' + error.message);
          }
        });
        
        // Fechar página de conexão
        closeConnectionPage.addEventListener('click', function() {
          connectionPage.style.display = 'none';
        });
        
        // Adicionar eventos aos botões da página de conexão
        if (connConnectBtn) connConnectBtn.addEventListener('click', connectWebSocket);
        if (connOauthBtn) connOauthBtn.addEventListener('click', function() {
          console.log('Botão OAuth na página de conexão clicado via initConnectionPage');
          window.authUtils.startOAuthFlow();
        });
        if (connDisconnectBtn) connDisconnectBtn.addEventListener('click', disconnectWebSocket);
        if (connRefreshBalanceBtn) connRefreshBalanceBtn.addEventListener('click', updateAccountBalance);
        
        // Adicionar evento ao botão de atualizar contas
        const refreshAccountsBtn = document.getElementById('conn-refresh-accounts-btn');
        if (refreshAccountsBtn) {
          refreshAccountsBtn.addEventListener('click', function() {
            // Mostrar animação de rotação no ícone
            const icon = this.querySelector('i');
            if (icon) {
              icon.classList.add('fa-spin');
            }
            
            // Mensagem de feedback
            const statusMessage = document.getElementById('conn-status-message');
            if (statusMessage) {
              statusMessage.textContent = 'Atualizando lista de contas...';
              statusMessage.style.color = '#00a5e3';
            }
            
            // Se estamos conectados, buscar a lista de contas novamente
            if (ws && ws.readyState === WebSocket.OPEN) {
              // Solicitar lista de contas
              const getAccountsRequest = {
                authorize: derivToken,
                account_list: 1
              };
              ws.send(JSON.stringify(getAccountsRequest));
              
              // Adicionar timeout para feedback
              setTimeout(() => {
                if (icon) {
                  icon.classList.remove('fa-spin');
                }
                
                if (statusMessage) {
                  statusMessage.textContent = 'Lista de contas atualizada!';
                  setTimeout(() => {
                    statusMessage.textContent = '';
                  }, 3000);
                }
              }, 1500);
            } else {
              // Se não estamos conectados, tentar obter as contas do localStorage
              try {
                const accounts = [];
                
                // Obter contas da API
                const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
                if (apiAccountsJson) {
                  const apiAccounts = JSON.parse(apiAccountsJson);
                  accounts.push(...apiAccounts);
                }
                
                // Obter contas do OAuth
                const oauthAccountsJson = localStorage.getItem('deriv_accounts');
                if (oauthAccountsJson) {
                  const oauthAccounts = JSON.parse(oauthAccountsJson);
                  oauthAccounts.forEach(oauthAccount => {
                    if (!accounts.some(account => account.loginid === oauthAccount.loginid)) {
                      accounts.push(oauthAccount);
                    }
                  });
                }
                
                // Atualizar a interface com as contas encontradas
                if (accounts.length > 0) {
                  connectionNavItem.click();
                }
                
                // Remover animação e mostrar mensagem
                if (icon) {
                  icon.classList.remove('fa-spin');
                }
                
                if (statusMessage) {
                  statusMessage.textContent = accounts.length > 0 ? 
                    'Lista de contas atualizada!' : 
                    'Nenhuma conta encontrada. Conecte-se primeiro.';
                  
                  setTimeout(() => {
                    statusMessage.textContent = '';
                  }, 3000);
                }
              } catch (error) {
                console.error('Erro ao atualizar contas:', error);
                
                // Remover animação e mostrar erro
                if (icon) {
                  icon.classList.remove('fa-spin');
                }
                
                if (statusMessage) {
                  statusMessage.textContent = 'Erro ao atualizar contas: ' + error.message;
                  statusMessage.style.color = '#ff6b6b';
                  
                  setTimeout(() => {
                    statusMessage.textContent = '';
                  }, 5000);
                }
              }
            }
          });
        }
        
        // Adicionar evento ao botão de depuração
        const debugButton = document.getElementById('conn-debug-button');
        if (debugButton) {
          debugButton.addEventListener('click', function() {
            try {
              // Verificar contas no localStorage
              const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
              const oauthAccountsJson = localStorage.getItem('deriv_accounts');
              
              let apiAccounts = [];
              let oauthAccounts = [];
              
              if (apiAccountsJson) {
                apiAccounts = JSON.parse(apiAccountsJson);
              }
              
              if (oauthAccountsJson) {
                oauthAccounts = JSON.parse(oauthAccountsJson);
              }
              
              // Mostrar mensagem de status
              let message = '';
              
              if (apiAccounts.length > 0) {
                message += `Contas da API (${apiAccounts.length}):\n`;
                apiAccounts.forEach(account => {
                  message += `- ${account.loginid} (${account.is_virtual ? 'Demo' : 'Real'})\n`;
                });
              } else {
                message += 'Nenhuma conta da API encontrada.\n';
              }
              
              message += '\n';
              
              if (oauthAccounts.length > 0) {
                message += `Contas OAuth (${oauthAccounts.length}):\n`;
                oauthAccounts.forEach(account => {
                  message += `- ${account.loginid} (${account.is_virtual ? 'Demo' : 'Real'})\n`;
                });
              } else {
                message += 'Nenhuma conta OAuth encontrada.\n';
              }
              
              // Mostrar todas as contas disponíveis
              alert(message);
              
              // Forçar atualização da lista
              if (apiAccounts.length > 0 || oauthAccounts.length > 0) {
                // Criar lista de contas combinada
                const allAccounts = [...apiAccounts];
                
                // Adicionar contas OAuth que não estão na lista da API
                oauthAccounts.forEach(oauthAccount => {
                  if (!allAccounts.some(account => account.loginid === oauthAccount.loginid)) {
                    allAccounts.push(oauthAccount);
                  }
                });
                
                // Forçar exibição
                const connAccountsList = document.getElementById('conn-accounts-list');
                const emptyMessage = document.getElementById('conn-accounts-empty-message');
                
                if (connAccountsList && emptyMessage) {
                  // Esconder mensagem vazia
                  emptyMessage.style.display = 'none';
                  
                  // Limpar lista atual
                  connAccountsList.innerHTML = '';
                  
                  // Adicionar cada conta à lista
                  allAccounts.forEach(account => {
                    const accountItem = document.createElement('div');
                    accountItem.className = 'account-item';
                    accountItem.dataset.accountId = account.loginid;
                    
                    const accountType = account.is_virtual ? 'Demo' : 'Real';
                    accountItem.innerHTML = `
                      <div class="account-item-info">
                        <div class="account-item-id">${account.loginid}</div>
                        <div class="account-item-type">${accountType}</div>
                      </div>
                      <div class="account-item-currency">${account.currency || ''}</div>
                    `;
                    
                    // Adicionar evento de clique
                    accountItem.addEventListener('click', function() {
                      switchAccount(account.loginid);
                    });
                    
                    connAccountsList.appendChild(accountItem);
                  });
                  
                  // Atualizar contador
                  const connAccountsCount = document.getElementById('conn-accounts-count');
                  if (connAccountsCount) {
                    connAccountsCount.textContent = `${allAccounts.length} conta${allAccounts.length !== 1 ? 's' : ''}`;
                  }
                }
              }
            } catch (error) {
              console.error('Erro ao depurar contas:', error);
              alert('Erro ao depurar contas: ' + error.message);
            }
          });
        }
        
        // Atualizar dados da página de conexão
        function updateConnectionPageData() {
          // Atualizar status de conexão
          updateConnectionPageStatus();
          
          // Atualizar informações da conta
          updateConnectionPageAccount();
        }
        
        // Atualizar status de conexão na página de conexão
        function updateConnectionPageStatus() {
          const mainStatus = document.getElementById('status-indicator');
          const mainStatusText = document.getElementById('connection-status');
          const mainStatusMessage = document.getElementById('connection-message');
          const connStatusIndicator = document.getElementById('conn-status-indicator');
          
          if (mainStatus && connStatusIndicator) {
            connStatusIndicator.className = mainStatus.className;
          }
          
          const connStatusText = document.getElementById('conn-status-text');
          if (mainStatusText && connStatusText) {
            connStatusText.textContent = mainStatusText.textContent;
          }
          
          if (mainStatusMessage && connStatusMessage) {
            connStatusMessage.textContent = mainStatusMessage.textContent;
          }
          
          // Atualizar visibilidade dos botões
          if (connectBtn && connConnectBtn) {
            connConnectBtn.style.display = connectBtn.style.display;
          }
          
          if (oauthBtn && connOauthBtn) {
            connOauthBtn.style.display = oauthBtn.style.display;
          }
          
          if (disconnectBtn && connDisconnectBtn) {
            connDisconnectBtn.style.display = disconnectBtn.style.display;
          }
        }
        
        // Atualizar informações da conta na página de conexão
        function updateConnectionPageAccount() {
          // Exibir ou ocultar o bloco de informações da conta com base na conexão
          const accountInfoCard = document.getElementById('account-info');
          const accountInfoDisplay = accountInfoCard ? accountInfoCard.style.display : 'none';
          
          // Verificar se há conta conectada
          const isConnected = accountInfoDisplay !== 'none';
          
          // Sempre mostrar a seção de contas disponíveis
          const connAccountsSection = document.getElementById('conn-accounts-section');
          if (connAccountsSection) {
            connAccountsSection.style.display = 'block';
          }
          
          // Mostrar ou esconder informações da conta na tela de conexão
          const connAccountInfo = document.getElementById('conn-account-info');
          if (connAccountInfo) {
            connAccountInfo.style.display = isConnected ? 'block' : 'none';
          }
          
          // Mostrar ou ocultar a mensagem de contas vazias
          const emptyMessage = document.getElementById('conn-accounts-empty-message');
          if (emptyMessage) {
            emptyMessage.style.display = isConnected ? 'none' : 'flex';
          }
          
          // Mostrar ou esconder o seletor de contas
          const accountSelectorWrapper = connAccountsSection.querySelector('.account-selector-wrapper');
          if (accountSelectorWrapper) {
            accountSelectorWrapper.style.display = isConnected ? 'block' : 'none';
          }
          
          // Copiar valores do account info para a página de conexão quando conectado
          if (isConnected) {
            // Obter o ID da conta atual
            const currentAccountId = accountId ? accountId.textContent : '';
            
            // Atualizar os campos básicos
            if (accountId && connAccountId) {
              connAccountId.textContent = accountId.textContent;
            }
            
            if (accountName && connAccountName) {
              connAccountName.textContent = accountName.textContent;
            }
            
            if (accountType && connAccountType) {
              const accountTypeText = accountType.textContent;
              connAccountType.textContent = accountTypeText;
              
              // Adicionar classe para estilização diferente baseada no tipo de conta
              if (accountTypeText.includes('Demo')) {
                connAccountType.classList.add('badge-demo');
                connAccountType.classList.remove('badge-real');
              } else {
                connAccountType.classList.add('badge-real');
                connAccountType.classList.remove('badge-demo');
              }
            }
            
            if (accountBalance && connAccountBalance) {
              connAccountBalance.textContent = accountBalance.textContent;
            }
            
            // Atualizar campos adicionais
            const connAccountCurrency = document.getElementById('conn-account-currency');
            const connAuthMethod = document.getElementById('conn-auth-method');
            
            // Obter informações detalhadas da conta
            const accountDetails = getAccountDetails(currentAccountId);
            
            if (accountDetails && connAccountCurrency) {
              connAccountCurrency.textContent = accountDetails.currency || 'USD';
            }
            
            if (connAuthMethod) {
              connAuthMethod.textContent = getAuthMethod();
            }
            
            // Atualizar lista de contas
            updateConnectionPageAccountsList();
            
            // Destacar a conta atual na lista
            const accountItems = document.querySelectorAll('.account-item');
            accountItems.forEach(item => {
              if (item.dataset.accountId === currentAccountId) {
                item.classList.add('selected');
              } else {
                item.classList.remove('selected');
              }
            });
            
            // Log para depuração
            console.log('Atualizando seção de contas disponíveis');
            const mainAccountsList = document.getElementById('accounts-list');
            const connAccountsList = document.getElementById('conn-accounts-list');
            if (mainAccountsList) console.log('Lista principal tem', mainAccountsList.children.length, 'contas');
            if (connAccountsList) console.log('Lista de conexão tem', connAccountsList.children.length, 'contas');
          }
        }
        
        // Atualizar lista de contas na página de conexão
        function updateConnectionPageAccountsList() {
          const mainAccountsList = document.getElementById('accounts-list');
          const mainAccountsCount = document.getElementById('accounts-count');
          const connAccountsList = document.getElementById('conn-accounts-list');
          const connAccountsCount = document.getElementById('conn-accounts-count');
          const connAccountSelector = document.getElementById('conn-account-selector');
          
          // Sempre mostrar a seção de contas disponíveis
          const accountsSection = document.getElementById('conn-accounts-section');
          if (accountsSection) {
            accountsSection.style.display = 'block';
          }
          
          // Esconder a mensagem de contas vazias
          const emptyAccountsMessage = document.getElementById('conn-accounts-empty-message');
          if (emptyAccountsMessage) {
            emptyAccountsMessage.style.display = 'none';
          }
          
          console.log('Função updateConnectionPageAccountsList chamada');
          
          // Obter o ID da conta atual para destacá-la na lista
          const currentAccountId = document.getElementById('account-id') ? 
            document.getElementById('account-id').textContent : '';
          
          // Se não há lista principal, tentar obter a lista de contas do localStorage
          if (!mainAccountsList || mainAccountsList.children.length === 0) {
            try {
              // Tentar obter contas da API
              let accounts = [];
              const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
              if (apiAccountsJson) {
                accounts = JSON.parse(apiAccountsJson);
              }
              
              // Se não temos contas da API, tentar obter contas do OAuth
              if (accounts.length === 0) {
                const oauthAccountsJson = localStorage.getItem('deriv_accounts');
                if (oauthAccountsJson) {
                  accounts = JSON.parse(oauthAccountsJson);
                }
              }
              
              console.log('Contas obtidas do localStorage:', accounts.length);
              
              if (accounts.length > 0 && connAccountsList) {
                connAccountsList.innerHTML = '';
                // Criar itens da lista manualmente
                accounts.forEach(account => {
                  const accountItem = document.createElement('div');
                  accountItem.className = 'account-item';
                  if (account.loginid === currentAccountId) {
                    accountItem.className += ' selected';
                  }
                  accountItem.dataset.accountId = account.loginid;
                  
                  const accountType = account.is_virtual ? 'Demo' : 'Real';
                  const accountTypeClass = account.is_virtual ? 'demo' : 'real';
                  
                  // Adicionar ícone com base no tipo de conta
                  const accountIcon = account.is_virtual ? 
                    '<i class="fas fa-flask" title="Conta de demonstração"></i>' : 
                    '<i class="fas fa-money-bill-wave" title="Conta real"></i>';
                    
                  accountItem.innerHTML = `
                    <div class="account-item-info">
                      <div class="account-item-id">
                        ${accountIcon} ${account.loginid}
                      </div>
                      <div class="account-item-type account-type-${accountTypeClass}">
                        ${accountType}
                      </div>
                    </div>
                    <div class="account-item-details">
                      <div class="account-item-currency">${account.currency || ''}</div>
                      <div class="account-item-action">
                        <button class="account-select-btn" title="Selecionar esta conta">
                          <i class="fas fa-check-circle"></i>
                        </button>
                      </div>
                    </div>
                  `;
                  
                  // Adicionar evento de clique
                  accountItem.addEventListener('click', function() {
                    // Remover classe selected de todos os itens
                    connAccountsList.querySelectorAll('.account-item').forEach(item => {
                      item.classList.remove('selected');
                    });
                    
                    // Adicionar classe selected a este item
                    this.classList.add('selected');
                    
                    // Atualizar o seletor de contas
                    if (connAccountSelector) {
                      connAccountSelector.value = account.loginid;
                    }
                  });
                  
                  // Adicionar evento de clique para o botão de seleção
                  accountItem.querySelector('.account-select-btn').addEventListener('click', function(e) {
                    e.stopPropagation(); // Evita que o evento de clique se propague para o item pai
                    switchAccount(account.loginid);
                  });
                  
                  connAccountsList.appendChild(accountItem);
                });
                
                // Atualizar contador
                if (connAccountsCount) {
                  connAccountsCount.textContent = `${accounts.length} conta${accounts.length !== 1 ? 's' : ''}`;
                }
                
                // Atualizar selector manualmente
                if (connAccountSelector) {
                  connAccountSelector.innerHTML = '<option value="">Selecione uma conta</option>';
                  accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.loginid;
                    option.textContent = `${account.loginid} (${account.is_virtual ? 'Demo' : 'Real'}) - ${account.currency || ''}`;
                    // Marcar a opção selecionada se for a conta atual
                    if (account.loginid === currentAccountId) {
                      option.selected = true;
                    }
                    connAccountSelector.appendChild(option);
                  });
                  
                  // Adicionar evento ao botão de confirmar troca de conta
                  const connSwitchAccountBtn = document.getElementById('conn-switch-account-btn');
                  if (connSwitchAccountBtn) {
                    // Remover eventos anteriores
                    const newBtn = connSwitchAccountBtn.cloneNode(true);
                    connSwitchAccountBtn.parentNode.replaceChild(newBtn, connSwitchAccountBtn);
                    
                    // Adicionar novo evento
                    newBtn.addEventListener('click', function() {
                      const selectedAccount = connAccountSelector.value;
                      if (selectedAccount) {
                        // Atualizar a interface para refletir a conta selecionada
                        connAccountsList.querySelectorAll('.account-item').forEach(item => {
                          item.classList.remove('selected');
                          if (item.dataset.accountId === selectedAccount) {
                            item.classList.add('selected');
                          }
                        });
                        
                        // Trocar de conta
                        switchAccount(selectedAccount);
                      } else {
                        alert('Por favor, selecione uma conta para trocar.');
                      }
                    });
                  }
                }
                
                // Adicionar evento ao botão de detalhes da conta
                const accountDetailsBtn = document.getElementById('conn-account-details-btn');
                if (accountDetailsBtn) {
                  accountDetailsBtn.addEventListener('click', function() {
                    const accountId = document.getElementById('conn-account-id').textContent;
                    if (accountId && accountId !== '-') {
                      // Exibir um alerta com informações detalhadas da conta
                      const accountInfo = getAccountDetails(accountId);
                      if (accountInfo) {
                        let detailsMessage = `Detalhes da Conta ${accountId}\n\n`;
                        detailsMessage += `ID: ${accountInfo.loginid}\n`;
                        detailsMessage += `Tipo: ${accountInfo.is_virtual ? 'Demo' : 'Real'}\n`;
                        detailsMessage += `Moeda: ${accountInfo.currency || 'N/A'}\n`;
                        detailsMessage += `Saldo: ${accountInfo.balance || 'N/A'}\n`;
                        detailsMessage += `Email: ${accountInfo.email || 'N/A'}\n`;
                        detailsMessage += `Método de Login: ${getAuthMethod()}\n`;
                        
                        alert(detailsMessage);
                      } else {
                        alert('Não foi possível encontrar detalhes para esta conta.');
                      }
                    } else {
                      alert('Nenhuma conta selecionada.');
                    }
                  });
                }
                
                return; // Já atualizamos, não precisa continuar
              } else {
                // Se não temos contas, mostrar a mensagem de contas vazias
                if (emptyAccountsMessage) {
                  emptyAccountsMessage.style.display = 'flex';
                }
                if (connAccountsCount) {
                  connAccountsCount.textContent = '0 contas';
                }
              }
            } catch (error) {
              console.error('Erro ao obter contas do localStorage:', error);
              // Mostrar erro no console do navegador
              alert('Erro ao carregar contas: ' + error.message);
            }
          }
          
          // Método original (copia da lista principal se existir)
          if (mainAccountsList && connAccountsList) {
            connAccountsList.innerHTML = mainAccountsList.innerHTML;
            
            // Adicionar eventos aos itens da lista
            const accountItems = connAccountsList.querySelectorAll('.account-item');
            accountItems.forEach(item => {
              // Adicionar classe selected se for a conta atual
              if (item.dataset.accountId === currentAccountId) {
                item.classList.add('selected');
              }
              
              item.addEventListener('click', function() {
                // Remover classe selected de todos os itens
                connAccountsList.querySelectorAll('.account-item').forEach(i => {
                  i.classList.remove('selected');
                });
                
                // Adicionar classe selected a este item
                this.classList.add('selected');
                
                // Atualizar o seletor
                if (connAccountSelector) {
                  connAccountSelector.value = this.dataset.accountId;
                }
              });
              
              // Adicionar evento de clique para o botão de seleção (se existir)
              const selectBtn = item.querySelector('.account-select-btn');
              if (selectBtn) {
                selectBtn.addEventListener('click', function(e) {
                  e.stopPropagation();
                  switchAccount(item.dataset.accountId);
                });
              }
            });
          }
          
          if (mainAccountsCount && connAccountsCount) {
            connAccountsCount.textContent = mainAccountsCount.textContent;
          }
          
          // Sincronizar seletor de contas
          const mainAccountSelector = document.getElementById('account-selector');
          if (mainAccountSelector && connAccountSelector) {
            connAccountSelector.innerHTML = mainAccountSelector.innerHTML;
            connAccountSelector.value = mainAccountSelector.value;
            
            // Adicionar evento ao botão de confirmar troca de conta
            const connSwitchAccountBtn = document.getElementById('conn-switch-account-btn');
            if (connSwitchAccountBtn) {
              connSwitchAccountBtn.addEventListener('click', function() {
                const selectedAccount = connAccountSelector.value;
                if (selectedAccount) {
                  // Atualizar a interface para refletir a conta selecionada
                  connAccountsList.querySelectorAll('.account-item').forEach(item => {
                    item.classList.remove('selected');
                    if (item.dataset.accountId === selectedAccount) {
                      item.classList.add('selected');
                    }
                  });
                  
                  switchAccount(selectedAccount);
                  // Sincronizar com o seletor principal
                  if (mainAccountSelector) {
                    mainAccountSelector.value = selectedAccount;
                  }
                } else {
                  alert('Por favor, selecione uma conta para trocar.');
                }
              });
            }
          }
        }
        
        // Observar mudanças no status principal para atualizar a página de conexão
        const observer = new MutationObserver(function(mutations) {
          if (connectionPage.style.display === 'flex') {
            updateConnectionPageStatus();
          }
        });
        
        // Observar o status-indicator
        const statusIndicator = document.getElementById('status-indicator');
        if (statusIndicator) {
          observer.observe(statusIndicator, { attributes: true });
        }
        
        // Observar o connection-status
        const connectionStatusElement = document.getElementById('connection-status');
        if (connectionStatusElement) {
          observer.observe(connectionStatusElement, { childList: true });
        }
        
        // Observar mudanças nas informações da conta
        const accountObserver = new MutationObserver(function(mutations) {
          if (connectionPage.style.display === 'flex') {
            updateConnectionPageAccount();
          }
        });
        
        // Observar elementos da conta
        const accountElements = [
          document.getElementById('account-id'),
          document.getElementById('account-name'),
          document.getElementById('account-type'),
          document.getElementById('account-balance'),
          document.getElementById('accounts-list'),
          document.getElementById('accounts-count')
        ];
        
        accountElements.forEach(element => {
          if (element) {
            accountObserver.observe(element, { childList: true, subtree: true });
          }
        });
      }

      // Elementos da UI
      const connectBtn = document.getElementById('connect-btn');
      // Referências aos botões principais, usando nomes distintos para evitar conflitos
      const connectBtnMain = document.getElementById('connect-btn');
      const oauthBtnMain = document.getElementById('oauth-btn');
      const disconnectBtnMain = document.getElementById('disconnect-btn');
      const statusIndicator = document.getElementById('status-indicator');
      const connectionStatus = document.getElementById('connection-status');
      const connectionMessage = document.getElementById('connection-message');
      const accountInfoCard = document.getElementById('account-info');
      const accountId = document.getElementById('account-id');
      const accountName = document.getElementById('account-name');
      const accountType = document.getElementById('account-type');
      const accountBalance = document.getElementById('account-balance');
      const resetStatsBtn = document.getElementById('reset-stats-btn');

      // WebSocket
      let ws = null;
      
      // Função para obter o token ativo (API ou OAuth) - centralizada para garantir consistência
      function getActiveToken() {
        // Primeiro tenta o token OAuth, depois o token API direto
        const oauthToken = localStorage.getItem('deriv_oauth_token');
        const apiToken = localStorage.getItem('deriv_api_token') || localStorage.getItem('deriv_token');
        
        // Registrar no console qual token está sendo usado
        if (oauthToken) {
          console.log('Usando token OAuth para conexão');
          return oauthToken;
        }
        
        if (apiToken) {
          console.log('Usando token API para conexão');
          return apiToken;
        }
        
        console.warn('Nenhum token encontrado (OAuth ou API)');
        return "";
      }
      
      // Obter token atual usando a função centralizada
      let derivToken = getActiveToken();
      
      // Verificar se há contas disponíveis do OAuth
      let availableAccounts = [];
      try {
        const accountsJson = localStorage.getItem('deriv_accounts');
        if (accountsJson) {
          availableAccounts = JSON.parse(accountsJson);
          console.log('Contas disponíveis carregadas:', availableAccounts.length);
        }
      } catch (error) {
        console.error('Erro ao carregar contas disponíveis:', error);
      }
      
      // Configurações OAuth
      const clientId = "71555"; // App ID atualizado da Deriv
      const oauthUrl = "https://oauth.deriv.com/oauth2/authorize";
      const redirectUri = window.location.origin + "/login.html";

      // Conectar ao WebSocket - usando variáveis globais
      if (typeof connectBtn !== 'undefined') connectBtn.addEventListener('click', connectWebSocket);
      if (typeof oauthBtnMain !== 'undefined') oauthBtnMain.addEventListener('click', function() {
        console.log('Botão OAuth clicado - usando funções centralizadas');
        if (window.authUtils && typeof window.authUtils.startOAuthFlow === 'function') {
          window.authUtils.startOAuthFlow();
        } else {
          console.warn('Função authUtils.startOAuthFlow não encontrada, usando método padrão');
          // URL de redirecionamento explicita para OAuth
          const redirectUri = encodeURIComponent(window.location.origin + '/oauth-redirect.html');
          window.location.href = `https://oauth.deriv.com/oauth2/authorize?app_id=71555&redirect_uri=${redirectUri}`;
        }
      });
      if (typeof disconnectButton !== 'undefined') disconnectButton.addEventListener('click', disconnectWebSocket);
      
      // Botão de atualizar saldo
      const refreshBalanceBtn = document.getElementById('refresh-balance-btn');
      if (refreshBalanceBtn) {
        refreshBalanceBtn.addEventListener('click', updateAccountBalance);
      }
      
      // Verificar se há um token OAuth no localStorage
      window.addEventListener('load', checkAuthentication);

      // Função atualizada para usar auth-utils
      function checkAuthentication() {
        console.log('Verificando autenticação...');
        
        // Verificar parâmetros OAuth na URL
        const urlParams = new URLSearchParams(window.location.search);
        const isOAuthRedirect = urlParams.get('oauth') === 'true';
        const oauthAuthMethod = urlParams.get('auth_method') === 'oauth';
        const accountCount = urlParams.get('account_count');
        
        if (isOAuthRedirect || oauthAuthMethod) {
          console.log('Autenticação OAuth detectada via URL');
          // Verificar o localStorage para informações adicionais
          const oauthSuccess = localStorage.getItem('oauth_auth_success') === 'true';
          const oauthTime = localStorage.getItem('oauth_auth_time');
          const oauthAccountCount = localStorage.getItem('oauth_account_count');
          
          console.log('Detalhes da autenticação OAuth:');
          console.log(`- Sucesso: ${oauthSuccess}`);
          console.log(`- Horário: ${oauthTime || 'não registrado'}`);
          console.log(`- Contas disponíveis: ${oauthAccountCount || accountCount || 'desconhecido'}`);
          
          // Registrar explicitamente como método OAuth
          localStorage.setItem('auth_method', 'oauth');
        }
        
        // Verificar se a biblioteca auth-utils foi carregada
        if (window.authUtils && typeof window.authUtils.isAuthenticated === 'function') {
          // Usar a função centralizada para verificar autenticação
          if (window.authUtils.isAuthenticated()) {
            // Se estiver autenticado, usar a função centralizada para obter o token
            derivToken = getActiveToken();
            console.log('Token ativo obtido através de função centralizada');
            
            if (derivToken) {
              console.log('Token encontrado. Iniciando conexão...');
              
              // Carregar contas disponíveis do localStorage (processadas pelo oauth-redirect.html)
              const savedAccounts = localStorage.getItem('deriv_accounts');
              if (savedAccounts) {
                try {
                  availableAccounts = JSON.parse(savedAccounts);
                  console.log(`${availableAccounts.length} contas carregadas do localStorage`);
                } catch (error) {
                  console.error('Erro ao carregar contas do localStorage:', error);
                  availableAccounts = [];
                }
              }
              
              // Tentar conectar ao WebSocket
              connectWebSocket();
            } else {
              console.warn('Nenhum token ativo encontrado apesar de autenticado');
              // Verificar diretamente no localStorage
              const oauthToken = localStorage.getItem('deriv_oauth_token');
              const apiToken = localStorage.getItem('deriv_api_token') || localStorage.getItem('deriv_token');
              
              if (oauthToken || apiToken) {
                derivToken = oauthToken || apiToken;
                console.log('Token recuperado diretamente do localStorage:', oauthToken ? 'OAuth' : 'API');
                connectWebSocket();
              } else {
                console.warn('Token não encontrado. Usando token de desenvolvimento.');
                // Usar token de desenvolvimento para fins de teste
                derivToken = "XyeYPSAEjMeznXZ";
                connectWebSocket();
              }
            }
          } else {
            // Se não estiver autenticado, não redirecionar automaticamente
            console.log('Usuário não autenticado. Permitindo acesso ao dashboard para teste.');
            // Definir um token temporário para desenvolvimento
            derivToken = "XyeYPSAEjMeznXZ";
            // Continuar com a inicialização
            connectWebSocket();
          }
        } else {
          // Se auth-utils não estiver disponível, vamos verificar diretamente no localStorage
          console.warn('Biblioteca auth-utils não encontrada, verificando tokens diretamente');
          derivToken = getActiveToken();
          
          if (derivToken) {
            console.log('Token encontrado pela função getActiveToken. Iniciando conexão...');
            connectWebSocket();
          } else {
            console.log('Nenhum token encontrado. Usando token de desenvolvimento...');
            // Usar token de desenvolvimento para fins de teste
            derivToken = "XyeYPSAEjMeznXZ";
            console.log('Token de desenvolvimento definido. Iniciando conexão...');
            connectWebSocket();
          }
        }
      }

      function connectWebSocket(callback) {
        // Verificar limite de taxa para conexão WebSocket
        if (!Genius.RateLimiter.canSend('connect_websocket')) {
          console.log('Limite de taxa atingido para conexão WebSocket, agendando nova tentativa');
          return Genius.RateLimiter.scheduleRequest('connect_websocket', function() {
            connectWebSocket(callback);
          });
        }
        
        // Registrar que estamos fazendo uma conexão WebSocket
        Genius.RateLimiter.recordRequest('connect_websocket');
        
        // Verificar se temos um token
        if (!derivToken) {
          // Verificar se há um token de API salvo
          const savedToken = localStorage.getItem('deriv_api_token');
          
          if (savedToken) {
            // Usar token salvo
            console.log('Usando token salvo da API');
            derivToken = savedToken;
          } else {
            // Solicitar token ao usuário
            const userToken = prompt('Por favor, insira seu token da API Deriv:');
            
            if (!userToken) {
              alert('Nenhum token fornecido. A conexão não pode ser estabelecida.');
              return;
            }
            
            // Salvar e usar o token fornecido
            derivToken = userToken;
            localStorage.setItem('deriv_api_token', userToken);
            console.log('Token da API salvo com sucesso.');
          }
        }

        // Atualizar status para mostrar conexão em andamento
        document.querySelectorAll('.status-indicator').forEach(indicator => {
          indicator.classList.remove('status-disconnected', 'status-connected');
          indicator.classList.add('status-loading');
        });
        
        const connectionStatus = document.getElementById('connection-status');
        if (connectionStatus) {
          connectionStatus.textContent = 'Conectando...';
        }
        
        const connStatusText = document.getElementById('conn-status-text');
        if (connStatusText) {
          connStatusText.textContent = 'Conectando...';
        }
        
        // URL do WebSocket da Deriv (atualizada conforme documentação)
        // Usa o app_id 71555 conforme orientação oficial
        const wsUrl = 'wss://ws.derivws.com/websockets/v3?app_id=71555';
        
        // Conectar diretamente ao WebSocket da Deriv
        try {
          ws = new WebSocket(wsUrl);
          
          console.log('Tentando conectar ao WebSocket da Deriv:', wsUrl);
          
          // Configurar handlers
          ws.onopen = () => {
            console.log('WebSocket da Deriv conectado com sucesso');
            console.log('Estado atual do WebSocket:', ws.readyState);
            
            // Atualizar estado de conexão para "conectado" usando a função centralizada
            updateStatus('connected', 'Conexão estabelecida com sucesso');
            
            // DEBUG: Forçar atualização visual do status
            const statusIndicator = document.getElementById('status-indicator');
            if (statusIndicator) {
              statusIndicator.className = 'status-indicator status-connected';
              const connectionStatus = document.getElementById('connection-status');
              if (connectionStatus) connectionStatus.textContent = 'Conectado';
            }
            
            // Mostrar/ocultar botões apropriados
            // Usamos let em vez de const para evitar redeclaração de variáveis
            let btnConnect = document.getElementById('connect-btn');
            let btnDisconnect = document.getElementById('disconnect-btn');
            
            if (btnConnect) btnConnect.style.display = 'none';
            if (btnDisconnect) btnDisconnect.style.display = 'inline-block';
            
            const connConnectBtn = document.getElementById('conn-connect-btn');
            const connDisconnectBtn = document.getElementById('conn-disconnect-btn');
            
            if (connConnectBtn) connConnectBtn.style.display = 'none';
            if (connDisconnectBtn) connDisconnectBtn.style.display = 'inline-block';
            
            // Autenticar com token
            authorize();
          };
          
          ws.onmessage = (event) => {
            try {
              const response = JSON.parse(event.data);
              console.log('Resposta WebSocket recebida:', response);
              
              // Se é uma mensagem de status de conexão
              if (response.msg_type === 'connection_status') {
                updateStatus(response.status, response.message);
                return;
              }
              
              // Se é resposta da autorização
              if (response.authorize) {
                handleAuthorizeResponse(response);
                updateStatus('connected', 'Autenticado com sucesso');
                
                // Atualizar UI do seletor de contas quando a autorização for bem-sucedida
                const accountSelector = document.getElementById('account-selector');
                if (accountSelector) {
                  accountSelector.style.display = 'inline-block';
                  
                  // Mostrar valores reais nos elementos do seletor
                  const accountSelectorText = document.getElementById('account-selector-text');
                  const accountSelectorBalance = document.getElementById('account-selector-balance');
                  const accountSelectorType = document.getElementById('account-selector-type');
                  
                  if (accountSelectorText) {
                    accountSelectorText.textContent = response.authorize.loginid || '-';
                  }
                  
                  if (accountSelectorBalance) {
                    accountSelectorBalance.textContent = `${response.authorize.currency || ''} ${parseFloat(response.authorize.balance || 0).toFixed(2)}`;
                  }
                  
                  if (accountSelectorType) {
                    const isDemo = response.authorize.is_virtual;
                    accountSelectorType.textContent = isDemo ? 'Demo' : 'Real';
                    accountSelectorType.className = `account-type-badge ${isDemo ? 'account-type-demo' : 'account-type-real'}`;
                  }
                  
                  // Atualizar dropdown de contas
                  if (typeof populateAccountsSelector === 'function') {
                    populateAccountsSelector();
                  }
                }
                
                // Após autenticação bem-sucedida, solicitar dados do ativo
                console.log('Autenticação realizada. Solicitando dados do ativo...');
                subscribeToTicks('R_100');
                
                // Solicitar saldo da conta
                requestBalance();
                return;
              }
              
              // Se é resposta da lista de contas
              if (response.account_list) {
                handleAccountListResponse(response);
                return;
              }
              
              // Se é resposta de troca de conta
              if (response.switch_account) {
                handleSwitchAccountResponse(response);
                return;
              }
              
              // Se é resposta de saldo
              if (response.balance) {
                handleBalanceResponse(response);
                processBalanceResponse(response);
                return;
              }
              
              // Processar histórico de ticks
              if (response.history) {
                const prices = response.history.prices;
                updateCharts({ prices });
              }
              
              // Processar ticks em tempo real
              if (response.tick) {
                // Atualizar estatísticas de dígitos
                updateDigitStats(response.tick.quote.toString().slice(-1));
                
                // Atualizar gráficos ocasionalmente
                if (response.tick.count % 5 === 0) {
                  try {
                    // Solicitar histórico recente para atualizar gráficos
                    requestTicksHistory();
                  } catch (graphError) {
                    console.error('Erro ao atualizar gráfico:', graphError);
                  }
                }
              }
            } catch (error) {
              console.error('Erro ao processar mensagem:', error);
            }
          };
          
          ws.onclose = () => {
            console.log('WebSocket desconectado');
            updateStatus('disconnected', 'Desconectado');
            ws = null;
          };
          
          ws.onerror = (error) => {
            console.error('Erro no WebSocket:', error);
            updateStatus('error', 'Erro na conexão');
          };
        } catch (error) {
          console.error('Erro ao inicializar WebSocket:', error);
          updateStatus('error', 'Erro ao inicializar conexão');
        }
      }

      function disconnectWebSocket() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          // Cancelar qualquer assinatura ativa antes de fechar
          try {
            unsubscribeFromTicks();
            
            // Enviar um ping final como boa prática
            const pingRequest = { ping: 1 };
            ws.send(JSON.stringify(pingRequest));
            
            // Esperar um pouco para garantir que as mensagens foram enviadas
            setTimeout(() => {
              // Fechar a conexão de forma limpa
              console.log('Fechando conexão WebSocket...');
              ws.close(1000, 'Desconexão solicitada pelo usuário');
              ws = null;
              
              // Atualizar interface para refletir desconexão
              updateStatus('disconnected', 'Desconectado');
              hideAccountInfo();
              
              // Modificar a visibilidade dos botões de conexão
              // Usamos let em vez de const para evitar redeclaração de variáveis
              let btnConnect = document.getElementById('connect-btn');
              let btnDisconnect = document.getElementById('disconnect-btn');
              
              if (btnConnect) btnConnect.style.display = 'inline-block';
              if (btnDisconnect) btnDisconnect.style.display = 'none';
              
              const connConnectBtn = document.getElementById('conn-connect-btn');
              const connDisconnectBtn = document.getElementById('conn-disconnect-btn');
              
              if (connConnectBtn) connConnectBtn.style.display = 'inline-block';
              if (connDisconnectBtn) connDisconnectBtn.style.display = 'none';
            }, 500);
          } catch (error) {
            console.error('Erro ao desconectar:', error);
            // Mesmo com erro, tenta fechar a conexão
            if (ws) {
              try {
                ws.close();
              } catch (e) {
                console.error('Erro ao fechar WebSocket:', e);
              }
              ws = null;
            }
            
            // Atualizar interface para refletir desconexão
            updateStatus('disconnected', 'Desconectado');
            hideAccountInfo();
            
            // Modificar a visibilidade dos botões de conexão
            // Usamos let em vez de const para evitar redeclaração de variáveis
            let btnConnect = document.getElementById('connect-btn');
            let btnDisconnect = document.getElementById('disconnect-btn');
            
            if (btnConnect) btnConnect.style.display = 'inline-block';
            if (btnDisconnect) btnDisconnect.style.display = 'none';
            
            const connConnectBtn = document.getElementById('conn-connect-btn');
            const connDisconnectBtn = document.getElementById('conn-disconnect-btn');
            
            if (connConnectBtn) connConnectBtn.style.display = 'inline-block';
            if (connDisconnectBtn) connDisconnectBtn.style.display = 'none';
          }
        } else {
          console.log('WebSocket já está desconectado ou em processo de desconexão');
          updateStatus('disconnected', 'Desconectado');
          hideAccountInfo();
        }
      }

      function updateStatus(status, message) {
        // Obter as referências aos elementos - evita problemas com escopo variável
        const statusIndicator = document.getElementById('status-indicator');
        const connectionStatus = document.getElementById('connection-status');
        const connectionMessage = document.getElementById('connection-message');
        const btnConnect = document.getElementById('connect-btn');
        const btnOauth = document.getElementById('oauth-btn');
        const btnDisconnect = document.getElementById('disconnect-btn');
        
        // Elementos da página de conexão
        const connStatusIndicator = document.getElementById('conn-status-indicator');
        const connStatusText = document.getElementById('conn-status-text');
        const connStatusMessage = document.getElementById('conn-status-message');
        const connConnectBtn = document.getElementById('conn-connect-btn');
        const connOauthBtn = document.getElementById('conn-oauth-btn');
        const connDisconnectBtn = document.getElementById('conn-disconnect-btn');
        
        if (!statusIndicator && !connStatusIndicator) {
          console.error('Elementos de status não encontrados');
          return;
        }
        
        console.log(`Atualizando status para: ${status}, mensagem: ${message || 'nenhuma'}`);
        
        switch (status) {
          case 'connected':
            // Atualizar painel principal
            if (statusIndicator) {
              statusIndicator.className = 'status-indicator status-connected';
              connectionStatus.textContent = 'Conectado';
              if (connectionMessage) connectionMessage.textContent = message || '';
              if (btnConnect) btnConnect.style.display = 'none';
              if (btnOauth) btnOauth.style.display = 'none';
              if (btnDisconnect) btnDisconnect.style.display = 'inline-flex';
            }
            
            // Atualizar painel de conexão
            if (connStatusIndicator) {
              connStatusIndicator.className = 'status-indicator status-connected';
              if (connStatusText) connStatusText.textContent = 'Conectado';
              if (connStatusMessage) connStatusMessage.textContent = message || '';
              if (connConnectBtn) connConnectBtn.style.display = 'none';
              if (connOauthBtn) connOauthBtn.style.display = 'none';
              if (connDisconnectBtn) connDisconnectBtn.style.display = 'inline-block';
            }
            break;
            
          case 'connecting':
            // Atualizar painel principal
            if (statusIndicator) {
              statusIndicator.className = 'status-indicator';
              statusIndicator.style.backgroundColor = '#f39c12';
              connectionStatus.textContent = 'Conectando...';
              if (connectionMessage) connectionMessage.textContent = message || '';
            }
            
            // Atualizar painel de conexão
            if (connStatusIndicator) {
              connStatusIndicator.className = 'status-indicator';
              connStatusIndicator.style.backgroundColor = '#f39c12';
              if (connStatusText) connStatusText.textContent = 'Conectando...';
              if (connStatusMessage) connStatusMessage.textContent = message || '';
            }
            break;
            
          case 'disconnected':
            // Atualizar painel principal
            if (statusIndicator) {
              statusIndicator.className = 'status-indicator status-disconnected';
              connectionStatus.textContent = 'Desconectado';
              if (connectionMessage) connectionMessage.textContent = message || '';
              if (btnConnect) btnConnect.style.display = 'inline-flex';
              if (btnOauth) btnOauth.style.display = 'inline-flex';
              if (btnDisconnect) btnDisconnect.style.display = 'none';
            }
            
            // Atualizar painel de conexão
            if (connStatusIndicator) {
              connStatusIndicator.className = 'status-indicator status-disconnected';
              if (connStatusText) connStatusText.textContent = 'Desconectado';
              if (connStatusMessage) connStatusMessage.textContent = message || '';
              if (connConnectBtn) connConnectBtn.style.display = 'inline-block';
              if (connOauthBtn) connOauthBtn.style.display = 'inline-block';
              if (connDisconnectBtn) connDisconnectBtn.style.display = 'none';
            }
            break;
            
          case 'error':
            // Atualizar painel principal
            if (statusIndicator) {
              statusIndicator.className = 'status-indicator status-disconnected';
              connectionStatus.textContent = 'Erro';
              if (connectionMessage) connectionMessage.textContent = message || '';
              if (btnConnect) btnConnect.style.display = 'inline-flex';
              if (btnOauth) btnOauth.style.display = 'inline-flex';
              if (btnDisconnect) btnDisconnect.style.display = 'none';
            }
            
            // Atualizar painel de conexão
            if (connStatusIndicator) {
              connStatusIndicator.className = 'status-indicator status-disconnected';
              if (connStatusText) connStatusText.textContent = 'Erro';
              if (connStatusMessage) connStatusMessage.textContent = message || '';
              if (connConnectBtn) connConnectBtn.style.display = 'inline-block';
              if (connOauthBtn) connOauthBtn.style.display = 'inline-block';
              if (connDisconnectBtn) connDisconnectBtn.style.display = 'none';
            }
            break;
        }
      }

      function authorize() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.log('WebSocket não está aberto. Não é possível autorizar.');
          return;
        }
        
        // Verificar limite de taxa para autorização
        if (!Genius.RateLimiter.canSend('authorize')) {
          console.log('Limite de taxa atingido para autorização, agendando nova tentativa');
          return Genius.RateLimiter.scheduleRequest('authorize', function() {
            authorize();
          }, 100); // Reduzir tempo de espera para 100ms
        }
        
        // Registrar que estamos autorizando
        Genius.RateLimiter.recordRequest('authorize');
        
        // Atualizar indicador de status para mostrar processo de autorização
        document.querySelectorAll('.status-indicator').forEach(indicator => {
          indicator.classList.add('status-loading');
        });
        
        const statusMsg = document.getElementById('connection-status');
        if (statusMsg) {
          statusMsg.textContent = 'Autorizando...';
        }
        
        // Verificar se temos contas do OAuth armazenadas
        const oauthAccountsRaw = localStorage.getItem('deriv_accounts_oauth');
        if (oauthAccountsRaw) {
          try {
            // Tentar carregar as contas do OAuth
            const oauthAccounts = JSON.parse(oauthAccountsRaw);
            console.log(`Detectadas ${oauthAccounts.length} contas OAuth armazenadas`);
            
            if (oauthAccounts.length > 0) {
              // Definir modo MULTI para múltiplas contas
              if (oauthAccounts.length > 1) {
                console.log('Modo MULTI: autorização com várias contas OAuth');
                derivToken = 'MULTI';
                localStorage.setItem('deriv_token_mode', 'MULTI');
              }
              
              // Verificar se há um loginid ativo que deve ser usado
              const activeLoginId = localStorage.getItem('deriv_active_loginid');
              let selectedAccount = oauthAccounts[0]; // Padrão para a primeira conta
              
              // Se tivermos um loginid ativo, tentar encontrar essa conta
              if (activeLoginId) {
                const matchedAccount = oauthAccounts.find(acc => acc.loginid === activeLoginId);
                if (matchedAccount) {
                  console.log(`Usando conta ativa salva: ${activeLoginId}`);
                  selectedAccount = matchedAccount;
                }
              }
              
              const initialToken = selectedAccount.token;
              
              // Armazenar as informações da conta atual
              localStorage.setItem('current_account', selectedAccount.loginid);
              localStorage.setItem('deriv_active_loginid', selectedAccount.loginid);
              
              console.log(`Autorizando com a conta: ${selectedAccount.loginid}`);
              
              // Registrar que estamos enviando uma requisição de autorização
              Genius.RateLimiter.recordRequest('authorize');
              
              // Enviar o comando authorize com o token da conta selecionada usando nossa função de rate limiting
              const authRequest = {
                authorize: initialToken,
                req_id: Math.floor(Math.random() * 10000)
              };
              
              Genius.sendWSRequest(ws, authRequest, 'authorize');
              
              // Disponibilizar as contas para uso em todo o dashboard
              window.availableAccounts = oauthAccounts;
              
              return; // Sair da função para não executar o fluxo padrão
            }
          } catch (e) {
            console.error('Erro ao processar contas OAuth:', e);
          }
        }
        
        // Código original para coletar tokens (caso não tenha contas OAuth)
        // Coletar todos os tokens disponíveis (API e OAuth)
        const allTokens = collectAllTokens();
        
        // Filtrar tokens únicos para o modo MULTI
        let tokens = Array.from(new Set(allTokens)).slice(0, 25);
        
        console.log(`Coletados ${tokens.length} tokens únicos para autorização`);
        
        // Manter compatibilidade com o resto do código
        const additionalTokens = tokens.length > 1 ? tokens.slice(1) : [];
        
        // Configurar o objeto de requisição
        let request;
        
        // Registrar que estamos enviando uma requisição de autorização
        Genius.RateLimiter.recordRequest('authorize');
        
        // Verificar se temos múltiplos tokens
        if (tokens.length > 1) {
          // Configuração para múltiplos tokens (usando "MULTI" como valor do campo authorize)
          request = {
            authorize: "MULTI", // Valor específico para múltiplos tokens
            add_to_login_history: 1,
            tokens: tokens, // Usar a lista de tokens únicos coletados
            passthrough: {
              app_name: "Genius Tecnologic"
            },
            req_id: Math.floor(Math.random() * 1000) + 1
          };
          console.log(`Usando modo MULTI para autorização com ${tokens.length} tokens`);
        } else {
          // Configuração para token único
          request = {
            authorize: derivToken,
            add_to_login_history: 1,
            passthrough: {
              app_name: "Genius Tecnologic"
            },
            req_id: Math.floor(Math.random() * 1000) + 1
          };
        }
        
        // Usar nossa função de envio com limitação de taxa
        Genius.sendWSRequest(ws, request, 'authorize');
        console.log('Enviando requisição de autorização');
      }

      function handleAuthorizeResponse(response) {
        console.log('Resposta completa de autorização:', response);
        
        // Inicializar imediatamente o seletor de contas com os dados da resposta
        try {
          const authorizeData = response.authorize;
          
          // Verificar se temos dados válidos
          if (!authorizeData || !authorizeData.loginid) {
            console.error('Dados de autorização inválidos:', authorizeData);
            return;
          }
          
          // Obter elementos do seletor
          const accountSelector = document.getElementById('account-selector');
          const accountSelectorText = document.getElementById('account-selector-text');
          const accountSelectorBalance = document.getElementById('account-selector-balance');
          const accountSelectorType = document.getElementById('account-selector-type');
          
          if (!accountSelector || !accountSelectorText || !accountSelectorBalance || !accountSelectorType) {
            console.error('Elementos do seletor de contas não encontrados');
            return;
          }
          
          // Atualizar valores no seletor
          accountSelectorText.textContent = authorizeData.loginid;
          accountSelectorBalance.textContent = `${authorizeData.currency || ''} ${parseFloat(authorizeData.balance || 0).toFixed(2)}`;
          
          // Determinar se é conta demo ou real
          const isDemo = authorizeData.is_virtual;
          accountSelectorType.textContent = isDemo ? 'Demo' : 'Real';
          accountSelectorType.className = `account-type-badge ${isDemo ? 'account-type-demo' : 'account-type-real'}`;
          
          // Mostrar o seletor
          accountSelector.style.display = 'inline-block';
          
          console.log('Seletor de contas inicializado com dados de autorização:', authorizeData.loginid);
          
          // Atualizar dropdown de contas se possível
          if (typeof populateAccountsSelector === 'function') {
            setTimeout(populateAccountsSelector, 500);
          }
        } catch (error) {
          console.error('Erro ao inicializar seletor de contas:', error);
        }
        
        // Em modo MULTI, a resposta pode ter uma estrutura diferente
        const authorizeData = response.authorize;
        
        if (!authorizeData) {
          console.error('Dados de autorização inválidos');
          return;
        }
        
        // Forçar exibição dos detalhes completos da resposta para depuração
        console.log('Dados de autorização detalhados:', authorizeData);
        
        // Verificar se estamos usando múltiplos tokens (modo MULTI)
        const usingMultiTokens = Array.isArray(authorizeData.account_list) && 
                                authorizeData.account_list.length > 0;
        
        // Verificar método de autenticação - múltiplas fontes para maior segurança
        // Usamos let para poder reatribuir em outros lugares
        let authMethod = localStorage.getItem('auth_method');
        let isOAuth = authMethod === 'oauth';
        const urlParams = new URLSearchParams(window.location.search);
        let isOAuthParam = urlParams.get('oauth') === 'true';
        const hasOAuthToken = !!localStorage.getItem('deriv_oauth_token');
        const oauthAuthSuccess = localStorage.getItem('oauth_auth_success') === 'true';
        
        // Log detalhado sobre a autenticação para depuração
        console.log('[handleAuthorizeResponse] Informações detalhadas de autenticação:');
        console.log('- auth_method no localStorage:', authMethod || 'não definido');
        console.log('- Parâmetro oauth na URL:', isOAuthParam ? 'presente' : 'ausente');
        console.log('- Token OAuth no localStorage:', hasOAuthToken ? 'presente' : 'ausente');
        console.log('- Flag de sucesso OAuth:', oauthAuthSuccess ? 'presente' : 'ausente');
        console.log('- Modo MULTI de tokens:', usingMultiTokens ? 'ativo' : 'inativo');
        
        // Confirmação explícita do tipo de autenticação
        let isOAuthAuthentication = isOAuth || isOAuthParam || hasOAuthToken || oauthAuthSuccess;
        
        // Se detectarmos OAuth em qualquer verificação, garantir que o indicador está configurado
        if (isOAuthAuthentication) {
          console.log('Método OAuth confirmado, atualizando indicadores visuais');
          
          // Garantir que o método está registrado no localStorage
          localStorage.setItem('auth_method', 'oauth');
          
          // Atualizar indicador visual no painel principal
          const statusIndicator = document.getElementById('status-indicator');
          if (statusIndicator) {
            statusIndicator.classList.add('oauth-auth');
            // Remover outras classes que podem estar conflitando
            statusIndicator.classList.remove('api-auth');
          }
          
          // Atualizar indicador visual no painel de conexão
          const connStatusIndicator = document.getElementById('conn-status-indicator');
          if (connStatusIndicator) {
            connStatusIndicator.classList.add('oauth-auth');
            // Remover outras classes que podem estar conflitando
            connStatusIndicator.classList.remove('api-auth');
          }
          
          // Atualizar texto de status para mostrar OAuth no painel principal
          const connectionStatus = document.getElementById('connection-status');
          if (connectionStatus) {
            connectionStatus.textContent = 'Conectado via OAuth';
          }
          
          // Atualizar texto de status para mostrar OAuth no painel de conexão
          const connStatusText = document.getElementById('conn-status-text');
          if (connStatusText) {
            connStatusText.textContent = 'Conectado via OAuth';
          }
          
          // Atualizar indicador de método na UI
          const authMethodElement = document.getElementById('auth-method');
          if (authMethodElement) {
            authMethodElement.textContent = 'OAuth';
            authMethodElement.classList.add('oauth-method');
            authMethodElement.classList.remove('api-method');
          }
          
          // Atualizar indicador de método na página de conexão
          const connAuthMethodElement = document.getElementById('conn-auth-method');
          if (connAuthMethodElement) {
            connAuthMethodElement.textContent = 'OAuth';
            connAuthMethodElement.classList.add('oauth-method');
            connAuthMethodElement.classList.remove('api-method');
          }
        } else {
          // Se não for OAuth, atualizar indicadores para API
          console.log('Método API direto detectado, atualizando indicadores visuais');
          
          // Garantir que o método está registrado no localStorage
          localStorage.setItem('auth_method', 'api');
          
          // Atualizar indicadores visuais para API
          const statusIndicator = document.getElementById('status-indicator');
          if (statusIndicator) {
            statusIndicator.classList.add('api-auth');
            statusIndicator.classList.remove('oauth-auth');
          }
          
          const connStatusIndicator = document.getElementById('conn-status-indicator');
          if (connStatusIndicator) {
            connStatusIndicator.classList.add('api-auth');
            connStatusIndicator.classList.remove('oauth-auth');
          }
          
          // Atualizar textos de status
          const connectionStatus = document.getElementById('connection-status');
          if (connectionStatus) {
            connectionStatus.textContent = 'Conectado via API';
          }
          
          const connStatusText = document.getElementById('conn-status-text');
          if (connStatusText) {
            connStatusText.textContent = 'Conectado via API';
          }
          
          // Atualizar indicadores de método
          const authMethodElement = document.getElementById('auth-method');
          if (authMethodElement) {
            authMethodElement.textContent = 'API Token';
            authMethodElement.classList.add('api-method');
            authMethodElement.classList.remove('oauth-method');
          }
          
          const connAuthMethodElement = document.getElementById('conn-auth-method');
          if (connAuthMethodElement) {
            connAuthMethodElement.textContent = 'API Token';
            connAuthMethodElement.classList.add('api-method');
            connAuthMethodElement.classList.remove('oauth-method');
          }
        }
        
        if (usingMultiTokens) {
          console.log(`Autorização MULTI bem-sucedida com ${authorizeData.account_list.length} contas disponíveis`);
          
          // Armazenar contas disponíveis em um objeto global
          window.availableAccounts = [...authorizeData.account_list];
          
          // Armazenar em múltiplos lugares para garantir a persistência
          localStorage.setItem('deriv_accounts', JSON.stringify(window.availableAccounts));
          sessionStorage.setItem('deriv_accounts', JSON.stringify(window.availableAccounts));
          
          // Definir loginid ativo
          localStorage.setItem('deriv_active_loginid', authorizeData.loginid);
          sessionStorage.setItem('deriv_active_loginid', authorizeData.loginid);
          
          // Renderizar as contas na interface do usuário
          renderAccountsInUI();
        } else {
          // Modo de token único
          console.log('Autorização bem-sucedida com token único:', authorizeData);
          
          // Mesmo no modo de token único, criar um array com esta conta
          window.availableAccounts = [{
            loginid: authorizeData.loginid,
            currency: authorizeData.currency,
            is_virtual: authorizeData.is_virtual,
            token: derivToken // Usar o token atual
          }];
          
          // Armazenar também no localStorage
          localStorage.setItem('deriv_accounts', JSON.stringify(window.availableAccounts));
          
          // Definir loginid ativo
          localStorage.setItem('deriv_active_loginid', authorizeData.loginid);
        }
        
        // Garantir que todas as informações estão atualizadas na interface
        updateUIWithAccountInfo(authorizeData);
        
        // Função para centralizar a atualização da interface com os dados da conta
        function updateUIWithAccountInfo(accountData) {
          if (!accountData) {
            console.error('Dados da conta inválidos');
            return;
          }
          
          console.log('Atualizando interface com dados da conta:', accountData.loginid);
          
          // 1. Atualizar o seletor de conta no cabeçalho
          const accountSelectorText = document.getElementById('account-selector-text');
          if (accountSelectorText) {
            accountSelectorText.textContent = accountData.loginid || '-';
          }
          
          const accountSelectorBalance = document.getElementById('account-selector-balance');
          if (accountSelectorBalance) {
            accountSelectorBalance.textContent = `${accountData.currency || ''} ${parseFloat(accountData.balance || 0).toFixed(2)}`;
          }
          
          const accountSelectorType = document.getElementById('account-selector-type');
          if (accountSelectorType) {
            const isDemo = accountData.is_virtual;
            accountSelectorType.textContent = isDemo ? 'Demo' : 'Real';
            accountSelectorType.className = `account-type-badge ${isDemo ? 'account-type-demo' : 'account-type-real'}`;
          }
          
          // Mostrar o seletor de conta quando houver dados
          const accountSelector = document.getElementById('account-selector');
          if (accountSelector) {
            accountSelector.style.display = 'inline-block';
          }
          
          // 2. Atualizar o painel de conta ativa
          const activeAccountId = document.getElementById('active-account-id');
          if (activeAccountId) {
            activeAccountId.textContent = accountData.loginid || '-';
          }
          
          const activeAccountBalance = document.getElementById('active-account-balance');
          if (activeAccountBalance) {
            activeAccountBalance.textContent = `${accountData.currency || ''} ${parseFloat(accountData.balance || 0).toFixed(2)}`;
          }
          
          const activeAccountType = document.getElementById('active-account-type');
          if (activeAccountType) {
            const isDemo = accountData.is_virtual;
            activeAccountType.textContent = isDemo ? 'Demo' : 'Real';
            activeAccountType.className = isDemo ? 'account-type-demo' : 'account-type-real';
          }
          
          // Exibir o painel de conta ativa
          const activeAccountPanel = document.getElementById('active-account-panel');
          if (activeAccountPanel) {
            activeAccountPanel.style.display = 'flex';
          }
          
          // 3. Atualizar o conjunto de contas disponíveis no dropdown
          renderAccountsInUI();
        }
        
        // Função interna para atualizar interface com base no status de múltiplos tokens
        function updateMultiTokenIndicator() {
          const connectionMultiLabel = document.getElementById('connection-multi-label');
          if (connectionMultiLabel) {
            if (usingMultiTokens) {
              connectionMultiLabel.style.display = 'inline-block';
              connectionMultiLabel.textContent = `${availableAccounts.length} contas disponíveis`;
            } else {
              connectionMultiLabel.style.display = 'none';
            }
          }
        }
        
        // Função para exibir contas no seletor de contas
        function populateAccountsSelector() {
          console.log('Preenchendo seletor de contas...');
          const accountsDropdown = document.getElementById('accounts-dropdown');
          
          // Verificar se o elemento existe
          if (!accountsDropdown) {
            console.error('Elemento accounts-dropdown não encontrado');
            return;
          }
          
          // Limpar conteúdo atual
          accountsDropdown.innerHTML = '';
          
          // Verificar se temos contas disponíveis
          if (!availableAccounts || availableAccounts.length === 0) {
            const emptyMessage = document.createElement('div');
            emptyMessage.className = 'account-empty-message';
            emptyMessage.textContent = 'Nenhuma conta disponível. Conecte-se via OAuth para ver múltiplas contas.';
            accountsDropdown.appendChild(emptyMessage);
            return;
          }
          
          // Obter ID da conta ativa
          const activeLoginId = localStorage.getItem('deriv_active_loginid') || '';
          
          // Adicionar cada conta ao dropdown
          availableAccounts.forEach(account => {
            const accountItem = document.createElement('div');
            accountItem.className = 'account-item';
            
            // Marcar como selecionada se for a conta ativa
            if (account.loginid === activeLoginId) {
              accountItem.classList.add('selected');
            }
            
            // Determinar se é demo ou real
            const isDemo = account.is_virtual;
            
            // Criar estrutura HTML interna
            accountItem.innerHTML = `
              <div class="account-item-info">
                <span class="account-item-id">${account.loginid}</span>
                <span class="account-item-type ${isDemo ? 'account-type-demo' : 'account-type-real'}">${isDemo ? 'Demo' : 'Real'}</span>
              </div>
              <span class="account-item-balance">${parseFloat(account.balance || 0).toFixed(2)} ${account.currency || ''}</span>
            `;
            
            // Adicionar evento de clique para alternar contas
            accountItem.addEventListener('click', () => {
              console.log(`Selecionando conta: ${account.loginid}`);
              switchToAccount(account.loginid);
              closeAccountSelector();
            });
            
            // Adicionar ao dropdown
            accountsDropdown.appendChild(accountItem);
          });
          
          console.log(`Preenchidas ${availableAccounts.length} contas no seletor`);
        }
        
        // Função para alternar para uma conta específica
        function switchToAccount(loginid) {
          console.log(`Alternando para a conta: ${loginid}`);
          
          // Encontrar a conta selecionada no array de contas disponíveis
          const selectedAccount = availableAccounts.find(account => account.loginid === loginid);
          
          if (!selectedAccount) {
            console.error(`Conta ${loginid} não encontrada no array de contas disponíveis`);
            return;
          }
          
          // Atualizar ID da conta ativa no localStorage
          localStorage.setItem('deriv_active_loginid', loginid);
          
          // Atualizar token ativo com base no ID da conta
          const tokenKey = `deriv_token_${loginid}`;
          const accountToken = localStorage.getItem(tokenKey);
          
          if (accountToken) {
            console.log(`Definindo token para a conta ${loginid}`);
            derivToken = accountToken;
            localStorage.setItem('deriv_token', accountToken);
          } else {
            console.warn(`Token não encontrado para a conta ${loginid}`);
          }
          
          // Atualizar interface para a conta selecionada
          updateUIWithAccountInfo(selectedAccount);
          
          // Reautorizar a conexão com o novo token
          if (ws && ws.readyState === WebSocket.OPEN) {
            console.log('Reabrindo autorização com novo token...');
            authorize();
          } else {
            console.warn('WebSocket não está conectado. Reconectando...');
            connect();
          }
        }
        
        // Função para mostrar/ocultar o dropdown de contas
        function toggleAccountSelector() {
          const accountSelector = document.getElementById('account-selector');
          if (accountSelector) {
            accountSelector.classList.toggle('open');
            
            // Preencher o seletor com as contas disponíveis se estiver abrindo
            if (accountSelector.classList.contains('open')) {
              populateAccountsSelector();
            }
          }
        }
        
        // Função para fechar o seletor de contas
        function closeAccountSelector() {
          const accountSelector = document.getElementById('account-selector');
          if (accountSelector) {
            accountSelector.classList.remove('open');
          }
        }
        
        // Atualizar indicador de múltiplos tokens
        updateMultiTokenIndicator();
        
        // Obter referências aos elementos do card lateral
        const accountId = document.getElementById('account-id');
        const accountName = document.getElementById('account-name');
        const accountType = document.getElementById('account-type');
        const accountBalance = document.getElementById('account-balance');
        const accountInfoCard = document.getElementById('account-info-card');
        
        // Verificar se os elementos existem antes de manipulá-los
        if (accountId && accountName && accountType && accountBalance) {
          // Atualizar informações da conta no card lateral
          accountId.textContent = authorizeData.loginid || '-';
          accountName.textContent = authorizeData.fullname || '-';
          accountType.textContent = authorizeData.is_virtual ? 'Demo' : 'Real';
          accountBalance.textContent = `${parseFloat(authorizeData.balance).toFixed(2)} ${authorizeData.currency}`;
          
          // Destacar visuamente se é conta demo ou real
          if (authorizeData.is_virtual) {
            accountType.classList.add('demo-account');
            accountType.classList.remove('real-account');
          } else {
            accountType.classList.add('real-account');
            accountType.classList.remove('demo-account');
          }
        } else {
          console.error('Elementos de informação da conta não encontrados');
        }
        
        // Atualizar informações da conta na barra de resumo
        try {
          const summaryAccountId = document.getElementById('summary-account-id');
          const summaryAccountName = document.getElementById('summary-account-name');
          const summaryAccountType = document.getElementById('summary-account-type');
          const summaryAccountBalance = document.getElementById('summary-account-balance');
          
          if (summaryAccountId) summaryAccountId.textContent = authorizeData.loginid || '-';
          if (summaryAccountName) summaryAccountName.textContent = authorizeData.fullname || '-';
          if (summaryAccountType) summaryAccountType.textContent = authorizeData.is_virtual ? 'Demo' : 'Real';
          if (summaryAccountBalance) summaryAccountBalance.textContent = `${parseFloat(authorizeData.balance).toFixed(2)} ${authorizeData.currency}`;
        } catch (error) {
          console.error('Erro ao atualizar resumo da conta:', error);
        }
        
        // Atualizar e exibir o painel de conta ativa no cabeçalho
        try {
          const activeAccountPanel = document.getElementById('active-account-panel');
          if (activeAccountPanel) {
            // Atualizar dados da conta ativa com verificação de existência
            const activeAccountId = document.getElementById('active-account-id');
            if (activeAccountId) {
              activeAccountId.textContent = authorizeData.loginid || '-';
            }
            
            // Configurar o tipo de conta (demo/real)
            const accountTypeBadge = document.getElementById('active-account-type-badge');
            const accountTypeText = document.getElementById('active-account-type-text');
            
            if (accountTypeBadge && accountTypeText) {
              if (authorizeData.is_virtual) {
                accountTypeBadge.classList.add('demo');
                accountTypeBadge.classList.remove('real');
                accountTypeText.textContent = 'Demo';
              } else {
                accountTypeBadge.classList.add('real');
                accountTypeBadge.classList.remove('demo');
                accountTypeText.textContent = 'Real';
              }
            }
            
            // Atualizar saldo
            const activeAccountBalance = document.getElementById('active-account-balance');
            if (activeAccountBalance) {
              activeAccountBalance.textContent = `${authorizeData.currency || ''} ${parseFloat(authorizeData.balance || 0).toFixed(2)}`;
            }
            
            // Exibir o painel
            activeAccountPanel.style.display = 'flex';
            
            // Imprimir informações no console para depuração
            console.log('Detalhes da conta ativa atualizados:', {
              id: authorizeData.loginid,
              tipo: authorizeData.is_virtual ? 'Demo' : 'Real', 
              saldo: authorizeData.balance,
              moeda: authorizeData.currency
            });
          }
        } catch (error) {
          console.error('Erro ao atualizar painel de conta ativa:', error);
        }
        
        // Mostrar informações da conta (se o elemento accountInfoCard existir)
        if (accountInfoCard) accountInfoCard.style.display = 'block';
        
        // Exibir barra de resumo da conta (se existir)
        const accountSummaryBar = document.getElementById('account-summary-bar');
        if (accountSummaryBar) accountSummaryBar.style.display = 'block';
        
        // Mostrar o tipo de autenticação usada
        const connectionLabel = document.getElementById('connection-label');
        
        // Verificar método de autenticação de várias formas
        const oauthToken = localStorage.getItem('deriv_oauth_token');
        // Reutilizamos a variável authMethod já declarada anteriormente
        authMethod = localStorage.getItem('auth_method');
        const isOAuthMethod = authMethod === 'oauth';
        const isOAuthToken = oauthToken === derivToken;
        
        console.log('Verificação final de método de autenticação:');
        console.log('- auth_method:', authMethod);
        console.log('- Token OAuth existe:', oauthToken ? 'Sim' : 'Não');
        console.log('- Token OAuth é o token atual:', isOAuthToken ? 'Sim' : 'Não');
        
        // Combinar todas as verificações
        // Reutilizamos a variável isOAuth declarada anteriormente
        isOAuth = isOAuthMethod || isOAuthToken;
        
        // Atualizar indicador visual se for OAuth
        if (isOAuth) {
          // Garantir que o método está registrado corretamente
          localStorage.setItem('auth_method', 'oauth');
          
          // Atualizar indicador visual no painel principal
          const statusIndicator = document.getElementById('status-indicator');
          if (statusIndicator) {
            statusIndicator.classList.add('oauth-auth');
          }
          
          // Atualizar indicador visual no painel de conexão
          const connStatusIndicator = document.getElementById('conn-status-indicator');
          if (connStatusIndicator) {
            connStatusIndicator.classList.add('oauth-auth');
          }
          
          // Atualizar texto nos painéis
          const connStatusText = document.getElementById('conn-status-text');
          if (connStatusText) {
            connStatusText.textContent = 'Conectado via OAuth';
          }
        }
        
        if (connectionLabel) {
          connectionLabel.style.display = 'inline-block';
          connectionLabel.textContent = isOAuth ? 'Conectado via OAuth' : 'Conectado via Token API';
        }
        
        // Adicionar classe de método de autenticação ao corpo do documento
        document.body.classList.add(isOAuth ? 'oauth-auth-mode' : 'api-auth-mode');
        
        // Se está conectado via OAuth, obter lista de contas
        if (isOAuth) {
          console.log('Método OAuth confirmado, solicitando lista de contas');
          getAccountsList();
        }
        
        // Solicitar assinatura de ticks
        subscribeToTicks();
      }
      
      // Função para obter lista de contas do usuário
      function getAccountsList() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.log('WebSocket não está aberto. Não é possível solicitar lista de contas.');
          return;
        }
        
        // Verificar limite de taxa para requisição de lista de contas
        if (!Genius.RateLimiter.canSend('account_list')) {
          console.log('Limite de taxa atingido para solicitação de lista de contas, agendando nova tentativa');
          return Genius.RateLimiter.scheduleRequest('account_list', function() {
            getAccountsList();
          }, 100); // Reduzir tempo de espera para 100ms
        }
        
        // Registrar que estamos fazendo uma requisição de lista de contas
        Genius.RateLimiter.recordRequest('account_list');
        
        const request = {
          account_list: 1,
          req_id: Math.floor(Math.random() * 10000)
        };
        
        // Usar nossa função de envio com limitação de taxa
        Genius.sendWSRequest(ws, request, 'account_list');
        console.log('Solicitando lista de contas');
      }
      
      // Nova função para renderizar contas disponíveis na interface
      function renderAccountsInUI() {
        console.log('Renderizando contas disponíveis...');
        
        // Buscar contas de todas as possíveis fontes
        let availableAccounts = [];
        
        // 1. Verificar variável global
        if (window.availableAccounts && Array.isArray(window.availableAccounts)) {
          console.log('Contas encontradas na variável global:', window.availableAccounts.length);
          availableAccounts = window.availableAccounts;
        }
        
        // 2. Se não encontrou, buscar no localStorage
        if (availableAccounts.length === 0) {
          try {
            const storedAccountsRaw = localStorage.getItem('deriv_accounts');
            if (storedAccountsRaw) {
              const storedAccounts = JSON.parse(storedAccountsRaw);
              if (Array.isArray(storedAccounts) && storedAccounts.length > 0) {
                console.log('Contas encontradas no localStorage:', storedAccounts.length);
                availableAccounts = storedAccounts;
              }
            }
          } catch (e) {
            console.error('Erro ao buscar contas do localStorage:', e);
          }
        }
        
        // 3. Se ainda não encontrou, buscar no sessionStorage
        if (availableAccounts.length === 0) {
          try {
            const sessionAccountsRaw = sessionStorage.getItem('deriv_accounts');
            if (sessionAccountsRaw) {
              const sessionAccounts = JSON.parse(sessionAccountsRaw);
              if (Array.isArray(sessionAccounts) && sessionAccounts.length > 0) {
                console.log('Contas encontradas no sessionStorage:', sessionAccounts.length);
                availableAccounts = sessionAccounts;
              }
            }
          } catch (e) {
            console.error('Erro ao buscar contas do sessionStorage:', e);
          }
        }
        
        // 4. Buscar no localStorage formato OAuth
        if (availableAccounts.length === 0) {
          try {
            const oauthAccountsRaw = localStorage.getItem('deriv_accounts_oauth');
            if (oauthAccountsRaw) {
              const oauthAccounts = JSON.parse(oauthAccountsRaw);
              if (Array.isArray(oauthAccounts) && oauthAccounts.length > 0) {
                console.log('Contas encontradas no formato OAuth:', oauthAccounts.length);
                availableAccounts = oauthAccounts;
              }
            }
          } catch (e) {
            console.error('Erro ao buscar contas OAuth do localStorage:', e);
          }
        }
        
        // Se não encontrou contas em nenhum lugar
        if (availableAccounts.length === 0) {
          console.error('Nenhuma conta disponível encontrada');
          alert('Não foi possível encontrar contas disponíveis. Tente fazer login novamente.');
          return;
        }
        
        console.log('Total de contas para renderizar:', availableAccounts.length);
        
        // Identificar conta ativa atual
        const activeLoginId = localStorage.getItem('deriv_active_loginid') || '';
        
        // Renderizar no dropdown de contas
        const accountsDropdown = document.getElementById('accounts-dropdown');
        if (accountsDropdown) {
          // Limpar conteúdo atual
          accountsDropdown.innerHTML = '';
          
          // Adicionar cada conta ao dropdown
          availableAccounts.forEach(account => {
            const accountItem = document.createElement('div');
            accountItem.className = 'account-item';
            
            // Marcar como selecionada se for a conta ativa
            if (account.loginid === activeLoginId) {
              accountItem.classList.add('selected');
            }
            
            // Determinar tipo de conta
            const isVirtual = account.loginid.startsWith('VRT') || account.is_virtual;
            const accountType = isVirtual ? 'Demo' : 'Real';
            const accountTypeClass = isVirtual ? 'demo-account' : 'real-account';
            
            // Criar HTML do item
            accountItem.innerHTML = `
              <div class="account-item-header">
                <span class="account-id">${account.loginid}</span>
                <span class="account-type ${accountTypeClass}">${accountType}</span>
              </div>
              <div class="account-item-details">
                <span class="account-currency">${account.currency || ''}</span>
              </div>
            `;
            
            // Adicionar evento de clique
            accountItem.addEventListener('click', function() {
              switchAccount(account.loginid);
            });
            
            // Adicionar ao dropdown
            accountsDropdown.appendChild(accountItem);
          });
          
          // Exibir o dropdown
          accountsDropdown.style.display = 'block';
        }
        
        // Atualizar o seletor no cabeçalho
        const accountSelector = document.getElementById('account-selector');
        if (accountSelector) {
          // Obter a conta ativa
          const activeAccount = availableAccounts.find(acc => acc.loginid === activeLoginId) || availableAccounts[0];
          
          // Atualizar texto do seletor
          const accountSelectorText = document.getElementById('account-selector-text');
          if (accountSelectorText) {
            accountSelectorText.textContent = activeAccount.loginid;
          }
          
          // Exibir o seletor
          accountSelector.style.display = 'flex';
        }
        
        return availableAccounts;
      }
    
      // Função para trocar de conta - REIMPLEMENTADA
      function switchAccount(loginid) {
        if (!loginid) {
          alert('Conta inválida selecionada.');
          return;
        }
        
        console.log('Iniciando troca para conta:', loginid);
        
        // Verificar limite de taxa para troca de conta
        if (!Genius.RateLimiter.canSend('account_switch')) {
          console.log('Limite de taxa atingido para troca de conta, agendando nova tentativa');
          return Genius.RateLimiter.scheduleRequest('account_switch', function() {
            switchAccount(loginid);
          }, 100); // Reduzir tempo de espera para 100ms
        }
        
        // Registrar que estamos fazendo uma troca de conta
        Genius.RateLimiter.recordRequest('account_switch');
        
        // Buscar a conta selecionada em todas as possíveis fontes
        let selectedAccount = null;
        
        // Verificar primeiro nas contas disponíveis globais
        if (window.availableAccounts && Array.isArray(window.availableAccounts)) {
          selectedAccount = window.availableAccounts.find(acc => acc.loginid === loginid);
        }
        
        // Se não encontrou, buscar no localStorage
        if (!selectedAccount) {
          try {
            const storedAccountsRaw = localStorage.getItem('deriv_accounts_oauth');
            if (storedAccountsRaw) {
              const storedAccounts = JSON.parse(storedAccountsRaw);
              selectedAccount = storedAccounts.find(acc => acc.loginid === loginid);
            }
          } catch (e) {
            console.error('Erro ao buscar contas do localStorage:', e);
          }
        }
        
        // Se ainda não encontrou, buscar no sessionStorage
        if (!selectedAccount) {
          try {
            const sessionAccountsRaw = sessionStorage.getItem('deriv_accounts_oauth');
            if (sessionAccountsRaw) {
              const sessionAccounts = JSON.parse(sessionAccountsRaw);
              selectedAccount = sessionAccounts.find(acc => acc.loginid === loginid);
            }
          } catch (e) {
            console.error('Erro ao buscar contas do sessionStorage:', e);
          }
        }
        
        // Se encontramos a conta, vamos fazer a troca usando um método mais robusto
        if (selectedAccount && selectedAccount.token) {
          console.log('Conta encontrada, token disponível:', selectedAccount.loginid);
          
          // 1. Armazenar a conta e token atuais em todos os lugares possíveis
          localStorage.setItem('deriv_oauth_token', selectedAccount.token);
          localStorage.setItem('deriv_active_loginid', selectedAccount.loginid);
          sessionStorage.setItem('deriv_oauth_token', selectedAccount.token);
          sessionStorage.setItem('deriv_active_loginid', selectedAccount.loginid);
          derivToken = selectedAccount.token;
          
          // 2. Mostrar indicador de carregamento
          document.querySelectorAll('.status-indicator').forEach(indicator => {
            indicator.classList.add('status-loading');
            indicator.classList.remove('status-connected', 'status-disconnected');
          });
          
          const statusMsg = document.getElementById('connection-status');
          if (statusMsg) {
            statusMsg.textContent = 'Trocando conta...';
          }
          
          // 3. Fechar a conexão WebSocket atual
          if (ws) {
            try {
              console.log('Fechando WebSocket atual para reconexão');
              // Remover todos os event listeners antes de fechar
              ws.onopen = null;
              ws.onclose = null;
              ws.onerror = null;
              ws.onmessage = null;
              
              ws.close();
              ws = null;
              console.log('WebSocket fechado para reconexão');
            } catch (e) {
              console.error('Erro ao fechar WebSocket:', e);
            }
          }
          
          // 4. Iniciar uma nova conexão após um breve atraso
          console.log('Agendando reconexão do WebSocket');
          Genius.RateLimiter.scheduleRequest('websocket_reconnect', function() {
            console.log('Reconectando WebSocket com novo token');
            
            // Definir a variável global para usar o novo token
            window.derivToken = selectedAccount.token;
            
            // Conectar ao WebSocket
            connectWebSocket(function() {
              console.log('WebSocket conectado com sucesso, autorizando com novo token');
              
              // Autorizar explicitamente usando o rate limiter
              Genius.RateLimiter.scheduleRequest('authorize', function() {
                authorize();
              }, 100);
            });
          }, 1000);
          
          // 5. Atualizar a UI para refletir a mudança de conta
          updateSelectedAccount(loginid);
          
          return true;
        } else {
          // Não encontramos a conta ou ela não tem token
          console.error('Conta não encontrada ou sem token:', loginid);
          alert('Não foi possível encontrar os dados da conta selecionada. Tente fazer login novamente.');
          return false;
        }
        
        // Se chegou aqui, não encontrou a conta no modo MULTI, verificar no localStorage
        console.log('Conta não encontrada no modo MULTI, verificando no localStorage');
        
        // Verificar novamente as contas disponíveis - pode ser que estejam armazenadas em outro lugar
        const oauthAccountsRaw = localStorage.getItem('deriv_accounts_oauth');
        let foundAccountInStorage = false;
        
        if (oauthAccountsRaw) {
          try {
            const storedAccounts = JSON.parse(oauthAccountsRaw);
            console.log('Verificando contas armazenadas no localStorage:', storedAccounts);
            
            const storedAccount = storedAccounts.find(account => account.loginid === loginid);
            if (storedAccount && storedAccount.token) {
              console.log('Conta encontrada no localStorage:', loginid);
              
              // Definir a variável global availableAccounts caso ainda não esteja definida
              if (!window.availableAccounts || !Array.isArray(window.availableAccounts)) {
                window.availableAccounts = storedAccounts;
                console.log('Atualizando lista de contas disponíveis com dados do localStorage');
              }
              
              // Atualizar o token ativo
              derivToken = storedAccount.token;
              localStorage.setItem('deriv_active_loginid', loginid);
              localStorage.setItem('deriv_oauth_token', derivToken);
              
              // Mostrar indicador de carregamento
              const statusIndicators = document.querySelectorAll('.status-indicator');
              statusIndicators.forEach(indicator => {
                indicator.classList.add('status-loading');
                indicator.classList.remove('status-connected', 'status-disconnected');
              });
              
              const connectionStatus = document.getElementById('connection-status');
              if (connectionStatus) {
                connectionStatus.textContent = 'Trocando conta...';
              }
              
              const connStatusText = document.getElementById('conn-status-text');
              if (connStatusText) {
                connStatusText.textContent = 'Trocando conta...';
              }
              
              // Enviar uma autorização com o token encontrado
              if (ws && ws.readyState === WebSocket.OPEN) {
                const authRequest = {
                  authorize: storedAccount.token,
                  req_id: Math.floor(Math.random() * 10000)
                };
                
                console.log('Enviando authorize para conta encontrada no localStorage');
                ws.send(JSON.stringify(authRequest));
              }
              
              foundAccountInStorage = true;
              return;
            }
          } catch (e) {
            console.error('Erro ao processar contas armazenadas:', e);
          }
        }
        
        // AVISO: A API não suporta switch_account como pensamos
        console.warn('AVISO: Tentativa de reconexão do WebSocket como alternativa a switch_account');
        
        // Mostrar indicador de carregamento 
        const statusIndicators = document.querySelectorAll('.status-indicator');
        statusIndicators.forEach(indicator => {
          indicator.classList.add('status-loading');
          indicator.classList.remove('status-connected', 'status-disconnected');
        });
        
        const connectionStatus = document.getElementById('connection-status');
        if (connectionStatus) {
          connectionStatus.textContent = 'Trocando conta...';
        }
        
        const connStatusText = document.getElementById('conn-status-text');
        if (connStatusText) {
          connStatusText.textContent = 'Trocando conta...';
        }
        
        // Fechar o WebSocket atual e reconectar (isso iniciará o processo do zero)
        if (ws) {
          try {
            console.log('Fechando WebSocket atual para reconexão...');
            ws.close();
          } catch (e) {
            console.error('Erro ao fechar WebSocket atual:', e);
          }
        }
        
        // Definir o ID da conta que queremos selecionar na reconexão
        localStorage.setItem('deriv_active_loginid', loginid);
        
        // Reconectar após um breve atraso para garantir que o WebSocket anterior foi fechado
        setTimeout(function() {
          console.log('Reconectando WebSocket após fechar...');
          connectWebSocket();
        }, 1000);
        
        // Destacar a conta selecionada na interface
        document.querySelectorAll('.account-item').forEach(item => {
          if (item.dataset.accountId === loginid) {
            item.classList.add('selected', 'active');
          } else {
            item.classList.remove('selected', 'active');
          }
        });
        
        // Atualizar dropdown de seleção de conta
        const accountSelectors = document.querySelectorAll('#account-selector, #conn-account-selector');
        accountSelectors.forEach(selector => {
          if (selector) selector.value = loginid;
        });
      }
      
      // Função para processar resposta da lista de contas
      function handleAccountListResponse(response) {
        const accountList = response.account_list;
        if (!accountList || !accountList.length) {
          console.error('Lista de contas vazia ou inválida');
          return;
        }
        
        // Atualizar a variável global de contas disponíveis
        window.availableAccounts = accountList;
        
        // Salvar a lista de contas para uso posterior
        localStorage.setItem('deriv_accounts', JSON.stringify(accountList));
        
        // Atualizar os seletores de contas
        syncAccountSelectors();
        
        console.log('Contas disponíveis atualizadas:', accountList.length, 'contas');
        
        console.log('Lista de contas recebida:', accountList);
        
        // Salvar a lista de contas recebida da API
        localStorage.setItem('deriv_accounts_api', JSON.stringify(accountList));
        
        // Atualizar o seletor de contas imediatamente
        const accountSelector = document.getElementById('account-selector');
        if (accountSelector) {
          // Limpar opções atuais
          accountSelector.innerHTML = '<option value="">Selecione uma conta</option>';
          
          // Adicionar cada conta como uma opção
          accountList.forEach(account => {
            const option = document.createElement('option');
            option.value = account.loginid;
            option.textContent = `${account.loginid} (${account.is_virtual ? 'Demo' : 'Real'}) - ${account.currency || 'USD'}`;
            accountSelector.appendChild(option);
          });
        }
        
        // Verificar se a página de conexão está aberta
        const connectionPage = document.getElementById('connection-page');
        if (connectionPage && connectionPage.style.display === 'flex') {
          console.log('Forçando atualização dos dados na página de conexão');
          
          // Atualizar status da conexão
          updateConnectionPageStatus();
          
          // Atualizar informações da conta
          updateConnectionPageAccount();
          
          // Preencher também o seletor na página de conexão
          const connAccountSelector = document.getElementById('conn-account-selector');
          if (connAccountSelector) {
            // Limpar opções atuais
            connAccountSelector.innerHTML = '<option value="">Selecione uma conta</option>';
            
            // Adicionar cada conta como uma opção
            accountList.forEach(account => {
              const option = document.createElement('option');
              option.value = account.loginid;
              option.textContent = `${account.loginid} (${account.is_virtual ? 'Demo' : 'Real'}) - ${account.currency || 'USD'}`;
              connAccountSelector.appendChild(option);
            });
          }
        }
        
        // Combinar com as contas salvas do OAuth
        const accounts = [...accountList];
        
        // Se temos contas do OAuth, verificar se existem contas adicionais
        if (availableAccounts.length > 0) {
          for (const oauthAccount of availableAccounts) {
            // Verificar se esta conta já existe na lista da API
            const accountExists = accounts.some(account => account.loginid === oauthAccount.loginid);
            
            // Se a conta não está na lista, adicioná-la
            if (!accountExists) {
              accounts.push({
                loginid: oauthAccount.loginid,
                is_virtual: oauthAccount.loginid.startsWith('VR'),
                currency: oauthAccount.currency || 'USD'
              });
            }
          }
        }
        
        // Atualização centralizada dos seletores de conta
        // Obter todos os seletores de conta na página
        const mainSelector = document.getElementById('account-selector');
        const connSelector = document.getElementById('conn-account-selector');
        
        // Atualizar os seletores de conta para exibir as contas disponíveis
        [mainSelector, connSelector].forEach(selector => {
          if (selector) {
            // Limpar opções existentes
            selector.innerHTML = '<option value="">Selecione uma conta</option>';
            
            // Adicionar cada conta ao seletor
            accounts.forEach(account => {
              const option = document.createElement('option');
              option.value = account.loginid;
              option.textContent = `${account.loginid} (${account.is_virtual ? 'Demo' : 'Real'}) - ${account.currency || ''}`;
              
              // Marcar a conta atual como selecionada se corresponder ao ID da conta ativa
              const currentId = document.getElementById('account-id')?.textContent || '';
              if (account.loginid === currentId) {
                option.selected = true;
              }
              
              selector.appendChild(option);
            });
          }
        });
        
        console.log(`Adicionadas ${accounts.length} contas aos seletores`);
        
        // Configuração de event listeners para seletores
        if (mainSelector) {
          // Remover qualquer event listener existente
          mainSelector.removeEventListener('change', handleAccountChange);
          // Adicionar event listener para trocar de conta
          mainSelector.addEventListener('change', handleAccountChange);
        }
        
        // Os listeners para o seletor principal já foram configurados acima
        
        // Atualizar a lista visual de contas disponíveis
        updateAccountsList(accounts);
      }
      
      // Função para atualizar a lista visual de contas
      function updateAccountsList(accounts) {
        const accountsList = document.getElementById('accounts-list');
        const accountsCount = document.getElementById('accounts-count');
        const currentAccountId = document.getElementById('account-id').textContent;
        
        // Limpar lista atual
        accountsList.innerHTML = '';
        
        // Atualizar contador de contas
        accountsCount.textContent = `${accounts.length} conta${accounts.length !== 1 ? 's' : ''}`;
        
        // Adicionar cada conta à lista
        accounts.forEach(account => {
          const accountItem = document.createElement('div');
          accountItem.className = `account-item ${account.loginid === currentAccountId ? 'active' : ''}`;
          accountItem.dataset.accountId = account.loginid;
          
          // Estrutura interna do item de conta
          accountItem.innerHTML = `
            <div class="account-item-info">
              <div class="account-item-id">${account.loginid}</div>
              <div class="account-item-type">${account.is_virtual ? 'Conta Demo' : 'Conta Real'}</div>
            </div>
            <div class="account-item-currency">${account.currency || ''}</div>
          `;
          
          // Adicionar evento de clique para trocar de conta
          accountItem.addEventListener('click', function() {
            // Selecionar no dropdown (que acionará o evento de mudança)
            const accountSelector = document.getElementById('account-selector');
            accountSelector.value = account.loginid;
            
            // Disparar o evento de mudança manualmente
            const changeEvent = new Event('change');
            accountSelector.dispatchEvent(changeEvent);
          });
          
          accountsList.appendChild(accountItem);
        });
      }
      
      // Função para lidar com mudança de conta
      // Função para atualizar a interface com a conta selecionada
      function updateSelectedAccount(loginid) {
        console.log('Atualizando interface para a conta:', loginid);
        
        // Destacar a conta selecionada na interface
        document.querySelectorAll('.account-item').forEach(item => {
          if (item.dataset.accountId === loginid) {
            item.classList.add('selected', 'active');
          } else {
            item.classList.remove('selected', 'active');
          }
        });
        
        // Atualizar texto do ID da conta na interface
        const accountIdElement = document.getElementById('account-id');
        if (accountIdElement) {
          accountIdElement.textContent = loginid;
        }
        
        // Atualizar dropdown de seleção de conta
        const accountSelectors = document.querySelectorAll('#account-selector, #conn-account-selector');
        accountSelectors.forEach(selector => {
          if (selector) selector.value = loginid;
        });
        
        // Verificar tipo de conta e atualizar indicadores visuais
        const isVirtual = loginid.startsWith('VR');
        
        const accountTypeElement = document.getElementById('account-type');
        if (accountTypeElement) {
          accountTypeElement.textContent = isVirtual ? 'Conta Demo' : 'Conta Real';
          accountTypeElement.className = isVirtual ? 'demo-account' : 'real-account';
        }
        
        // Atualizar também o ícone de status da conta, se existir
        const accountIcon = document.querySelector('.account-status-icon');
        if (accountIcon) {
          if (isVirtual) {
            accountIcon.classList.add('demo');
            accountIcon.classList.remove('real');
          } else {
            accountIcon.classList.add('real');
            accountIcon.classList.remove('demo');
          }
        }
        
        console.log('Interface atualizada para a conta:', loginid, 'Tipo:', isVirtual ? 'Demo' : 'Real');
      }
      
      // Função para trocar entre contas no modo MULTI com reconexão completa
      function handleAccountChange() {
        console.log("DEBUG: Executando nova versão da função handleAccountChange()");
        const selectedAccountId = this.value;
        if (!selectedAccountId) return;
        
        console.log('Iniciando troca para conta:', selectedAccountId);
        
        // Debug: Verificar tokens disponíveis
        console.log('Contas disponíveis no modo MULTI:', availableAccounts);
        
        // Verificar se esta conta está disponível em availableAccounts (modo MULTI)
        const selectedOAuthAccount = availableAccounts.find(account => account.loginid === selectedAccountId);
        
        if (selectedOAuthAccount && selectedOAuthAccount.token) {
          console.log('Conta encontrada no modo MULTI:', selectedAccountId, 'com token:', selectedOAuthAccount.token.substring(0, 5) + '...');
          
          // Atualizar o token ativo na sessão - IMPORTANTE: setamos o token como principal
          derivToken = selectedOAuthAccount.token;
          
          // Salvar o token ativo para acesso posterior
          localStorage.setItem('deriv_active_loginid', selectedAccountId);
          localStorage.setItem('deriv_oauth_token', derivToken);
          
          // Destacar a conta selecionada nas listas visuais
          document.querySelectorAll('.account-item').forEach(item => {
            if (item.dataset.accountId === selectedAccountId) {
              item.classList.add('selected', 'active');
            } else {
              item.classList.remove('selected', 'active');
            }
          });
          
          // Atualizar todos os seletores dropdown com a conta selecionada
          document.querySelectorAll('#account-selector, #conn-account-selector').forEach(selector => {
            if (selector) selector.value = selectedAccountId;
          });
          
          // Se já estamos conectados, precisamos enviar um authorize com o novo token
          if (ws && ws.readyState === WebSocket.OPEN) {
            console.log('Enviando authorize com o token da conta selecionada:', selectedAccountId);
            
            // Enviar uma autorização explícita com o novo token
            const authRequest = {
              authorize: selectedOAuthAccount.token,
              loginid: selectedAccountId, // Parâmetro loginid exigido pela API
              req_id: Math.floor(Math.random() * 10000)
            };
            
            // Indicar que estamos trocando de conta
            const statusMsg = document.getElementById('connection-status');
            if (statusMsg) {
              statusMsg.textContent = 'Trocando conta...';
              statusMsg.style.color = '#f7f7f7';
            }
            
            const connStatusText = document.getElementById('conn-status-text');
            if (connStatusText) {
              connStatusText.textContent = 'Trocando conta...';
            }
            
            document.querySelectorAll('.status-indicator').forEach(indicator => {
              indicator.classList.add('status-loading');
              indicator.classList.remove('status-connected', 'status-disconnected');
            });
            
            // Enviar a solicitação de autorização
            ws.send(JSON.stringify(authRequest));
            console.log('Autorização enviada para conta:', selectedAccountId);
            
            // Construir um objeto com os dados da conta para atualizar a UI temporariamente
            // Isso pode ser substituído quando recebermos a resposta real da API
            const accountData = {
              loginid: selectedOAuthAccount.loginid,
              fullname: selectedOAuthAccount.fullname || 'Usuário Deriv',
              is_virtual: selectedOAuthAccount.loginid.startsWith('VR') || selectedOAuthAccount.is_virtual,
              currency: selectedOAuthAccount.currency || 'USD',
              balance: selectedOAuthAccount.balance || '0.00'
            };
            
            // Atualizar as informações da conta na interface
            // Atualizar informações da conta no card lateral
            accountId.textContent = accountData.loginid || '-';
            accountName.textContent = accountData.fullname || '-';
            accountType.textContent = accountData.is_virtual ? 'Demo' : 'Real';
            accountBalance.textContent = `${parseFloat(accountData.balance).toFixed(2)} ${accountData.currency}`;
            
            // Atualizar informações da conta na barra de resumo
            document.getElementById('summary-account-id').textContent = accountData.loginid || '-';
            document.getElementById('summary-account-name').textContent = accountData.fullname || '-';
            document.getElementById('summary-account-type').textContent = accountData.is_virtual ? 'Demo' : 'Real';
            document.getElementById('summary-account-balance').textContent = `${parseFloat(accountData.balance).toFixed(2)} ${accountData.currency}`;
            
            // Atualizar e exibir o painel de conta ativa no cabeçalho
            const activeAccountPanel = document.getElementById('active-account-panel');
            if (activeAccountPanel) {
              document.getElementById('active-account-id').textContent = accountData.loginid || '-';
              
              // Configurar o tipo de conta (demo/real)
              const accountTypeBadge = document.getElementById('active-account-type-badge');
              const accountTypeText = document.getElementById('active-account-type-text');
              
              if (accountTypeBadge && accountTypeText) {
                if (accountData.is_virtual) {
                  accountTypeBadge.classList.add('demo');
                  accountTypeBadge.classList.remove('real');
                  accountTypeText.textContent = 'Demo';
                } else {
                  accountTypeBadge.classList.add('real');
                  accountTypeBadge.classList.remove('demo');
                  accountTypeText.textContent = 'Real';
                }
              }
              
              // Atualizar saldo
              document.getElementById('active-account-balance').textContent = `${accountData.currency} ${parseFloat(accountData.balance).toFixed(2)}`;
              
              // Exibir o painel
              activeAccountPanel.style.display = 'flex';
            }
          } else {
            // Se não temos conexão, conectar com o novo token
            console.log('Sem conexão ativa, reconectando com novo token');
            connectWebSocket();
          }
        } else {
          // Verificar novamente as contas disponíveis - pode ser que estejam armazenadas em outro lugar
          const oauthAccountsRaw = localStorage.getItem('deriv_accounts_oauth');
          let foundAccountInStorage = false;
          
          if (oauthAccountsRaw) {
            try {
              const storedAccounts = JSON.parse(oauthAccountsRaw);
              console.log('Verificando contas armazenadas no localStorage:', storedAccounts);
              
              const storedAccount = storedAccounts.find(account => account.loginid === selectedAccountId);
              if (storedAccount && storedAccount.token) {
                console.log('Conta encontrada no localStorage:', selectedAccountId);
                
                // Definir a variável global availableAccounts caso ainda não esteja definida
                if (!window.availableAccounts || !Array.isArray(window.availableAccounts)) {
                  window.availableAccounts = storedAccounts;
                  console.log('Atualizando lista de contas disponíveis com dados do localStorage');
                }
                
                // Atualizar o token ativo
                derivToken = storedAccount.token;
                localStorage.setItem('deriv_active_loginid', selectedAccountId);
                localStorage.setItem('deriv_oauth_token', derivToken);
                
                // Enviar uma autorização com o token encontrado
                if (ws && ws.readyState === WebSocket.OPEN) {
                  const authRequest = {
                    authorize: storedAccount.token,
                    req_id: Math.floor(Math.random() * 10000)
                  };
                  
                  console.log('Enviando authorize para conta encontrada no localStorage');
                  ws.send(JSON.stringify(authRequest));
                  
                  // Indicar que estamos trocando de conta
                  const statusMsg = document.getElementById('connection-status');
                  if (statusMsg) {
                    statusMsg.textContent = 'Trocando conta...';
                  }
                  
                  document.querySelectorAll('.status-indicator').forEach(indicator => {
                    indicator.classList.add('status-loading');
                    indicator.classList.remove('status-connected');
                  });
                }
                
                foundAccountInStorage = true;
              }
            } catch (e) {
              console.error('Erro ao processar contas armazenadas:', e);
            }
          }
          
          if (!foundAccountInStorage) {
            console.log('Conta não encontrada em nenhum local, tentando reconectar WebSocket');
            
            // A API não suporta switch_account, então vamos reconectar o WebSocket
            if (ws) {
              try {
                ws.close();
              } catch (e) {
                console.error('Erro ao fechar WebSocket existente:', e);
              }
            }
            
            // Conectar novamente com um pequeno atraso
            setTimeout(function() {
              connectWebSocket(function() {
                console.log('Reconectado ao WebSocket, solicitando lista de contas');
                
                // Solicitar lista de contas novamente
                if (ws && ws.readyState === WebSocket.OPEN) {
                  const accountListRequest = {
                    account_list: 1
                  };
                  
                  ws.send(JSON.stringify(accountListRequest));
                }
              });
            }, 1000);
          }
        }
      }
      
      // Função para solicitar detalhes da conta
      function requestAccountDetails(accountId) {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        
        console.log(`Solicitando detalhes da conta ${accountId} no modo MULTI`);
        
        // Enviar pedido de detalhes específicos da conta no modo MULTI
        const request = {
          get_account_status: 1,
          loginid: accountId, // IMPORTANTE: API exige loginid, não account
          req_id: Math.floor(Math.random() * 1000) + 1
        };
        
        ws.send(JSON.stringify(request));
        
        // Também solicitar o saldo atualizado
        const balanceRequest = {
          balance: 1,
          loginid: accountId, // IMPORTANTE: API exige loginid, não account
          req_id: Math.floor(Math.random() * 1000) + 1
        };
        
        ws.send(JSON.stringify(balanceRequest));
        
        // Solicitar lista de contas para atualizar os seletores
        const accountListRequest = {
          account_list: 1,
          loginid: accountId // IMPORTANTE: API exige loginid quando múltiplos tokens
        };
        
        ws.send(JSON.stringify(accountListRequest));
      }
      
      // Função para processar resposta de troca de conta
      function handleSwitchAccountResponse(response) {
        const switchData = response.switch_account;
        
        if (!switchData) {
          console.error('Dados de troca de conta inválidos');
          return;
        }
        
        console.log('Troca de conta bem-sucedida:', switchData);
        
        // Solicitar lista de contas para atualizar os seletores
        const accountListRequest = {
          account_list: 1
        };
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          console.log('Solicitando lista de contas atualizada após troca de conta');
          ws.send(JSON.stringify(accountListRequest));
        }
        
        // Atualizar informações da conta no card lateral
        accountId.textContent = switchData.loginid || '-';
        accountName.textContent = switchData.fullname || '-';
        accountType.textContent = switchData.is_virtual ? 'Demo' : 'Real';
        accountBalance.textContent = `${parseFloat(switchData.balance).toFixed(2)} ${switchData.currency}`;
        
        // Atualizar informações da conta na barra de resumo
        document.getElementById('summary-account-id').textContent = switchData.loginid || '-';
        document.getElementById('summary-account-name').textContent = switchData.fullname || '-';
        document.getElementById('summary-account-type').textContent = switchData.is_virtual ? 'Demo' : 'Real';
        document.getElementById('summary-account-balance').textContent = `${parseFloat(switchData.balance).toFixed(2)} ${switchData.currency}`;
        
        // Atualizar e exibir o painel de conta ativa no cabeçalho
        const activeAccountPanel = document.getElementById('active-account-panel');
        if (activeAccountPanel) {
          // Atualizar dados da conta ativa
          document.getElementById('active-account-id').textContent = switchData.loginid || '-';
          
          // Configurar o tipo de conta (demo/real)
          const accountTypeBadge = document.getElementById('active-account-type-badge');
          const accountTypeText = document.getElementById('active-account-type-text');
          
          if (accountTypeBadge && accountTypeText) {
            if (switchData.is_virtual) {
              accountTypeBadge.classList.add('demo');
              accountTypeBadge.classList.remove('real');
              accountTypeText.textContent = 'Demo';
            } else {
              accountTypeBadge.classList.add('real');
              accountTypeBadge.classList.remove('demo');
              accountTypeText.textContent = 'Real';
            }
          }
          
          // Atualizar saldo
          document.getElementById('active-account-balance').textContent = `${switchData.currency} ${parseFloat(switchData.balance).toFixed(2)}`;
          
          // Exibir o painel
          activeAccountPanel.style.display = 'flex';
        }
        
        // Atualizar seletor de contas para mostrar a conta atual
        const accountSelector = document.getElementById('account-selector');
        for (let i = 0; i < accountSelector.options.length; i++) {
          if (accountSelector.options[i].value === switchData.loginid) {
            accountSelector.selectedIndex = i;
            break;
          }
        }
        
        // Resubscrever aos ticks para a nova conta
        subscribeToTicks();
        
        // Atualizar indicadores de status
        document.querySelectorAll('.status-indicator').forEach(indicator => {
          indicator.classList.remove('status-loading');
          indicator.classList.add('status-connected');
        });
        
        // Atualizar textos de status
        const connectionStatus = document.getElementById('connection-status');
        if (connectionStatus) {
          connectionStatus.textContent = 'Conectado';
        }
        
        const connStatusText = document.getElementById('conn-status-text');
        if (connStatusText) {
          connStatusText.textContent = 'Conectado';
        }
        
        // Destacar a conta selecionada nas listas
        document.querySelectorAll('.account-item').forEach(item => {
          if (item.dataset.accountId === switchData.loginid) {
            item.classList.add('selected', 'active');
          } else {
            item.classList.remove('selected', 'active');
          }
        });
      }

      function hideAccountInfo() {
        // Obter referências aos elementos
        const accountInfoCard = document.getElementById('account-info-card');
        const accountSummaryBar = document.getElementById('account-summary-bar');
        const accountId = document.getElementById('account-id');
        const accountName = document.getElementById('account-name');
        const accountType = document.getElementById('account-type');
        const accountBalance = document.getElementById('account-balance');
        
        // Esconder o card de conta
        if (accountInfoCard) accountInfoCard.style.display = 'none';
        if (accountSummaryBar) accountSummaryBar.style.display = 'none';
        
        // Esconder o painel de conta ativa
        const activeAccountPanel = document.getElementById('active-account-panel');
        if (activeAccountPanel) {
          activeAccountPanel.style.display = 'none';
        }
        
        // Ocultar o rótulo de conexão e indicador de múltiplos tokens
        const connectionLabel = document.getElementById('connection-label');
        if (connectionLabel) connectionLabel.style.display = 'none';
        
        const connectionMultiLabel = document.getElementById('connection-multi-label');
        if (connectionMultiLabel) connectionMultiLabel.style.display = 'none';
        
        // Limpar informações da conta no card
        if (accountId) accountId.textContent = '-';
        if (accountName) accountName.textContent = '-';
        if (accountType) accountType.textContent = '-';
        if (accountBalance) accountBalance.textContent = '-';
        
        // Limpar informações da barra de resumo
        document.getElementById('summary-account-id').textContent = '-';
        document.getElementById('summary-account-name').textContent = '-';
        document.getElementById('summary-account-type').textContent = '-';
        document.getElementById('summary-account-balance').textContent = '-';
        
        // Limpar informações no painel de conta ativa
        if (document.getElementById('active-account-id')) {
          document.getElementById('active-account-id').textContent = '-';
        }
        if (document.getElementById('active-account-type-text')) {
          document.getElementById('active-account-type-text').textContent = '-';
        }
        if (document.getElementById('active-account-balance')) {
          document.getElementById('active-account-balance').textContent = '-';
        }
        
        // Reiniciar seletor de contas
        const mainAccountSelector = document.getElementById('account-selector');
        if (mainAccountSelector) {
          mainAccountSelector.innerHTML = '<option value="">Selecione uma conta</option>';
        }
        
        // Reiniciar também o seletor na página de conexão
        const connAccountSelector = document.getElementById('conn-account-selector');
        if (connAccountSelector) {
          connAccountSelector.innerHTML = '<option value="">Selecione uma conta</option>';
        }
        
        // Limpar a lista de contas
        const accountsList = document.getElementById('accounts-list');
        if (accountsList) {
          accountsList.innerHTML = '';
        }
        
        const accountsCount = document.getElementById('accounts-count');
        if (accountsCount) {
          accountsCount.textContent = '0 contas';
        }
      }
      
      // Função para atualizar o saldo
      function updateAccountBalance() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.error('WebSocket não está conectado');
          return;
        }
        
        // Ativar animação de atualização nos botões
        const refreshBalanceBtn = document.getElementById('conn-refresh-balance-btn');
        if (refreshBalanceBtn) {
          refreshBalanceBtn.classList.add('updating');
        }
        
        const refreshAccountBtn = document.getElementById('refresh-account-btn');
        if (refreshAccountBtn) {
          refreshAccountBtn.classList.add('updating');
        }
        
        // Enviar solicitação para obter o saldo atualizado
        const balanceRequest = {
          balance: 1,
          subscribe: 0
        };
        
        ws.send(JSON.stringify(balanceRequest));
        
        // Indicar que está atualizando
        accountBalance.innerHTML = '<span class="loading">atualizando...</span>';
        document.getElementById('summary-account-balance').innerHTML = '<span class="loading">atualizando...</span>';
        
        // Atualizar no painel destacado se existir
        const activeAccountBalance = document.getElementById('active-account-balance');
        if (activeAccountBalance) {
          activeAccountBalance.innerHTML = '<span class="loading">atualizando...</span>';
        }
      }
      
      // Função para solicitar saldo da conta usando a API balance
      function requestBalance() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.error('WebSocket não está conectado. Não é possível solicitar saldo.');
          return;
        }
        
        // Verificar limite de taxa para solicitação de saldo
        if (!Genius.RateLimiter.canSend('balance')) {
          console.log('Limite de taxa atingido para solicitação de saldo, agendando nova tentativa');
          return Genius.RateLimiter.scheduleRequest('balance', function() {
            requestBalance();
          }, 100); // Reduzir tempo de espera para 100ms
        }
        
        try {
          // Criando a solicitação conforme o esquema balance da API
          const balanceRequest = {
            balance: 1,  // Deve ser 1 conforme esquema
            account: 'current',  // Padrão para conta atual
            subscribe: 1,  // Assinamos atualizações contínuas para valores atuais
            req_id: Math.floor(Math.random() * 1000) + 1  // ID único para rastrear a solicitação
          };
          
          // Registrar que estamos enviando uma solicitação de saldo
          Genius.RateLimiter.recordRequest('balance');
          
          console.log('Enviando solicitação de saldo');
          // Usar nossa função de envio com limitação de taxa
          Genius.sendWSRequest(ws, balanceRequest, 'balance');
          
          // Atualizar interface para indicar carregamento
          updateBalanceLoading(true);
        } catch (error) {
          console.error('Erro ao solicitar saldo:', error);
          updateBalanceLoading(false);
        }
      }
      
      // Função para processar resposta de saldo
      function handleBalanceResponse(response) {
        const balanceData = response.balance;
        
        if (!balanceData) {
          console.error('Dados de saldo inválidos');
          return;
        }
        
        console.log('Saldo atualizado:', balanceData);
        
        // Obter referência ao elemento de saldo da conta
        const accountBalance = document.getElementById('account-balance');
        
        // Atualizar saldo no card de conta (se existir)
        if (accountBalance) {
          accountBalance.textContent = `${parseFloat(balanceData.balance).toFixed(2)} ${balanceData.currency}`;
        }
        
        // Atualizar saldo na barra de resumo
        const summaryBalance = document.getElementById('summary-account-balance');
        if (summaryBalance) {
          summaryBalance.textContent = `${parseFloat(balanceData.balance).toFixed(2)} ${balanceData.currency}`;
        }
        
        // Atualizar no painel destacado da conta ativa
        const activeAccountBalance = document.getElementById('active-account-balance');
        if (activeAccountBalance) {
          activeAccountBalance.textContent = `${balanceData.currency} ${parseFloat(balanceData.balance).toFixed(2)}`;
          
          // Remover animação dos botões de atualização
          const refreshAccountBtn = document.getElementById('refresh-account-btn');
          if (refreshAccountBtn) {
            refreshAccountBtn.classList.remove('updating');
          }
        }
        
        // Animar brevemente o elemento de saldo para indicar atualização
        if (accountBalance) accountBalance.classList.add('balance-updated');
        
        const summaryAccountBalance = document.getElementById('summary-account-balance');
        if (summaryAccountBalance) summaryAccountBalance.classList.add('balance-updated');
        
        if (activeAccountBalance) activeAccountBalance.classList.add('balance-updated');
        
        // Remover a classe de animação após a transição
        setTimeout(() => {
          if (accountBalance) accountBalance.classList.remove('balance-updated');
          if (summaryAccountBalance) summaryAccountBalance.classList.remove('balance-updated');
          if (activeAccountBalance) activeAccountBalance.classList.remove('balance-updated');
        }, 1500);
        
        // Remover animação de atualização dos botões
        const refreshBtn = document.getElementById('conn-refresh-balance-btn');
        if (refreshBtn) {
          refreshBtn.classList.remove('updating');
        }
      }
      
      // Função para processar resposta de saldo da API para atualizar interface
      function processBalanceResponse(response) {
        if (!response || !response.balance) return;
        
        const balance = response.balance;
        const balanceText = `${balance.currency} ${parseFloat(balance.balance).toFixed(2)}`;
        
        // Atualizar nos diversos elementos da interface
        const connAccountBalanceElement = document.getElementById('conn-account-balance');
        if (connAccountBalanceElement) {
          connAccountBalanceElement.textContent = balanceText;
        }
        
        // Atualizar no painel destacado
        const activeAccountBalance = document.getElementById('active-account-balance');
        if (activeAccountBalance) {
          activeAccountBalance.textContent = balanceText;
        }
        
        // Remover animação de atualização
        const refreshBalanceBtn = document.getElementById('conn-refresh-balance-btn');
        if (refreshBalanceBtn) {
          refreshBalanceBtn.classList.remove('updating');
        }
        
        const refreshAccountBtn = document.getElementById('refresh-account-btn');
        if (refreshAccountBtn) {
          refreshAccountBtn.classList.remove('updating');
        }
      }
      
      // Função para iniciar fluxo OAuth
//Este é o bloco de função startOAuthFlow existente, que será sobrescrito pelos eventos nos botões que definimos acima
      
      // Função para coletar todos os tokens disponíveis (API e OAuth)
      function collectAllTokens() {
        const tokens = [];
        
        // Adicionar token principal
        if (derivToken && derivToken !== 'MULTI') {
          tokens.push(derivToken);
        }
        
        // Adicionar tokens OAuth
        if (availableAccounts && availableAccounts.length > 0) {
          availableAccounts.forEach(account => {
            if (account.token && !tokens.includes(account.token)) {
              tokens.push(account.token);
            }
          });
        }
        
        // Verificar por tokens adicionais salvos
        const savedTokens = localStorage.getItem('deriv_additional_tokens');
        if (savedTokens) {
          try {
            const parsedTokens = JSON.parse(savedTokens);
            parsedTokens.forEach(token => {
              if (!tokens.includes(token)) {
                tokens.push(token);
              }
            });
          } catch (error) {
            console.error('Erro ao analisar tokens adicionais:', error);
          }
        }
        
        console.log(`Coletados ${tokens.length} tokens para autorização múltipla`);
        return tokens;
      }
      
      // Função para sincronizar seletores de conta em todos os locais da interface
      function syncAccountSelectors() {
        if (ws && ws.readyState === WebSocket.OPEN) {
          console.log('Sincronizando seletores de conta...');
          
          // Verificar limite de taxa para sincronização de contas
          if (!Genius.RateLimiter.canSend('account_list')) {
            console.log('Limite de taxa atingido para sincronização de contas, agendando nova tentativa');
            return Genius.RateLimiter.scheduleRequest('account_list', function() {
              syncAccountSelectors();
            }, 100); // Reduzir tempo de espera para 100ms
          }
          
          // Registrar que estamos enviando uma requisição de lista de contas
          Genius.RateLimiter.recordRequest('account_list');
          
          // Solicitar lista de contas atualizada
          const accountListRequest = {
            account_list: 1,
            req_id: Math.floor(Math.random() * 10000)
          };
          
          // Usar nossa função de envio com limitação de taxa
          Genius.sendWSRequest(ws, accountListRequest, 'account_list');
        } else {
          console.log('WebSocket não está conectado. Não é possível sincronizar contas.');
        }
      }
      
      // Funções para subscrição de ticks
      let tickSubscriptionId = null;
      
      function subscribeToTicks() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.log('WebSocket não está aberto. Não é possível assinar ticks.');
          return;
        }
        
        // Verificar limite de taxa para assinatura de ticks
        if (!Genius.RateLimiter.canSend('ticks_subscribe')) {
          console.log('Limite de taxa atingido para assinatura de ticks, agendando nova tentativa');
          return Genius.RateLimiter.scheduleRequest('ticks_subscribe', function() {
            subscribeToTicks();
          }, 100); // Reduzir tempo de espera para 100ms
        }
        
        // Solicitar histórico de preços para R_100
        requestTicksHistory();
        
        // Registrar que estamos enviando uma requisição de assinatura de ticks
        Genius.RateLimiter.recordRequest('ticks_subscribe');
        
        // Solicitar ticks em tempo real para R_100
        const ticksRequest = {
          ticks: "R_100",
          subscribe: 1,
          req_id: Math.floor(Math.random() * 10000)
        };
        
        // Usar nossa função de envio com limitação de taxa
        Genius.sendWSRequest(ws, ticksRequest, 'ticks_subscribe');
        console.log('Assinando ticks para R_100');
      }
      
      function unsubscribeFromTicks() {
        if (!ws || ws.readyState !== WebSocket.OPEN || !tickSubscriptionId) {
          console.log('WebSocket não está aberto ou não há ID de assinatura. Não é possível cancelar assinatura.');
          return;
        }
        
        // Verificar limite de taxa para cancelamento de assinatura
        if (!Genius.RateLimiter.canSend('forget_ticks')) {
          console.log('Limite de taxa atingido para cancelamento de assinatura, agendando nova tentativa');
          return Genius.RateLimiter.scheduleRequest('forget_ticks', function() {
            unsubscribeFromTicks();
          }, 100); // Reduzir tempo de espera para 100ms
        }
        
        // Registrar que estamos enviando uma requisição de cancelamento de assinatura
        Genius.RateLimiter.recordRequest('forget_ticks');
        
        const request = {
          forget: tickSubscriptionId,
          req_id: Math.floor(Math.random() * 10000)
        };
        
        // Usar nossa função de envio com limitação de taxa
        Genius.sendWSRequest(ws, request, 'forget_ticks');
        console.log('Cancelando assinatura de ticks para ID:', tickSubscriptionId);
        
        // Limpar ID de assinatura
        tickSubscriptionId = null;
      }
      
      function requestTicksHistory() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          console.log('WebSocket não está aberto. Não é possível solicitar histórico de ticks.');
          return;
        }
        
        // Verificar limite de taxa para solicitação de histórico
        if (!Genius.RateLimiter.canSend('ticks_history')) {
          console.log('Limite de taxa atingido para histórico de ticks, agendando nova tentativa');
          return Genius.RateLimiter.scheduleRequest('ticks_history', function() {
            requestTicksHistory();
          }, 100); // Reduzir tempo de espera para 100ms
        }
        
        // Registrar que estamos enviando uma requisição de histórico
        Genius.RateLimiter.recordRequest('ticks_history');
        
        const historyRequest = {
          ticks_history: "R_100",
          adjust_start_time: 1,
          count: 500,
          end: "latest",
          start: 1,
          style: "ticks",
          req_id: Math.floor(Math.random() * 10000)
        };
        
        // Usar nossa função de envio com limitação de taxa
        Genius.sendWSRequest(ws, historyRequest, 'ticks_history');
        console.log('Solicitando histórico de ticks para R_100');
      }
      
      // Configuração dos gráficos
      let rsiChart, volatilityChart;
      
      function initCharts() {
        const rsiCtx = document.getElementById('rsiChart').getContext('2d');
        const volatilityCtx = document.getElementById('volatilityChart').getContext('2d');
        
        // Cores para os gráficos
        const chartColors = {
          grid: 'rgba(255, 255, 255, 0.1)',
          text: 'rgba(255, 255, 255, 0.7)',
          rsi: 'rgba(0, 229, 179, 1)',
          rsiBackground: 'rgba(0, 229, 179, 0.1)',
          volatility: 'rgba(255, 107, 107, 1)',
          volatilityBackground: 'rgba(255, 107, 107, 0.1)'
        };
        
        // Configuração comum para os gráficos
        const commonConfig = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: true,
              labels: {
                color: chartColors.text
              }
            },
            tooltip: {
              enabled: true
            }
          },
          scales: {
            x: {
              grid: {
                color: chartColors.grid
              },
              ticks: {
                color: chartColors.text
              }
            },
            y: {
              grid: {
                color: chartColors.grid
              },
              ticks: {
                color: chartColors.text
              }
            }
          }
        };
        
        // Dados iniciais para o gráfico RSI
        const rsiData = {
          labels: Array(30).fill('').map((_, i) => i + 1),
          datasets: [{
            label: 'RSI',
            data: Array(30).fill(null),
            borderColor: chartColors.rsi,
            backgroundColor: chartColors.rsiBackground,
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }]
        };
        
        // Configuração específica para o gráfico RSI
        const rsiConfig = {
          type: 'line',
          data: rsiData,
          options: {
            ...commonConfig,
            scales: {
              ...commonConfig.scales,
              y: {
                ...commonConfig.scales.y,
                min: 0,
                max: 100,
                grid: {
                  color: function(context) {
                    if (context.tick && (context.tick.value === 30 || context.tick.value === 70)) {
                      return 'rgba(255, 99, 132, 0.2)';
                    }
                    return chartColors.grid;
                  }
                }
              }
            },
            plugins: {
              ...commonConfig.plugins,
              legend: {
                ...commonConfig.plugins.legend,
                display: false
              }
            }
          }
        };
        
        // Dados iniciais para o gráfico de volatilidade
        const volatilityData = {
          labels: Array(30).fill('').map((_, i) => i + 1),
          datasets: [{
            label: 'Volatilidade',
            data: Array(30).fill(null),
            borderColor: chartColors.volatility,
            backgroundColor: chartColors.volatilityBackground,
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }]
        };
        
        // Configuração específica para o gráfico de volatilidade
        const volatilityConfig = {
          type: 'line',
          data: volatilityData,
          options: {
            ...commonConfig,
            plugins: {
              ...commonConfig.plugins,
              legend: {
                ...commonConfig.plugins.legend,
                display: false
              }
            }
          }
        };
        
        // Inicializar os gráficos
        rsiChart = new Chart(rsiCtx, rsiConfig);
        volatilityChart = new Chart(volatilityCtx, volatilityConfig);
      }
      
      // Inicializar gráficos quando o DOM estiver carregado
      initCharts();
      
      // Função para alternar entre gráficos
      const chartToolbarItems = document.querySelectorAll('.chart-toolbar-item');
      const chartContainers = {
        'rsi': document.getElementById('rsi-chart-container'),
        'volatility': document.getElementById('volatility-chart-container')
      };
      
      chartToolbarItems.forEach(item => {
        item.addEventListener('click', function() {
          const chartType = this.getAttribute('data-chart');
          
          // Atualizar classes ativas
          chartToolbarItems.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          // Mostrar gráfico selecionado
          Object.keys(chartContainers).forEach(key => {
            chartContainers[key].style.display = key === chartType ? 'block' : 'none';
          });
        });
      });
      
      // Função para calcular RSI
      function calculateRSI(prices, period = 14) {
        if (prices.length < period + 1) {
          return null;
        }
        
        let gains = 0;
        let losses = 0;
        
        for (let i = 1; i <= period; i++) {
          const change = prices[i] - prices[i - 1];
          if (change >= 0) {
            gains += change;
          } else {
            losses -= change;
          }
        }
        
        let avgGain = gains / period;
        let avgLoss = losses / period;
        
        for (let i = period + 1; i < prices.length; i++) {
          const change = prices[i] - prices[i - 1];
          
          if (change >= 0) {
            avgGain = (avgGain * (period - 1) + change) / period;
            avgLoss = (avgLoss * (period - 1)) / period;
          } else {
            avgGain = (avgGain * (period - 1)) / period;
            avgLoss = (avgLoss * (period - 1) - change) / period;
          }
        }
        
        if (avgLoss === 0) {
          return 100;
        }
        
        const rs = avgGain / avgLoss;
        const rsi = 100 - (100 / (1 + rs));
        
        return rsi;
      }
      
      // Função para calcular volatilidade (desvio padrão)
      function calculateVolatility(prices, period = 14) {
        if (prices.length < period) {
          return null;
        }
        
        // Calcular média
        const slice = prices.slice(-period);
        const mean = slice.reduce((a, b) => a + b, 0) / period;
        
        // Calcular variância
        const variance = slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period;
        
        // Retornar desvio padrão (raiz quadrada da variância)
        return Math.sqrt(variance);
      }
      
      // Função para atualizar gráficos com novos dados
      function updateCharts(tickData) {
        if (!tickData || !tickData.prices || tickData.prices.length === 0) {
          return;
        }
        
        const prices = tickData.prices;
        
        // Calcular RSI
        const rsi = calculateRSI(prices);
        if (rsi !== null) {
          // Atualizar gráfico RSI
          const rsiDataset = rsiChart.data.datasets[0];
          rsiDataset.data.push(rsi);
          
          // Manter apenas os últimos 30 pontos
          if (rsiDataset.data.length > 30) {
            rsiDataset.data.shift();
          }
          
          rsiChart.update();
          
          // Atualizar o valor de RSI atual
          document.getElementById('current-rsi').textContent = rsi.toFixed(2);
          
          // Adicionar classe para colorir o valor de RSI
          const rsiElement = document.getElementById('current-rsi');
          rsiElement.classList.remove('up', 'down');
          
          if (rsi > 70) {
            rsiElement.classList.add('up');
          } else if (rsi < 30) {
            rsiElement.classList.add('down');
          }
        }
        
        // Calcular Volatilidade
        const volatility = calculateVolatility(prices);
        if (volatility !== null) {
          // Atualizar gráfico de volatilidade
          const volatilityDataset = volatilityChart.data.datasets[0];
          volatilityDataset.data.push(volatility);
          
          // Manter apenas os últimos 30 pontos
          if (volatilityDataset.data.length > 30) {
            volatilityDataset.data.shift();
          }
          
          volatilityChart.update();
          
          // Atualizar o valor de volatilidade atual
          document.getElementById('current-volatility').textContent = volatility.toFixed(4);
        }
      }
      
      // Função para inicializar gráfico de barras
      function initBarsChart() {
        const barsContainer = document.querySelector('.bars-container');
        
        // Criar barras para os dígitos 0-9
        for (let i = 0; i < 10; i++) {
          const barItem = document.createElement('div');
          barItem.className = 'bar-item';
          
          const barColumn = document.createElement('div');
          barColumn.className = 'bar-column';
          barColumn.style.height = '0%';
          
          const barPercentage = document.createElement('div');
          barPercentage.className = 'bar-percentage';
          barPercentage.textContent = '0%';
          
          const barDigit = document.createElement('div');
          barDigit.className = 'bar-digit';
          barDigit.textContent = i;
          
          barItem.appendChild(barColumn);
          barItem.appendChild(barPercentage);
          barItem.appendChild(barDigit);
          
          barsContainer.appendChild(barItem);
        }
      }
      
      // Inicializar gráfico de barras
      initBarsChart();
      
      // Estatísticas de dígitos
      const digitCounts = Array(10).fill(0);
      let totalDigits = 0;
      const recentDigits = [];
      const MAX_SEQUENCE_DISPLAY = 20;
      
      // Função para atualizar estatísticas de dígitos
      function updateDigitStats(digit) {
        const numDigit = parseInt(digit, 10);
        
        if (isNaN(numDigit) || numDigit < 0 || numDigit > 9) {
          return;
        }
        
        // Adicionar ao início da sequência
        recentDigits.unshift(numDigit);
        
        // Limitar tamanho da sequência
        if (recentDigits.length > MAX_SEQUENCE_DISPLAY) {
          recentDigits.pop();
        }
        
        // Atualizar sequência na UI
        updateDigitSequence();
        
        // Incrementar contadores
        digitCounts[numDigit]++;
        totalDigits++;
        
        // Atualizar barras
        updateBars();
      }
      
      // Função para atualizar barras
      function updateBars() {
        const barItems = document.querySelectorAll('.bar-item');
        
        barItems.forEach((barItem, index) => {
          const count = digitCounts[index];
          const percentage = totalDigits > 0 ? (count / totalDigits) * 100 : 0;
          
          const barColumn = barItem.querySelector('.bar-column');
          const barPercentage = barItem.querySelector('.bar-percentage');
          
          barColumn.style.height = `${percentage}%`;
          barPercentage.textContent = `${percentage.toFixed(1)}%`;
          
          // Destacar barras mais altas
          if (percentage > 20) {
            barColumn.style.backgroundColor = '#ff3349';
          } else if (percentage > 15) {
            barColumn.style.backgroundColor = '#f39c12';
          } else {
            barColumn.style.backgroundColor = '#00e5b3';
          }
        });
      }
      
      // Função para atualizar sequência de dígitos
      function updateDigitSequence() {
        const sequenceContainer = document.getElementById('digit-sequence');
        
        // Limpar container
        sequenceContainer.innerHTML = '';
        
        // Adicionar itens para cada dígito recente
        recentDigits.forEach(digit => {
          const digitItem = document.createElement('div');
          digitItem.className = 'digit-sequence-item';
          digitItem.textContent = digit;
          
          sequenceContainer.appendChild(digitItem);
        });
      }
      
      // Botão para resetar estatísticas
      resetStatsBtn.addEventListener('click', function() {
        // Resetar contadores
        digitCounts.fill(0);
        totalDigits = 0;
        recentDigits.length = 0;
        
        // Atualizar UI
        updateBars();
        updateDigitSequence();
      });
      
      // Implementar logout usando a função centralizada
      document.querySelector('.user-profile').addEventListener('click', function() {
        fetch('/api/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          if (response.ok) {
            // Desconectar WebSocket se estiver conectado
            if (ws && ws.readyState === WebSocket.OPEN) {
              disconnectWebSocket();
            }
            
            // Usar a função centralizada para logout
            window.authUtils.logout();
            
            // Redirecionar para a página de login
            window.location.href = '/login.html';
          }
        })
        .catch(error => {
          console.error('Erro ao fazer logout:', error);
          
          // Tentar logout local mesmo em caso de erro
          if (ws && ws.readyState === WebSocket.OPEN) {
            disconnectWebSocket();
          }
          window.authUtils.logout();
          window.location.href = '/login.html';
        });
      });
      
      // Funções auxiliares para gerenciamento de contas
      
      // Função auxiliar para obter detalhes da conta
      function getAccountDetails(accountId) {
        try {
          // Tentar obter contas da API
          let apiAccounts = [];
          const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
          if (apiAccountsJson) {
            apiAccounts = JSON.parse(apiAccountsJson);
          }
          
          // Tentar obter contas do OAuth
          let oauthAccounts = [];
          const oauthAccountsJson = localStorage.getItem('deriv_accounts');
          if (oauthAccountsJson) {
            oauthAccounts = JSON.parse(oauthAccountsJson);
          }
          
          // Combinar contas
          const allAccounts = [...apiAccounts, ...oauthAccounts];
          
          // Encontrar a conta pelo ID
          return allAccounts.find(account => account.loginid === accountId);
        } catch (error) {
          console.error('Erro ao obter detalhes da conta:', error);
          return null;
        }
      }
      
      // Função para determinar o método de autenticação
      function getAuthMethod() {
        // Verificar token OAuth diretamente
        const oauthToken = localStorage.getItem('deriv_oauth_token');
        if (oauthToken) {
          console.log('Método de autenticação: OAuth Token detectado');
          return 'OAuth (Deriv Login)';
        }
        
        // Verificar se tem contas OAuth
        const oauthAccountsJson = localStorage.getItem('deriv_accounts');
        if (oauthAccountsJson) {
          try {
            const oauthAccounts = JSON.parse(oauthAccountsJson);
            if (oauthAccounts && oauthAccounts.length > 0) {
              console.log('Método de autenticação: Contas OAuth detectadas');
              return 'OAuth (Deriv Login)';
            }
          } catch(e) {
            console.error('Erro ao processar contas OAuth:', e);
          }
        }
        
        // Verificar token API direto
        const apiToken = localStorage.getItem('deriv_api_token');
        if (apiToken) {
          console.log('Método de autenticação: API Token direto detectado');
          return 'API Token';
        }
        
        // Verificar se tem contas API
        const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
        if (apiAccountsJson) {
          try {
            const apiAccounts = JSON.parse(apiAccountsJson);
            if (apiAccounts && apiAccounts.length > 0) {
              console.log('Método de autenticação: Contas API detectadas');
              return 'API Token';
            }
          } catch(e) {
            console.error('Erro ao processar contas API:', e);
          }
        }
        
        console.log('Método de autenticação: Desconhecido');
        return 'Desconhecido';
      }
    });
    
    // Função para obter saldo diretamente
    async function fetchBalanceDirectly() {
      try {
        console.log('Tentando obter saldo diretamente...');
        
        // Verificar se temos uma conta ativa
        const activeLoginId = localStorage.getItem('deriv_active_loginid');
        if (!activeLoginId) {
          console.error('Não há conta ativa para obter saldo');
          return;
        }
        
        console.log('Obtendo saldo para conta:', activeLoginId);
        
        // Obter o token para esta conta
        const token = getTokenForAccount(activeLoginId);
        if (!token) {
          console.error('Token não encontrado para a conta ativa');
          return;
        }
        
        console.log('Token obtido, tamanho:', token.length);
        
        // Criar um WebSocket temporário especificamente para obter o saldo
        const tempWs = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=71555');
        
        tempWs.onopen = function() {
          console.log('WebSocket temporário conectado para obter saldo');
          
          // Primeiro autorizar
          const authRequest = {
            authorize: token,
            req_id: Date.now()
          };
          
          console.log('Enviando requisição de autorização temporária');
          tempWs.send(JSON.stringify(authRequest));
        };
        
        tempWs.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            console.log('Resposta recebida no WebSocket temporário:', data);
            
            // Se autorizado com sucesso, solicitar saldo
            if (data.authorize) {
              console.log('Autorização bem-sucedida no WebSocket temporário');
              
              const balanceRequest = {
                balance: 1,
                subscribe: 0,
                loginid: activeLoginId,
                req_id: Date.now() + 1
              };
              
              console.log('Enviando requisição de saldo no WebSocket temporário');
              tempWs.send(JSON.stringify(balanceRequest));
            }
            
            // Se recebemos a resposta do saldo
            if (data.balance) {
              console.log('SALDO OBTIDO COM SUCESSO:', data.balance);
              
              // Atualizar o saldo na interface
              const accountSelectorBalance = document.getElementById('account-selector-balance');
              if (accountSelectorBalance) {
                accountSelectorBalance.textContent = `${data.balance.currency} ${parseFloat(data.balance.balance || 0).toFixed(2)}`;
                accountSelectorBalance.style.color = '#00e5b3';
                // Destacar o saldo para indicar que foi atualizado
                setTimeout(() => {
                  accountSelectorBalance.style.color = '';
                }, 3000);
              }
              
              // Atualizar no localStorage
              updateAccountBalanceInStorage(activeLoginId, data.balance);
              
              // Fechar este WebSocket temporário após obter o saldo
              setTimeout(() => {
                tempWs.close();
                console.log('WebSocket temporário fechado após obter saldo');
              }, 1000);
            }
            
            // Verificar erros
            if (data.error) {
              console.error('Erro na requisição de WebSocket temporário:', data.error);
            }
          } catch (error) {
            console.error('Erro ao processar mensagem no WebSocket temporário:', error);
          }
        };
        
        tempWs.onerror = function(error) {
          console.error('Erro no WebSocket temporário:', error);
        };
        
        tempWs.onclose = function() {
          console.log('WebSocket temporário fechado');
        };
      } catch (error) {
        console.error('Erro ao obter saldo diretamente:', error);
      }
    }
    
    // Função para atualizar o saldo no armazenamento local
    function updateAccountBalanceInStorage(accountId, balanceData) {
      try {
        // Atualizar nas contas OAuth
        const oauthAccountsJson = localStorage.getItem('deriv_accounts');
        if (oauthAccountsJson) {
          const oauthAccounts = JSON.parse(oauthAccountsJson);
          const accountIndex = oauthAccounts.findIndex(acc => acc.loginid === accountId);
          if (accountIndex !== -1) {
            oauthAccounts[accountIndex].balance = balanceData.balance;
            oauthAccounts[accountIndex].currency = balanceData.currency;
            localStorage.setItem('deriv_accounts', JSON.stringify(oauthAccounts));
            console.log('Saldo atualizado nas contas OAuth');
          }
        }
        
        // Atualizar nas contas API
        const apiAccountsJson = localStorage.getItem('deriv_accounts_api');
        if (apiAccountsJson) {
          const apiAccounts = JSON.parse(apiAccountsJson);
          const accountIndex = apiAccounts.findIndex(acc => acc.loginid === accountId);
          if (accountIndex !== -1) {
            apiAccounts[accountIndex].balance = balanceData.balance;
            apiAccounts[accountIndex].currency = balanceData.currency;
            localStorage.setItem('deriv_accounts_api', JSON.stringify(apiAccounts));
            console.log('Saldo atualizado nas contas API');
          }
        }
      } catch (error) {
        console.error('Erro ao atualizar saldo no armazenamento:', error);
      }
    }
    
    // Executar após 2 segundos do carregamento da página
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(fetchBalanceDirectly, 2000);
    });
  </script>
</body>
</html>